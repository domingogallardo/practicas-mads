
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../01-intro-spring-boot/comandos-git.html">
      
      
        <link rel="next" href="../03-pruebas-tdd/integration-tdd.html">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.7">
    
    
      
        <title>Práctica 2 - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="Teal" data-md-color-accent="Teal">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#practica-2-aplicacion-todolist" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href=".." title="Prácticas MADS" class="md-header__button md-logo" aria-label="Prácticas MADS" data-md-component="logo">
      
  <img src="../imagenes/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Prácticas MADS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Práctica 2
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo" aria-label="Prácticas MADS" data-md-component="logo">
      
  <img src="../imagenes/logo.png" alt="logo">

    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
      
        <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
          Práctica 1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Práctica 1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-intro-spring-boot/practica1.html" class="md-nav__link">
        Enunciado de la práctica
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-intro-spring-boot/intro-spring-boot.html" class="md-nav__link">
        Introducción a Spring Boot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-intro-spring-boot/comandos-git.html" class="md-nav__link">
        Resumen de comandos Git
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Práctica 2
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="practica2.html" class="md-nav__link md-nav__link--active">
        Práctica 2
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-objetivos" class="md-nav__link">
    1. Objetivos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-aplicacion-inicial" class="md-nav__link">
    2. Aplicación inicial
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-la-aplicacion-todolist" class="md-nav__link">
    3. La aplicación ToDoList
  </a>
  
    <nav class="md-nav" aria-label="3. La aplicación ToDoList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion-de-la-aplicacion" class="md-nav__link">
    Configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gestion-de-persistencia-con-jpa" class="md-nav__link">
    Gestión de persistencia con JPA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dtos-data-transfer-objects" class="md-nav__link">
    DTOs (Data Transfer Objects)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicios" class="md-nav__link">
    Servicios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controllers" class="md-nav__link">
    Controllers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vistas" class="md-nav__link">
    Vistas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pruebas-manuales-y-automaticas" class="md-nav__link">
    Pruebas manuales y automáticas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-metodologia-de-desarrollo" class="md-nav__link">
    4. Metodología de desarrollo
  </a>
  
    <nav class="md-nav" aria-label="4. Metodología de desarrollo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#git" class="md-nav__link">
    Git
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flujo-de-trabajo" class="md-nav__link">
    Flujo de trabajo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-antes-de-empezar-la-practica" class="md-nav__link">
    5. Antes de empezar la práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-desarrollo-de-la-practica" class="md-nav__link">
    6. Desarrollo de la práctica
  </a>
  
    <nav class="md-nav" aria-label="6. Desarrollo de la práctica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#version-101" class="md-nav__link">
    Versión 1.0.1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resto-de-la-practica-version-110" class="md-nav__link">
    Resto de la práctica (versión 1.1.0)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-documentacion-entrega-y-evaluacion" class="md-nav__link">
    7. Documentación, entrega y evaluación
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-pruebas-tdd/integration-tdd.html" class="md-nav__link">
        Práctica 3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-gitflow-despliegue/gitflow-despliegue.html" class="md-nav__link">
        Práctica 4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-iteracion-scrum/iteracion-scrum.html" class="md-nav__link">
        Práctica 5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../06-practica-c4/practica-c4.html" class="md-nav__link">
        Práctica C4
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-objetivos" class="md-nav__link">
    1. Objetivos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-aplicacion-inicial" class="md-nav__link">
    2. Aplicación inicial
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-la-aplicacion-todolist" class="md-nav__link">
    3. La aplicación ToDoList
  </a>
  
    <nav class="md-nav" aria-label="3. La aplicación ToDoList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuracion-de-la-aplicacion" class="md-nav__link">
    Configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gestion-de-persistencia-con-jpa" class="md-nav__link">
    Gestión de persistencia con JPA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dtos-data-transfer-objects" class="md-nav__link">
    DTOs (Data Transfer Objects)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicios" class="md-nav__link">
    Servicios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controllers" class="md-nav__link">
    Controllers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vistas" class="md-nav__link">
    Vistas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pruebas-manuales-y-automaticas" class="md-nav__link">
    Pruebas manuales y automáticas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-metodologia-de-desarrollo" class="md-nav__link">
    4. Metodología de desarrollo
  </a>
  
    <nav class="md-nav" aria-label="4. Metodología de desarrollo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#git" class="md-nav__link">
    Git
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flujo-de-trabajo" class="md-nav__link">
    Flujo de trabajo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-antes-de-empezar-la-practica" class="md-nav__link">
    5. Antes de empezar la práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-desarrollo-de-la-practica" class="md-nav__link">
    6. Desarrollo de la práctica
  </a>
  
    <nav class="md-nav" aria-label="6. Desarrollo de la práctica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#version-101" class="md-nav__link">
    Versión 1.0.1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resto-de-la-practica-version-110" class="md-nav__link">
    Resto de la práctica (versión 1.1.0)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-documentacion-entrega-y-evaluacion" class="md-nav__link">
    7. Documentación, entrega y evaluación
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="practica-2-aplicacion-todolist">Práctica 2: Aplicación ToDoList<a class="headerlink" href="#practica-2-aplicacion-todolist" title="Permanent link">&para;</a></h1>
<h2 id="1-objetivos">1. Objetivos<a class="headerlink" href="#1-objetivos" title="Permanent link">&para;</a></h2>
<p>En práctica 2 vamos a trabajar sobre la aplicación inicial
<a href="https://github.com/domingogallardo/mads-todolist-inicial">domingogallardo/mads-todolist-inicial</a>.</p>
<p>Esta parte tendrá una duración de cuatro semanas. Deberás realizarla de
forma individual, siguiendo las indicaciones que encontrarás en este
documento. Tendrás que desarrollar código y trabajar en GitHub
desarrollando <em>issues</em>, <em>pull requests</em>, <em>releases</em> y actualizando los
tableros del proyecto (en Trello y en GitHub).</p>
<p>Al igual que en la práctica 1 usaremos GitHub Classroom para crear un
repositorio individual con el que realizarás la práctica. El proyecto
base será la aplicación inicial
<a href="https://github.com/domingogallardo/mads-todolist-inicial">domingogallardo/mads-todolist-inicial</a>. En
este repositorio se ha seguido una metodología similar a la que vamos
a utilizar en este práctica y puedes examinarlo para ver distintos
elementos:</p>
<ul>
<li><a href="https://github.com/domingogallardo/mads-todolist-inicial/issues?q=is%3Aissue+is%3Aclosed">Issues cerrados</a></li>
<li><a href="https://github.com/domingogallardo/mads-todolist-inicial/pulls?q=is%3Apr+is%3Aclosed">Pull Requests mezclados</a></li>
<li><a href="https://github.com/domingogallardo/mads-todolist-inicial/projects/1">Tablero de issues</a></li>
<li><a href="https://trello.com/b/5zWOT6uO/todolist-inicial">Tablero Trello de historias de usuario</a></li>
</ul>
<p>Debes leer la <a href="../01-intro-spring-boot/intro-spring-boot.html">introducción a Spring
Boot</a> para entender los
conceptos fundamentales del framework.</p>
<h2 id="2-aplicacion-inicial">2. Aplicación inicial<a class="headerlink" href="#2-aplicacion-inicial" title="Permanent link">&para;</a></h2>
<p>La aplicación con la que vamos a trabajar es una típica aplicación
ToDo que sirve para gestionar tareas pendientes. Se pueden registrar y
logear usuarios y los usuarios registrados pueden añadir, modificar y
borrar tareas pendientes de hacer.</p>
<p>A continuación puedes ver dos de las pantallas de la aplicación.</p>
<table>
<tr>
<td><img src="./imagenes/login.png" width="700px"/></td>
</tr>
<tr>
<td align="center"> Pantalla de login </td>
</table>

<table>
<tr>
<td><img src="./imagenes/tareas.png" width="700px"/></td>
</tr>
<tr>
<td align="center"> Pantalla con listado de tareas </td>
</table>

<p>Iremos desarrollando características adicionales de la aplicación a lo
largo de las prácticas. El nombre de la aplicación es <strong>mads-todolist</strong>.</p>
<h2 id="3-la-aplicacion-todolist">3. La aplicación ToDoList<a class="headerlink" href="#3-la-aplicacion-todolist" title="Permanent link">&para;</a></h2>
<p>La aplicación
<a href="https://github.com/domingogallardo/mads-todolist-inicial">mads-todolist-inicial</a>
es la versión inicial de la aplicación que se va a desarrollar
durante toda la asignatura.</p>
<p>Es una aplicación bastante más compleja que la vista en la
práctica 1. Entre otros, tiene los siguientes elementos:</p>
<ul>
<li>Distintos comandos HTTP: GET, POST, DELETE.</li>
<li>Recogida de datos en formularios HTML y validación de los datos.</li>
<li>Base de datos gestionada con JPA (<em>Java Persisence API</em>), un ORM (<em>Object Relational
  Mapping</em>) implementado por la librería Hibernate. Se utiliza una
  capa de persistencia basada en clases <em>repository</em>.</li>
<li><em>Capa de servicio</em> que proporciona la <strong>lógica de negocio</strong> a los
  controllers.</li>
<li>Las <em>clases controller</em> sólo se encargan de hacer de interfaz de la
  capa de servicio: <ul>
<li>Recoger datos de la petición HTTP,</li>
<li>tratar y validar estas entradas, </li>
<li>llamar a la clase de servicio para que se realice la acción
  requerida, y</li>
<li>convertir la respuesta obtenida de la aplicación en una vista
  que se devuelve como respuesta de la petición.</li>
</ul>
</li>
<li>En las plantillas se incluye <em>Bootstrap</em> y scripts JavaScript.</li>
<li>Las clases de servicio y de <em>repository</em> se obtienen por inyección
  de dependencias.</li>
<li>Gran número de tests que prueban la capa de servicios y la de presentación.</li>
</ul>
<p>Vamos a ver con un poco más de detalle dónde puedes encontrar en el
código todos estos elementos.</p>
<h3 id="configuracion-de-la-aplicacion">Configuración de la aplicación<a class="headerlink" href="#configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>Los distintos parámetros de la aplicación Spring Boot se configuran un
fichero de propiedades. El fichero de propiedades por defecto es
<code>application.properties</code>.</p>
<div class="highlight"><span class="filename">src/main/resources/application.properties</span><pre><span></span><code><span class="na">spring.application.name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">mads-todolist</span>
<span class="na">spring.datasource.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:dev</span>
<span class="na">spring.jpa.properties.hibernate.dialect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">org.hibernate.dialect.H2Dialect</span>
<span class="na">spring.jpa.hibernate.ddl-auto</span><span class="o">=</span><span class="s">update</span>
<span class="na">logging.level.org.hibernate.SQL</span><span class="o">=</span><span class="s">debug</span>
<span class="na">logging.level.madstodolist</span><span class="o">=</span><span class="s">debug</span>
<span class="na">spring.sql.init.mode</span><span class="o">=</span><span class="s">never</span>
<span class="na">spring.h2.console.enabled</span><span class="o">=</span><span class="s">true</span>
<span class="na">spring.h2.console.path</span><span class="o">=</span><span class="s">/h2-console</span>

<span class="c1"># Activamos el perfil dev</span>
<span class="na">spring.profiles.active</span><span class="o">=</span><span class="s">dev</span>

<span class="c1"># Deshabilitamos Open EntityManager in View</span>
<span class="c1"># https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/data.html#data.sql.jpa-and-spring-data.open-entity-manager-in-view</span>
<span class="c1"># Ver tambien https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/orm/hibernate5/support/OpenSessionInViewInterceptor.html</span>
<span class="c1"># y https://www.baeldung.com/spring-open-session-in-view</span>
<span class="na">spring.jpa.open-in-view</span><span class="o">=</span><span class="s">false</span>
</code></pre></div>
<p>Entre otras cosas, se define las características de la fuente de datos
con la que trabaja la aplicación (la base de datos en memoria H2):</p>
<ul>
<li>El parámetro <code>spring.jpa.hibernate.ddl-auto=update</code> hace que
  Hibernate actualice automáticamente los esquemas de la base de
  datos, construyéndolos a partir de las clases <code>Entity</code>. En un
  entorno de producción el valor de esta propiedad deberá ser
  <code>validate</code> para no modificar la base de datos de producción.</li>
<li>El parámetro <code>spring.profiles.active=dev</code> define el perfil que se activa por
  defecto al lanzar la aplicación, el perfil de desarrollo (<code>dev</code>). En prácticas
  posteriores veremos cómo es útil usar distintos perfiles (por ejemplo,
  desarrollo y producción) para configurar qué bases de datos se van a usar.</li>
</ul>
<p>Los datos iniciales de la aplicación se cargan mediante el servicio
<code>InitDbService</code>. Sólo se cargan si el perfil activo es <code>dev</code>.</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/service/InitDbService.java</span><pre><span></span><code><span class="nd">@Service</span>
<span class="c1">// Se ejecuta solo si el perfil activo es &#39;dev&#39;</span>
<span class="nd">@Profile</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InitDbService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UsuarioRepository</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">TareaRepository</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Se ejecuta tras crear el contexto de la aplicación</span>
<span class="w">    </span><span class="c1">// para inicializar la base de datos</span>
<span class="w">    </span><span class="nd">@PostConstruct</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuario</span><span class="p">.</span><span class="na">setNombre</span><span class="p">(</span><span class="s">&quot;Usuario Ejemplo&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuario</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lavar coche&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea1</span><span class="p">);</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Renovar DNI&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Base de datos H2 en memoria en desarrollo</p>
<p>En esta práctica vamos a trabajar únicamente con la base de datos en
memoria. Esto significa que los datos que introduzcamos van a estar
presentes mientras que la aplicación esté funcionando. Cuando matemos
la aplicación y la volvamos a reiniciar sólo estarán los datos
iniciales, los datos que se cargan con el servicio <code>InitDbService</code>.</p>
<p>En la práctica 3 utilizaremos una base de datos real, que deberemos
gestionar también en producción. En concreto, se tratará de una base
de datos PostgresSQL.</p>
</div>
<p>Por último, el parámetro <code>spring.jpa.open-in-view=false</code> deshabilita
una característica de Spring denominada <em>open in view</em> que mantiene
abierta la conexión de la base de datos de forma automática en cada
petición HTTP. Se trata de una característica que facilita el trabajo
con las relaciones <em>lazy</em> entre entidades, pero puede introducir
errores no deseados al permitir acceder a la base de datos en la capa
<em>controller</em>. Al deshabilitar esta característica tendremos que
gestionar manualmente las relaciones <em>lazy</em>, recuperándolas en la capa
de servicio, en donde sí que mantenemos abierta la conexión con la
base de datos. Lo veremos más adelante con más detalle.</p>
<h4 id="otras-configuraciones">Otras configuraciones<a class="headerlink" href="#otras-configuraciones" title="Permanent link">&para;</a></h4>
<p>Es posible definir otras configuraciones e indicar en el comando de
ejecución de la aplicación Spring Boot qué fichero de configuración
usar. Lo veremos en la práctica 3.</p>
<p>En esta práctica se define otra configuración en el directorio de
test, que es la que se carga cuando se lanzan los tests:</p>
<div class="highlight"><span class="filename">src/test/resources/application.properties</span><pre><span></span><code><span class="na">spring.datasource.url</span><span class="o">=</span><span class="s">jdbc:h2:mem:test</span>
<span class="na">spring.jpa.properties.hibernate.dialect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">org.hibernate.dialect.H2Dialect</span>
<span class="na">spring.jpa.hibernate.ddl-auto</span><span class="o">=</span><span class="s">create</span>
<span class="na">logging.level.org.hibernate.SQL</span><span class="o">=</span><span class="s">debug</span>
<span class="na">spring.sql.init.mode</span><span class="o">=</span><span class="s">never</span>

<span class="c1"># obligamos a que Hibernate inicialice los esquemas de datos</span>
<span class="c1"># https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.5-Release-Notes#sql-script-datasource-initialization</span>
<span class="na">spring.jpa.defer-datasource-initialization</span><span class="o">=</span><span class="s">true</span>

<span class="c1"># Deshabilitamos Open EntityManager in View</span>
<span class="c1"># https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/data.html#data.sql.jpa-and-spring-data.open-entity-manager-in-view</span>
<span class="c1"># Ver tambien https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/orm/hibernate5/support/OpenSessionInViewInterceptor.html</span>
<span class="c1"># y https://www.baeldung.com/spring-open-session-in-view</span>
<span class="na">spring.jpa.open-in-view</span><span class="o">=</span><span class="s">false</span>
</code></pre></div>
<p>Una diferencia con el fichero de configuración de desarrollo es el
nombre de la fuente de datos, el modo del
<code>spring.jpa.hibernate.ddl-auto</code>, que es <code>create</code> y el fichero de datos
iniciales que se carga al ejecutar los tests.</p>
<p>La otra diferencia es que no se activa el perfil <code>dev</code>, por lo que no se carga
ningún dato en la aplicación para los tests. Ya veremos más adelante que los
datos para los tests se cargan en los propios tests.</p>
<h3 id="gestion-de-persistencia-con-jpa">Gestión de persistencia con JPA<a class="headerlink" href="#gestion-de-persistencia-con-jpa" title="Permanent link">&para;</a></h3>
<p>Para la gestión de la persistencia de los datos en la aplicación
Spring Boot usaremos <a href="https://docs.spring.io/spring-data/jpa/docs/2.6.x/reference/html/">Spring Data
JPA</a>. Se
trata de un API de Spring Boot que se construye sobre JPA (<em>Java
Persistence API</em>), el ORM (<em>Object Relational Mapping</em>) estándar de
Java. La implementación de JPA que utiliza Spring Boot es <a href="https://docs.jboss.org/hibernate/orm/5.6/userguide/html_single/Hibernate_User_Guide.html">Hibernate</a>.</p>
<p>Spring Data JPA usa todos los conceptos de JPA y añade algunos
adicionales que facilitan aun más su utilización, como es la
definición de interfaces <code>Repository</code> con métodos CRUD estándar para
las entidades.</p>
<h4 id="definicion-del-modelo-de-datos">Definición del modelo de datos<a class="headerlink" href="#definicion-del-modelo-de-datos" title="Permanent link">&para;</a></h4>
<p>El framework JPA permite definir el esquema de la base de datos usando
anotaciones en las clases denominadas de entidad. Para cada clase de
entidad se define una tabla en la base de datos, con columnas que se
mapean con sus atributos.</p>
<p>Por ejemplo, la clase <code>Usuario</code> que se lista a continuación define la
tabla <code>usuarios</code> en la base de datos. Los distintos atributos (<code>login</code>,
<code>email</code>, ...) se corresponden con las columnas de la tabla.</p>
<p>El atributo <code>id</code> se corresponde con la clave primaria de la tabla. JPA
define varias estrategias para obtener esa clave primera, y se ha
escogido la estrategia <code>@GeneratedValue(strategy =
GenerationType.IDENTITY)</code> que define una columna que se autoincrementa
en cada operación de inserción de un nuevo registro en la tabla.</p>
<p>Además de los atributos, en la clase se define un constructor con los
atributos obligatorios para definir un usuario (en nuestro caso el
correo electronico), los <em>getters</em> y <em>setters</em> de todas las
propiedades (necesario para JPA) y los métodos <code>equals</code> y <code>hashCode</code>
para comparar usuarios. </p>
<p>Los métodos <code>equals</code> y <code>hashCode</code> son necesarios para buscar
instancias de la entidad en colecciones y JPA los usa para no incluir
instancias repetidas en los resultados de las queries. El método
<code>equals</code> proporcionado no es el que genera IntelliJ por defecto, sino
que hay que considerar si la instancia ha sido ya vinculada a la base
de datos o no. En el caso en que la instancia ya esté vinculada a la
base de datos, tendrá una clave primaria asignada y ésta será la que
se usará para comparar. En el caso en que la instancia no esté
vinculada (se acaba de crear o la estamos usando para alguna parte de
la lógica de negocio y no se va a persistir) se comparan los atributos
obligatorios (en este caso el correo electrónico).</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/model/Usuario.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.model</span><span class="p">;</span>

<span class="c1">// Imports </span>
<span class="p">...</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;usuarios&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Usuario</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Id</span>
<span class="w">    </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@NotNull</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nombre</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fecha_nacimiento&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Temporal</span><span class="p">(</span><span class="n">TemporalType</span><span class="p">.</span><span class="na">DATE</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">fechaNacimiento</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// La relación es lazy por defecto,</span>
<span class="w">    </span><span class="c1">// es necesario acceder a la lista de tareas para que se carguen</span>
<span class="w">    </span><span class="nd">@OneToMany</span><span class="p">(</span><span class="n">mappedBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;usuario&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Tarea</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Constructor vacío necesario para JPA/Hibernate.</span>
<span class="w">    </span><span class="c1">// No debe usarse desde la aplicación.</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Usuario</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// Constructor público con los atributos obligatorios. En este caso el correo electrónico.</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Usuario</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Getters y setters atributos básicos</span>
<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="c1">// Getters y setters de la relación</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Tarea</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getTareas</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tareas</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Método helper para añadir una tarea a la lista y establecer la relación inversa</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addTarea</span><span class="p">(</span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Si la tarea ya está en la lista, no la añadimos</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tareas</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">tarea</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Añadimos la tarea a la lista</span>
<span class="w">        </span><span class="n">tareas</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Establecemos la relación inversa del usuario en la tarea</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getUsuario</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tarea</span><span class="p">.</span><span class="na">setUsuario</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">equals</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getClass</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">getClass</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Usuario</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// Si tenemos los ID, comparamos por ID</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// si no comparamos por campos obligatorios</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">email</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">email</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Generamos un hash basado en los campos obligatorios</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">hash</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>En la definición de la entidad también se incluyen relaciones con
otras entidades. En este caso un <code>Usuario</code> tiene muchas <code>Tarea</code>s (una
relación una-a-muchos).</p>
<p>La relación uno-a-muchos se representa en la base de datos con una
clave ajena. El atributo <code>mappedBy</code> indica que la clave ajena se va a
guardar en la columna correspondiente con el atributo <code>usuario</code> de la
entidad <code>Tarea</code>.</p>
<p>La definición de <code>Tarea</code> es la siguiente:</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/model/Tarea.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.model</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tareas&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Tarea</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Id</span>
<span class="w">    </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@NotNull</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">titulo</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@NotNull</span>
<span class="w">    </span><span class="c1">// Relación muchos-a-uno entre tareas y usuario</span>
<span class="w">    </span><span class="nd">@ManyToOne</span>
<span class="w">    </span><span class="c1">// Nombre de la columna en la BD que guarda físicamente</span>
<span class="w">    </span><span class="c1">// el ID del usuario con el que está asociado una tarea</span>
<span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;usuario_id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Constructor vacío necesario para JPA/Hibernate.</span>
<span class="w">    </span><span class="c1">// No debe usarse desde la aplicación.</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Tarea</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// Al crear una tarea la asociamos automáticamente a un usuario</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Tarea</span><span class="p">(</span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">titulo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">titulo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">titulo</span><span class="p">;</span>
<span class="w">        </span><span class="n">setUsuario</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span><span class="w"> </span><span class="c1">// Esto añadirá la tarea a la lista de tareas del usuario</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Getters y setters atributos básicos</span>
<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="c1">// Getters y setters de la relación</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Usuario</span><span class="w"> </span><span class="nf">getUsuario</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">usuario</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Método para establecer la relación con el usuario</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUsuario</span><span class="p">(</span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Comprueba si el usuario ya está establecido</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">usuario</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">usuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuario</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Añade la tarea a la lista de tareas del usuario</span>
<span class="w">            </span><span class="n">usuario</span><span class="p">.</span><span class="na">addTarea</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">equals</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">getClass</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="na">getClass</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Tarea</span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">tarea</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// Si tenemos los ID, comparamos por ID</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">tarea</span><span class="p">.</span><span class="na">id</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// si no comparamos por campos obligatorios</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">titulo</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">titulo</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">usuario</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">usuario</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hashCode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Objects</span><span class="p">.</span><span class="na">hash</span><span class="p">(</span><span class="n">titulo</span><span class="p">,</span><span class="w"> </span><span class="n">usuario</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="recuperacion-de-colecciones-lazy">Recuperación de colecciones <em>lazy</em><a class="headerlink" href="#recuperacion-de-colecciones-lazy" title="Permanent link">&para;</a></h4>
<p>Como hemos visto anteriormente, en la aplicación se define la relación
<em>uno-a-muchos</em> entre usuarios y tareas: un usuario tiene muchas
tareas.</p>
<p>Por defecto, todas las relaciones <em>a-muchos</em> en JPA se definen de
tipo <code>LAZY</code>. </p>
<p>La característica de los atributos marcados como <em>lazy</em> en JPA es que
no se traen a memoria cuando se recupera la entidad, sino cuando se
consultan explícitamente accediendo al atributo. Para que se traigan a
memoria debe accederse a la colección de la entidad <strong>estando abierta la
conexión con la base de datos</strong>. Normalmente esto se hace en la capa de servicio
marcando en los métodos en los que se accede a las entidades con la anotación
<code>@Transactional</code>. </p>
<p>Las entidades que usemos en estos métodos estarán conectadas a la base de datos
y podremos recuperar sus relaciones <em>lazy</em>, accediendo a la colección. Si
queremos obtener todos los datos de la relación podemos por ejemplo llamar al
método <code>size()</code> de la misma, o convertirla en un objeto DTO (<code>TareaData</code>) para devolverla al
controller, tal y como se hace en el código de la aplicación:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">allTareasUsuario</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">idUsuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Devolviendo todas las tareas del usuario &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idUsuario</span><span class="p">);</span>
<span class="w">    </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">idUsuario</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TareaServiceException</span><span class="p">(</span><span class="s">&quot;Usuario &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idUsuario</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; no existe al listar tareas &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Hacemos uso de Java Stream API para mapear la lista de entidades a DTOs.</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getTareas</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">tarea</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">tarea</span><span class="p">,</span><span class="w"> </span><span class="n">TareaData</span><span class="p">.</span><span class="na">class</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Ordenamos la lista por id de tarea</span>
<span class="w">    </span><span class="n">Collections</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="n">tareas</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tareas</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Si devolviéramos al controller directamente una entidad que contiene una
colección <em>lazy</em> sin haberla inicializado, cuando se intentar acceder a ella se
produciría un error por estar fuera del método anotado con
<code>@Transactional</code>.</p>
<p>La otra forma de definir una relación es usar el tipo <em>eager</em>, en el que JPA
traerá siempre a memoria todos los elementos cuando se recupere cualquier
entidad. En general, no es conveniente definir una relación como <em>eager</em> porque
puede provocar problemas de rendimiento en el caso en que haya muchos elementos
relacionados. Por ello, por defecto solo se definen como <em>eager</em> las relaciones
uno-a-uno.</p>
<p>En la práctica 3 veremos más ejemplo de trabajo con relaciones <em>lazy</em>.</p>
<h4 id="clases-repository">Clases Repository<a class="headerlink" href="#clases-repository" title="Permanent link">&para;</a></h4>
<p>Spring define la clase genérica <code>CrudRepository</code> que contienen métodos por
defecto para actualizar las entidades y realizar <em>queries</em> sobre
ellas. Para dejar abierta la posibilidad de cambiar la implementación,
se definen con interfaces.</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Serializable</span><span class="o">&gt;</span><span class="w">  </span><span class="kd">extends</span><span class="w"> </span><span class="n">Repository</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">S</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
<span class="w">  </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findById</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="n">primaryKey</span><span class="p">);</span><span class="w"> </span>
<span class="w">  </span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAll</span><span class="p">();</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="nf">count</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
<span class="w">  </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">existsById</span><span class="p">(</span><span class="n">ID</span><span class="w"> </span><span class="n">primaryKey</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// … more functionality omitted.</span>
<span class="p">}</span>
</code></pre></div>
<p>Para usar estos métodos con nuestras entidades basta con definir
interfaces que extienden esta clase genérica. Lo hemos hecho en el package
<code>repository</code>.</p>
<p>Por ejemplo, la interfaz <code>UsuarioRepository</code>:</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/repository/UsuarioRepository.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">madstodolist.model.Usuario</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.CrudRepository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UsuarioRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>En la interfaz se añade un método <code>findByEmail</code> que hace que
Spring construya automáticamente una consulta sobre  la base de datos. Al
usar como nombre del método el nombre de la propiedad de la entidad
(<code>email</code>), Spring puede generar automáticamente la consulta.</p>
<p>Puedes consultar una lista completa de las traducciones de nombres de
métodos a consultas a la base de datos en <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation">este
enlace</a>
de la documentación de Spring Boot.</p>
<p>También es posible definir explícitamente en el Repository la consulta
a realizar a la base de datos utilizando la anotación <code>@Query</code>. Puedes encontrar varios ejemplos en <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.at-query">este enlace</a>.</p>
<p>Una vez definida la interfaz, ya podemos inyectar una instancia de
<em>repository</em> y usarla en las clases de servicio. Por ejemplo,
mostramos el método de servicio que registra un usuario:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UsuarioService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UsuarioRepository</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ModelMapper</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">;</span>

<span class="w">    </span><span class="p">...</span>

<span class="w">    </span><span class="c1">// Se añade un usuario en la aplicación.</span>
<span class="w">    </span><span class="c1">// El email y password del usuario deben ser distinto de null</span>
<span class="w">    </span><span class="c1">// El email no debe estar registrado en la base de datos</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UsuarioData</span><span class="w"> </span><span class="nf">registrar</span><span class="p">(</span><span class="n">UsuarioData</span><span class="w"> </span><span class="n">usuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span><span class="w"> </span><span class="n">usuarioBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findByEmail</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getEmail</span><span class="p">());</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuarioBD</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioServiceException</span><span class="p">(</span><span class="s">&quot;El usuario &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; ya está registrado&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioServiceException</span><span class="p">(</span><span class="s">&quot;El usuario no tiene email&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioServiceException</span><span class="p">(</span><span class="s">&quot;El usuario no tiene password&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuarioNuevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="n">Usuario</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">            </span><span class="n">usuarioNuevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuarioNuevo</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">usuarioNuevo</span><span class="p">,</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>En el cuerpo del método se llama al método <code>findByEmail</code> del
repositorio que realiza una búsqueda en la base de datos y al método
<code>save</code> que actualiza el valor de la entidad.</p>
<p>La anotación <code>@Transactional</code> hace dos cosas. En primer lugar, abre
una conexión con la base de datos y hace que todas las llamadas a las
clases repository se realicen usando esa conexión. Las entidades están
conectadas a la base de datos durante todas las sentencias que se
ejecutan dentro del método anotado y cualquier cambio en ellas se
propaga a la base de datos (en este caso el título de la
tarea). Además, y muy importante, las relaciones <em>lazy</em> pueden
recuperarse sin problemas accediendo a los atributos correspondientes
de las entidades. </p>
<p>En segundo lugar, la anotación <code>@Transactional</code>, como su nombre
indica, hace que las acciones sobre la base de datos se ejecuten de
forma transaccional. Se abre la transacción al del método y se cierra
al final. Si sucede alguna excepción durante su ejecución la
transacción se deshace.</p>
<p>La interfaz <code>TareaRepository</code> es similar.</p>
<h3 id="dtos-data-transfer-objects">DTOs (Data Transfer Objects)<a class="headerlink" href="#dtos-data-transfer-objects" title="Permanent link">&para;</a></h3>
<p>Los Data Transfer Objects (DTOs) son una práctica efectiva para separar la
representación de datos que usa la capa de negocio de la que se expone a través
de la API. En el mundo de Spring, los DTOs resultan especialmente útiles para
manipular y transferir datos entre distintas capas de la aplicación, como de los
repositorios a los servicios o de los servicios a los controladores. </p>
<p>Los DTOs permiten separar la representación de datos utilizada en la capa de
negocio de la que se expone a través de la API. Esto es particularmente útil
cuando tienes una entidad con múltiples campos pero, en ciertas circunstancias,
sólo necesitas un subconjunto de ellos. Usar un DTO en estos casos permite
transferir solo los datos necesarios, lo que hace la operación más eficiente y
segura. </p>
<p>Además, los DTOs proporcionan un desacoplamiento con la base de datos. A
diferencia de las entidades que se obtienen directamente de los repositorios,
los DTOs están desacoplados de la base de datos. Mientras que cualquier cambio
en un objeto de entidad podría propagarse a la base de datos si estás dentro de
un contexto transaccional, los cambios en un DTO no tienen ningún efecto en la
base de datos. Por ello es recomendado que sean este tipo de objetos los
devueltos por los servicios, para que los controllers no puedan realizar
modificaciones en la base de datos.</p>
<p>En nuestra aplicación todas las clases DTO están en el paquete <code>dto</code>:</p>
<ul>
<li><code>LoginData</code></li>
<li><code>RegistroData</code></li>
<li><code>TareaData</code></li>
<li><code>UsuarioData</code></li>
</ul>
<p>Las clases <code>LoginData</code> y <code>RegistroData</code> transportan los datos entre las
plantillas de la vista y el controller. Y las clases <code>TareaData</code> y <code>UsuarioData</code>
se usan para devolver datos del servicio al controller.</p>
<h4 id="modelmapper">ModelMapper<a class="headerlink" href="#modelmapper" title="Permanent link">&para;</a></h4>
<p><code>ModelMapper</code> es una biblioteca de mapeo de objetos en Java que agiliza y
estandariza la conversión entre entidades de base de datos y Data Transfer
Objects (DTOs). Al usarla, puedes evitar el tedio y los posibles errores de
escribir código de mapeo manual. Además, te brinda una gran flexibilidad
mediante diversas estrategias de coincidencia y configuraciones
personalizables. </p>
<p>Por ejemplo, si tienes una clase <code>Estudiante</code> con campos como <code>nombre</code>, <code>edad</code> y
<code>numeroMatricula</code>, y un DTO llamado <code>EstudianteDTO</code> que solo necesita nombre y edad,
podrías encontrarte escribiendo un código manual para asignar cada campo de la
entidad al DTO correspondiente: </p>
<div class="highlight"><pre><span></span><code><span class="n">Estudiante</span><span class="w"> </span><span class="n">estudiante</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Estudiante</span><span class="p">(</span><span class="s">&quot;Ana&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123ABC&quot;</span><span class="p">);</span>
<span class="n">EstudianteDTO</span><span class="w"> </span><span class="n">estudianteDTO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EstudianteDTO</span><span class="p">();</span>
<span class="n">estudianteDTO</span><span class="p">.</span><span class="na">setNombre</span><span class="p">(</span><span class="n">estudiante</span><span class="p">.</span><span class="na">getNombre</span><span class="p">());</span>
<span class="n">estudianteDTO</span><span class="p">.</span><span class="na">setEdad</span><span class="p">(</span><span class="n">estudiante</span><span class="p">.</span><span class="na">getEdad</span><span class="p">());</span>
</code></pre></div>
<p>Con ModelMapper, esta tarea se condensa en unas pocas líneas:</p>
<div class="highlight"><pre><span></span><code><span class="n">ModelMapper</span><span class="w"> </span><span class="n">modelMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelMapper</span><span class="p">();</span>
<span class="n">Estudiante</span><span class="w"> </span><span class="n">estudiante</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Estudiante</span><span class="p">(</span><span class="s">&quot;Ana&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123ABC&quot;</span><span class="p">);</span>
<span class="n">EstudianteDTO</span><span class="w"> </span><span class="n">estudianteDTO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">estudiante</span><span class="p">,</span><span class="w"> </span><span class="n">EstudianteDTO</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div>
<p>El uso de <code>ModelMapper</code> no solo hace que tu código sea más sencillo de escribir y
mantener, sino que también proporciona un enfoque coherente para el mapeo de
objetos en tu aplicación, lo cual es de mucha importancia en proyectos de gran
envergadura.</p>
<p>Para poder trabajar con <code>ModelMapper</code> en la aplicación lo declaramos como una
dependencia en el fichero POM y creamos un <code>Bean</code> de Spring para poder usarlo con
inyección de dependencias:</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/config/ModelMapperConfig.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.config</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ModelMapperConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ModelMapper</span><span class="w"> </span><span class="nf">modelMapper</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ModelMapper</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="ejemplos-de-dtos-en-nuestra-aplicacion">Ejemplos de DTOs en nuestra aplicación<a class="headerlink" href="#ejemplos-de-dtos-en-nuestra-aplicacion" title="Permanent link">&para;</a></h4>
<p>Veamos dos ejemplos de construcción de DTOs como objetos devueltos por métodos
de servicios de nuestra aplicación.</p>
<p>Primer ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">TareaData</span><span class="w"> </span><span class="nf">findById</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Buscando tarea &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tareaId</span><span class="p">);</span>
<span class="w">    </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tarea</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">tarea</span><span class="p">,</span><span class="w"> </span><span class="n">TareaData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>En este primer ejemplo, el método <code>findById</code> se encarga de buscar una tarea
específica en la base de datos utilizando su <code>tareaId</code>. Si la tarea no se
encuentra, devuelve <code>null</code>. En caso contrario, utiliza <code>ModelMapper</code> para convertir
la entidad <code>Tarea</code> a su representación DTO <code>TareaData</code>. </p>
<p>Segundo ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">allTareasUsuario</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">idUsuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">logger</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Devolviendo todas las tareas del usuario &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idUsuario</span><span class="p">);</span>
<span class="w">    </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">idUsuario</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TareaServiceException</span><span class="p">(</span><span class="s">&quot;Usuario &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idUsuario</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; no existe al listar tareas &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Hacemos uso de Java Stream API para mapear la lista de entidades a DTOs.</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getTareas</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">tarea</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">tarea</span><span class="p">,</span><span class="w"> </span><span class="n">TareaData</span><span class="p">.</span><span class="na">class</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// Ordenamos la lista por id de tarea</span>
<span class="w">    </span><span class="n">Collections</span><span class="p">.</span><span class="na">sort</span><span class="p">(</span><span class="n">tareas</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tareas</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>El segundo ejemplo muestra cómo listar todas las tareas de un usuario
específico. Se obtiene el usuario con el método <code>findById</code> y, si no se encuentra,
se lanza una excepción. Si el usuario existe, se hace uso de la Java Stream API
para transformar la lista de tareas del usuario (entidades) en una lista de DTOs
<code>TareaData</code>. Finalmente, la lista se ordena por el id de la tarea. </p>
<h3 id="servicios">Servicios<a class="headerlink" href="#servicios" title="Permanent link">&para;</a></h3>
<p>Aunque ya hemos visto ejemplos de servicios en la sección anterior, vamos a
detallar algo más la utilidad de esta capa. </p>
<p>La capa de servicios es la capa intermedia entre la capa de <em>controllers</em> y la
de <em>repository</em>. Es la capa que implementa toda la lógica de negocio de la
aplicación. En determinados contextos, también utilizamos objetos de
transferencia de datos, o DTOs, para devolver información a los <em>controllers</em> de
manera más eficiente. </p>
<p>La responsabilidad principal de la capa de servicios es crear, obtener o
modificar los objetos entidad necesarios para cada funcionalidad a partir de los
datos que envía la capa <em>controller</em>. Estos objetos entidad se trabajan en
memoria y, cuando es necesario, se hacen persistentes los cambios utilizando la
capa <em>repository</em>. Cuando la funcionalidad lo requiere, los datos se transforman
a DTOs para su retorno al <em>controller</em>, añadiendo un nivel de desacoplamiento y
eficiencia. </p>
<p>La capa de servicios también gestionará errores y lanzará excepciones cuando no
se pueda realizar alguna funcionalidad. Los servicios obtienen instancias de
<em>Repository</em> y de <em>ModelMapper</em> para la conversión entre entidades y DTOs,
cuando sea necesario, mediante la inyección de dependencias. </p>
<p>Como hemos comentado anteriormente, los métodos de la capa de servicios estarán
anotados con <code>@Transactional</code> actualizar correctamente la base de datos y las
conexiones <em>lazy</em> y para garantizar la transaccionalidad.</p>
<p>Por ejemplo, la clase <code>UsuarioService</code> se define como se muestra a
continuación.</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/service/UsuarioService.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.service</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UsuarioService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">Logger</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">UsuarioService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">LoginStatus</span><span class="w"> </span><span class="p">{</span><span class="n">LOGIN_OK</span><span class="p">,</span><span class="w"> </span><span class="n">USER_NOT_FOUND</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR_PASSWORD</span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UsuarioRepository</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">;</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ModelMapper</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LoginStatus</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">eMail</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findByEmail</span><span class="p">(</span><span class="n">eMail</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">usuario</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">LoginStatus</span><span class="p">.</span><span class="na">USER_NOT_FOUND</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">usuario</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getPassword</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">password</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">LoginStatus</span><span class="p">.</span><span class="na">ERROR_PASSWORD</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">LoginStatus</span><span class="p">.</span><span class="na">LOGIN_OK</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Se añade un usuario en la aplicación.</span>
<span class="w">    </span><span class="c1">// El email y password del usuario deben ser distinto de null</span>
<span class="w">    </span><span class="c1">// El email no debe estar registrado en la base de datos</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UsuarioData</span><span class="w"> </span><span class="nf">registrar</span><span class="p">(</span><span class="n">UsuarioData</span><span class="w"> </span><span class="n">usuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span><span class="w"> </span><span class="n">usuarioBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findByEmail</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getEmail</span><span class="p">());</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuarioBD</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioServiceException</span><span class="p">(</span><span class="s">&quot;El usuario &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; ya está registrado&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioServiceException</span><span class="p">(</span><span class="s">&quot;El usuario no tiene email&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioServiceException</span><span class="p">(</span><span class="s">&quot;El usuario no tiene password&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuarioNuevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="n">Usuario</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">            </span><span class="n">usuarioNuevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuarioNuevo</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">usuarioNuevo</span><span class="p">,</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UsuarioData</span><span class="w"> </span><span class="nf">findByEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findByEmail</span><span class="p">(</span><span class="n">email</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UsuarioData</span><span class="w"> </span><span class="nf">findById</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usuario</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">modelMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">src/main/java/madstodolist/service/UsuarioServiceException.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.service</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UsuarioServiceException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RuntimeException</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">UsuarioServiceException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Estudia con detalle esta clase y la otra clase de servicio, <code>TareaService</code>.</p>
<h4 id="ventajas-de-utilizar-una-capa-de-servicios">Ventajas de utilizar una capa de servicios<a class="headerlink" href="#ventajas-de-utilizar-una-capa-de-servicios" title="Permanent link">&para;</a></h4>
<p>Al utilizar clases de servicios, podemos aislar la lógica de negocio de la
aplicación utilizando métodos y objetos Java, sin preocuparnos de cómo obtener
los datos de la interfaz de usuario ni de cómo mostrar los resultados. De esta
manera, si se necesita modificar la interfaz de usuario de la aplicación, o
convertirla en un servicio REST que devuelva JSON en lugar de HTML, solo
tendremos que tocar las clases <em>controller</em>, no las de servicio. </p>
<p>Además, al no tener ninguna dependencia con la interfaz de usuario, estas clases
de servicios también podrán ser fácilmente testeadas. La mayoría de los tests
automáticos los haremos sobre ellas. </p>
<h3 id="controllers">Controllers<a class="headerlink" href="#controllers" title="Permanent link">&para;</a></h3>
<p>Los <em>controllers</em> son el punto de entrada a la lógica de negocio de la
aplicación. Actúan como intermediarios entre las peticiones HTTP del usuario y
la capa de servicios. Su rol es recibir datos de la petición, invocar el
servicio apropiado para procesar la lógica de negocio y, finalmente, devolver la
vista o los datos adecuados. </p>
<p>En esta aplicación, tenemos dos controladores principales:</p>
<ul>
<li><code>LoginController</code>: gestiona el registro y el inicio de sesión de los
  usuarios.</li>
<li><code>TareasController</code>: se encarga de las operaciones CRUD relacionadas con las
  tareas del usuario. </li>
</ul>
<p>Para facilitar la manipulación de los datos del formulario, los <em>controllers</em>
emplean clases auxiliares como <code>LoginData</code> y <code>RegistroData</code>. Estas clases ayudan
a recopilar los datos del usuario en un formato más manejable. </p>
<p><strong>Ejemplo de <code>LoginController</code></strong></p>
<p>El siguiente fragmento de código muestra un ejemplo de cómo se implementa un
controlador en nuestra aplicación: </p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/controller/LoginController.java</span><pre><span></span><code><span class="c1">// Importaciones y anotaciones</span>
<span class="p">...</span>

<span class="nd">@Controller</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoginController</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">UsuarioService</span><span class="w"> </span><span class="n">usuarioService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">ManagerUserSession</span><span class="w"> </span><span class="n">managerUserSession</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">loginForm</span><span class="p">(</span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;loginData&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoginData</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;formLogin&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ... más código para gestionar el inicio de sesión y el registro</span>
<span class="p">}</span>
</code></pre></div>
<p>Y el siguiente código muestra la implementación de la clase <code>LoginData</code> que se
usará para recoger los datos del formulario rellenado por el usuario.</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/dto/LoginData.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.dto</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoginData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">eMail</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">geteMail</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">eMail</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">seteMail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">eMail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">eMail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eMail</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getPassword</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>En este caso, el método <code>loginForm</code> se encarga de manejar las peticiones GET a
la URL <code>/login</code>. Crea una nueva instancia de la clase <code>LoginData</code> y la añade al
modelo, que posteriormente se pasará a la vista para ser completado por el
usuario. </p>
<p>Los controllers suelen interactuar con varios servicios y componentes, como se
muestra en los ejemplos de <code>UsuarioService</code> y <code>ManagerUserSession</code>, que se inyectan
en LoginController.</p>
<p>Las clases auxiliares como <code>LoginData</code> o <code>RegistroData</code> facilitan la validación
y el manejo de datos en el controller. Estos objetos se llenan automáticamente
con los datos del formulario, y permiten que los métodos del controller sean más
limpios y más fáciles de leer. </p>
<h4 id="peticiones-y-rutas">Peticiones y rutas<a class="headerlink" href="#peticiones-y-rutas" title="Permanent link">&para;</a></h4>
<p>Las rutas (<em>endpoints</em>) que se definen en los controllers para realizar las acciones
de la aplicación son:</p>
<p><strong><code>LoginController</code></strong></p>
<ul>
<li><code>GET /login</code>: devuelve el formulario de login</li>
<li><code>POST /login</code>: realiza el login</li>
<li><code>GET /registro</code>: devuelve el formulario de registro</li>
<li><code>POST /registro</code>: realiza el registro</li>
<li><code>GET /logout</code>: realiza la salida del usuario de la aplicación</li>
</ul>
<p><strong><code>TareaController</code></strong></p>
<ul>
<li><code>GET /usuarios/{id}/tareas/nueva</code>: devuelve el formulario para
añadir una tarea al usuario con identificador <code>{id}</code></li>
<li><code>POST /usuarios/{id}/tareas/nueva</code>: añade una tarea nueva a un usuario</li>
<li><code>GET /usuarios/{id}/tareas</code>: devuelve el listado de tareas de un usuario</li>
<li><code>GET /tareas/{id}/editar"</code>: devuelve el formulario para editar una tarea</li>
<li><code>POST /tareas/{id}/editar</code>: añade una tarea modificada </li>
<li><code>DELETE /tareas/{id}</code>: realiza el borrado de una tarea</li>
</ul>
<h3 id="vistas">Vistas<a class="headerlink" href="#vistas" title="Permanent link">&para;</a></h3>
<p>Todas las vistas de la aplicación comparten la misma cabecera y pie de
página. Para centralizar estos elementos se usa la característica de
fragmentos de Thymeleaf. Los fragmentos comunes se definen en el
fichero <code>fragments.html</code>.</p>
<div class="highlight"><span class="filename">src/main/resources/templates/fragments.html</span><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">head</span> <span class="na">th:fragment</span><span class="o">=</span><span class="s">&quot;head (titulo)&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${titulo}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/css/bootstrap.min.css}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:fragment</span><span class="o">=</span><span class="s">&quot;javascript&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/js/jquery.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/js/popper.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/js/bootstrap.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
/html&gt;
</code></pre></div>
<p>Vemos que las vistas usan el framework CSS <em>Bootstrap</em> (en concreto,
la versión <a href="https://getbootstrap.com/docs/4.6/getting-started/introduction/">Bootstrap
4.6</a>)
y varias librerías JavaScript. Ambos se encuentran en el directorio
<code>src/main/resources/static/</code>, el directorio por defecto en el que se
guardan los recursos estáticos de una aplicación Spring Boot.</p>
<p>La vista principal de la aplicación es el listado de tareas que vemos
a continuación.</p>
<div class="highlight"><span class="filename">src/main/resources/templates/listaTareas.html</span><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">head</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments :: head (titulo=&#39;Login&#39;)&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container-fluid&quot;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row mt-3&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;&#39;Listado de tareas de &#39; + ${usuario.nombre}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row mt-3&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table table-striped&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Id<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Tarea<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Acción<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">tr</span> <span class="na">th:each</span><span class="o">=</span><span class="s">&quot;tarea: ${tareas}&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${tarea.id}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${tarea.titulo}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-xs&quot;</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/tareas/{id}/editar(id=${tarea.id})}&quot;</span><span class="p">/&gt;</span>editar<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-danger btn-xs&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span> <span class="na">onmouseover</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;cursor: pointer;&quot;</span>
                           <span class="na">th:onclick</span><span class="o">=</span><span class="s">&quot;&#39;del(\&#39;/tareas/&#39; + ${tarea.id} + &#39;\&#39;)&#39;&quot;</span><span class="p">&gt;</span>borrar<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/usuarios/{id}/tareas/nueva(id=${usuario.id})}&quot;</span><span class="p">&gt;</span> Nueva tarea<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/logout&quot;</span><span class="p">&gt;</span>Salir<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row mt-2&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-success alert-dismissible fade show&quot;</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${!#strings.isEmpty(mensaje)}&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${mensaje}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss</span><span class="o">=</span><span class="s">&quot;alert&quot;</span> <span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;Close&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;</span><span class="ni">&amp;times;</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>


<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments::javascript&quot;</span><span class="p">/&gt;</span>


<span class="cm">&lt;!-- Ejemplo de uso de Ajax para lanzar una petición DELETE y borrar una tarea --&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">del</span><span class="p">(</span><span class="nx">urlBorrar</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">confirm</span><span class="p">(</span><span class="s1">&#39;¿Estás seguro/a de que quieres borrar la tarea?&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">                </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">urlBorrar</span><span class="p">,</span>
<span class="w">                </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">//refresh the page</span>
<span class="w">                    </span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<ul>
<li>La plantilla recibe una lista de tareas, un usuario y un mensaje
(consultar en el controller <code>TareasController</code> cómo se obtienen esos
datos). </li>
<li>Define un script JavaScript en el que se realiza una petición
  <code>DELETE</code> a la URL que se le pasa como parámetro (se utilizará para
  lanzar la acción de borrar una tarea).</li>
<li>Utiliza una instrucción de iteración sobre la lista de tares para
  construir los elementos de la tabla de tareas.</li>
<li>En las acciones de añadir y editar tareas se construyen las URLs a
  las que hacer la petición usando el identificador de la tarea.</li>
</ul>
<h4 id="autenticacion-y-control-de-acceso">Autenticación y control de acceso<a class="headerlink" href="#autenticacion-y-control-de-acceso" title="Permanent link">&para;</a></h4>
<p>En la aplicación se realiza una autenticación y un control de acceso
muy sencillo usando la sesión HTTP (clase <code>HttpSession</code>). Esta sesión
se implementa en Spring Boot con una cookie que se pasa desde el
navegador hasta el servidor en cada petición.</p>
<p>El manejo de la clase <code>HttpSession</code> es muy sencillo: es un diccionario en el que
podemos añadir datos. En el servidor podemos obtener los datos de la
sesión consultando el diccionario.</p>
<p>La implementación de la autenticación y del control de acceso se
realiza con en la clase <code>ManagerUserSesion</code>:</p>
<div class="highlight"><span class="filename">src/main/java/madstodolist/authentication/ManagerUserSesion.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.authentication</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ManagerUserSession</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">session</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Añadimos el id de usuario en la sesión HTTP para hacer</span>
<span class="w">    </span><span class="c1">// una autorización sencilla. En los métodos de controllers</span>
<span class="w">    </span><span class="c1">// comprobamos si el id del usuario logeado coincide con el obtenido</span>
<span class="w">    </span><span class="c1">// desde la URL</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logearUsuario</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">idUsuario</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;idUsuarioLogeado&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">idUsuario</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">usuarioLogeado</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Long</span><span class="p">)</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&quot;idUsuarioLogeado&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="s">&quot;idUsuarioLogeado&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Se implementa como un componente Spring con la anotación
<code>@Component</code>. La referencia a la clase <code>HttpSession</code> se obtiene por
inyección de dependencias con la anotación de spring Boot <code>@Autowired</code>.</p>
<p>La anotación <code>@Component</code> permite inyectar un <code>ManagerUserSession</code> en
los controllers para gestionar allí el usuario que está logeado y
mockearlo en los tests.</p>
<h3 id="pruebas-manuales-y-automaticas">Pruebas manuales y automáticas<a class="headerlink" href="#pruebas-manuales-y-automaticas" title="Permanent link">&para;</a></h3>
<p>Durante el desarrollo de la práctica será necesario realizar <strong>pruebas
manuales</strong> de la aplicación, introducir datos en sus pantallas y
comprobar que los cambios que vamos introduciendo funcionan correctamente.</p>
<p>Para estas pruebas manuales recomendamos utilizar la configuración de
ejecución trabajando sobre una base de datos con valores
iniciales. Estos valores iniciales se cargan en la aplicación al
comenzar.</p>
<p>En los tests automáticos se cargan los datos de prueba al comienzo de
cada test y, usando la anotación <code>@Sql</code>, se limpian las tablas con el
script <code>clean-db.sql</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/clean-db.sql&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">executionPhase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AFTER_TEST_METHOD</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TareaTest</span><span class="w"> </span><span class="p">{</span>
<span class="p">...</span>
</code></pre></div>
<div class="highlight"><span class="filename">src/test/resources/clean-db.sql</span><pre><span></span><code><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tareas</span><span class="p">;</span>
<span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">usuarios</span><span class="p">;</span>
</code></pre></div>
<h4 id="tests-de-las-entidades-y-de-la-capa-repository">Tests de las entidades y de la capa repository<a class="headerlink" href="#tests-de-las-entidades-y-de-la-capa-repository" title="Permanent link">&para;</a></h4>
<p>Se realizan tests automáticos sobre las entidades y repository:</p>
<ul>
<li><code>TareaTest.java</code></li>
<li><code>UsuarioTest.java</code>:</li>
</ul>
<p>Veamos, por ejemplo, el fichero <code>TareaTest.java</code>:</p>
<div class="highlight"><span class="filename">src/test/java/madstodolist/repository/TareaTest.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.repository</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/clean-db.sql&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TareaTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">UsuarioRepository</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">TareaRepository</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// Tests modelo Tarea en memoria, sin la conexión con la BD</span>
<span class="w">    </span><span class="c1">//</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">crearTarea</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario nuevo creado en memoria, sin conexión con la BD,</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;juan.gutierrez@gmail.com&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// se crea una nueva tarea con ese usuario,</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// el título y el usuario de la tarea son los correctos.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getUsuario</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">laListaDeTareasDeUnUsuarioSeActualizaEnMemoriaConUnaNuevaTarea</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario nuevo creado en memoria, sin conexión con la BD,</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;juan.gutierrez@gmail.com&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// se crea una tarea de ese usuario,</span>

<span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Tarea</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getTareas</span><span class="p">();</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// la tarea creada se ha añadido a la lista de tareas del usuario.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getTareas</span><span class="p">()).</span><span class="na">contains</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareas</span><span class="p">).</span><span class="na">contains</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">comprobarIgualdadTareasSinId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Creadas tres tareas sin identificador, y dos de ellas con</span>
<span class="w">        </span><span class="c1">// la misma descripción</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;juan.gutierrez@gmail.com&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Pagar el alquiler&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// son iguales (Equal) las tareas que tienen la misma descripción.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea1</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">tarea2</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea1</span><span class="p">).</span><span class="na">isNotEqualTo</span><span class="p">(</span><span class="n">tarea3</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">comprobarIgualdadTareasConId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Creadas tres tareas con distintas descripciones y dos de ellas</span>
<span class="w">        </span><span class="c1">// con el mismo identificador,</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;juan.gutierrez@gmail.com&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lavar la ropa&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Pagar el alquiler&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tarea1</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
<span class="w">        </span><span class="n">tarea2</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">        </span><span class="n">tarea3</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// son iguales (Equal) las tareas que tienen el mismo identificador.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea1</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">tarea3</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea1</span><span class="p">).</span><span class="na">isNotEqualTo</span><span class="p">(</span><span class="n">tarea2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// Tests TareaRepository.</span>
<span class="w">    </span><span class="c1">// El código que trabaja con repositorios debe</span>
<span class="w">    </span><span class="c1">// estar en un entorno transactional, para que todas las peticiones</span>
<span class="w">    </span><span class="c1">// estén en la misma conexión a la base de datos, las entidades estén</span>
<span class="w">    </span><span class="c1">// conectadas y sea posible acceder a colecciones LAZY.</span>
<span class="w">    </span><span class="c1">//</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">guardarTareaEnBaseDatos</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario en la base de datos.</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// salvamos la tarea en la BD,</span>

<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// se actualiza el id de la tarea,</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getId</span><span class="p">()).</span><span class="na">isNotNull</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// y con ese identificador se recupera de la base de datos la tarea</span>
<span class="w">        </span><span class="c1">// con los valores correctos de las propiedades y la relación con</span>
<span class="w">        </span><span class="c1">// el usuario actualizado también correctamente (la relación entre tarea</span>
<span class="w">        </span><span class="c1">// y usuario es EAGER).</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tareaBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getId</span><span class="p">()).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">());</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">.</span><span class="na">getUsuario</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">salvarTareaEnBaseDatosConUsuarioNoBDLanzaExcepcion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario nuevo que no está en la BD</span>
<span class="w">        </span><span class="c1">// y una tarea asociada a ese usuario,</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;juan.gutierrez@gmail.com&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN // THEN</span>
<span class="w">        </span><span class="c1">// se lanza una excepción al intentar salvar la tarea en la BD</span>

<span class="w">        </span><span class="n">Assertions</span><span class="p">.</span><span class="na">assertThrows</span><span class="p">(</span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unUsuarioTieneUnaListaDeTareas</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario con 2 tareas en la base de datos</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Renovar el DNI&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea1</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea2</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// recuperamos el ususario de la base de datos,</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuarioRecuperado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// su lista de tareas también se recupera, porque se ha</span>
<span class="w">        </span><span class="c1">// definido la relación de usuario y tareas como EAGER.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">usuarioRecuperado</span><span class="p">.</span><span class="na">getTareas</span><span class="p">()).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">añadirUnaTareaAUnUsuarioEnBD</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario en la base de datos</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// Creamos una nueva tarea con el usuario recuperado de la BD</span>
<span class="w">        </span><span class="c1">// y la salvamos,</span>

<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuarioBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuarioBD</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tarea</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// la tarea queda guardada en la BD asociada al usuario</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tareaBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getUsuario</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">usuarioBD</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// y si recuperamos el usuario se obtiene la nueva tarea</span>
<span class="w">        </span><span class="n">usuarioBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">usuarioBD</span><span class="p">.</span><span class="na">getTareas</span><span class="p">()).</span><span class="na">contains</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cambioEnLaEntidadEnTransactionalModificaLaBD</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario y una tarea en la base de datos</span>
<span class="w">        </span><span class="n">Usuario</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tarea</span><span class="p">(</span><span class="n">usuario</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">tarea</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Recuperamos la tarea</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tarea</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span>
<span class="w">        </span><span class="n">tarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// modificamos la descripción de la tarea</span>

<span class="w">        </span><span class="n">tarea</span><span class="p">.</span><span class="na">setTitulo</span><span class="p">(</span><span class="s">&quot;Esto es una prueba&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// la descripción queda actualizada en la BD.</span>

<span class="w">        </span><span class="n">Tarea</span><span class="w"> </span><span class="n">tareaBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">tarea</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Te recomiendo que leas con cuidado los tests y sus comentarios. Son
muy útiles para entender el funcionamiento de la aplicación (en este
caso de las entidades y de la capa <em>repository</em>).</p>
<p>Utilizamos el formato <em>GIVEN, WHEN, THEN</em> para estructurar el test. En
la parte <em>GIVEN</em> se preparan los datos, en la parte <em>WHEN</em> se lanza el
método o métodos que se quieren probar y en la parte <em>THEN</em> se
comprueban los resultados.</p>
<p>Se realizan distintos tipos de tests dentro de la misma clase:</p>
<ul>
<li>Pruebas sobre las entidades por si solas, sin conexión con la
  base de datos. Son lo que se denomina tests del modelo.</li>
<li>Pruebas sobre la capa <em>repository</em>, en las que se comprueban que las
  operaciones de búsqueda y actualización funcionan correctamente
  sobre la base de datos. En muchas de estas pruebas se necesita
  realizar más de una sentencia con la misma conexión a la base de
  datos o acceder a atributos <em>lazy</em>. Para esto es necesario usar la
  anotación <code>@Transactional</code>.</li>
</ul>
<h4 id="tests-de-la-capa-de-servicios">Tests de la capa de servicios<a class="headerlink" href="#tests-de-la-capa-de-servicios" title="Permanent link">&para;</a></h4>
<p>También se realizan tests sobre la capa de servicio: </p>
<ul>
<li><code>TareaServiceTest.java</code></li>
<li><code>UsuarioServiceTest.java</code></li>
</ul>
<p>Estos tests comprueban que los métodos de servicio funcionan
correctamente y modifican la base de datos tal y como se pretende en
cada operación.</p>
<p>Veamos, por ejemplo, el fichero <code>TareaServiceTest.java</code>:</p>
<div class="highlight"><span class="filename">src/test/java/madstodolist/service/TareaServiceTest.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.service</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="c1">// Hemos eliminado todos los @Transactional de los tests</span>
<span class="c1">// y usado un script para limpiar la BD de test después de</span>
<span class="c1">// cada test</span>
<span class="c1">// https://dev.to/henrykeys/don-t-use-transactional-in-tests-40eb</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/clean-db.sql&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TareaServiceTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">UsuarioService</span><span class="w"> </span><span class="n">usuarioService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="n">TareaService</span><span class="w"> </span><span class="n">tareaService</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Método para inicializar los datos de prueba en la BD</span>
<span class="w">    </span><span class="c1">// Devuelve un mapa con los identificadores del usuario y de la primera tarea añadida</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">addUsuarioTareasBD</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">UsuarioData</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">();</span>
<span class="w">        </span><span class="n">usuario</span><span class="p">.</span><span class="na">setEmail</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuario</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Añadimos un usuario a la base de datos</span>
<span class="w">        </span><span class="n">UsuarioData</span><span class="w"> </span><span class="n">usuarioNuevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioService</span><span class="p">.</span><span class="na">registrar</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Y añadimos dos tareas asociadas a ese usuario</span>
<span class="w">        </span><span class="n">TareaData</span><span class="w"> </span><span class="n">tarea1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">nuevaTareaUsuario</span><span class="p">(</span><span class="n">usuarioNuevo</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Lavar coche&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaService</span><span class="p">.</span><span class="na">nuevaTareaUsuario</span><span class="p">(</span><span class="n">usuarioNuevo</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Renovar DNI&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Devolvemos los ids del usuario y de la primera tarea añadida</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">ids</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">usuarioNuevo</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
<span class="w">        </span><span class="n">ids</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tarea1</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testNuevaTareaUsuario</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario en la BD</span>

<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// creamos una nueva tarea asociada al usuario,</span>
<span class="w">        </span><span class="n">TareaData</span><span class="w"> </span><span class="n">nuevaTarea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">nuevaTareaUsuario</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Práctica 1 de MADS&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// al recuperar la lista de tareas del usuario, la nueva tarea</span>
<span class="w">        </span><span class="c1">// está en la lista de tareas del usuario.</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">allTareasUsuario</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareas</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareas</span><span class="p">).</span><span class="na">contains</span><span class="p">(</span><span class="n">nuevaTarea</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testBuscarTarea</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Una tarea en la BD</span>

<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// recuperamos una tarea de la base de datos a partir de su ID,</span>

<span class="w">        </span><span class="n">TareaData</span><span class="w"> </span><span class="n">lavarCoche</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// los datos de la tarea recuperada son correctos.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">lavarCoche</span><span class="p">).</span><span class="na">isNotNull</span><span class="p">();</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">lavarCoche</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Lavar coche&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testModificarTarea</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario y una tarea en la BD</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">();</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// modificamos la tarea correspondiente al identificador,</span>

<span class="w">        </span><span class="n">tareaService</span><span class="p">.</span><span class="na">modificaTarea</span><span class="p">(</span><span class="n">tareaId</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Limpiar los cristales del coche&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// al buscar por el identificador en la base de datos se devuelve la tarea modificada</span>

<span class="w">        </span><span class="n">TareaData</span><span class="w"> </span><span class="n">tareaBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">.</span><span class="na">getTitulo</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Limpiar los cristales del coche&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// y el usuario tiene también esa tarea modificada.</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">allTareasUsuario</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareas</span><span class="p">).</span><span class="na">contains</span><span class="p">(</span><span class="n">tareaBD</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testBorrarTarea</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario y una tarea en la BD</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">();</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN</span>
<span class="w">        </span><span class="c1">// borramos la tarea correspondiente al identificador,</span>

<span class="w">        </span><span class="n">tareaService</span><span class="p">.</span><span class="na">borraTarea</span><span class="p">(</span><span class="n">tareaId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// THEN</span>
<span class="w">        </span><span class="c1">// la tarea ya no está en la base de datos ni en las tareas del usuario.</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaService</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">tareaId</span><span class="p">)).</span><span class="na">isNull</span><span class="p">();</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TareaData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tareas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">allTareasUsuario</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareas</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">asignarEtiquetaATarea</span><span class="p">(){</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">();</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">tareaService</span><span class="p">.</span><span class="na">usuarioContieneTarea</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">,</span><span class="n">tareaId</span><span class="p">)).</span><span class="na">isTrue</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>Para conseguir que los tests sean independientes y evitar que datos
introducidos o modificados en un test afecten a otros tests, limpiamos
las tablas de la base de datos al final de cada test usando la anotación <code>@Sql</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/clean-db.sql&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">executionPhase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AFTER_TEST_METHOD</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TareaServiceTest</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>Los datos de prueba se introducen al principio de cada test.</p>
<h4 id="tests-de-la-capa-controller">Tests de la capa controller<a class="headerlink" href="#tests-de-la-capa-controller" title="Permanent link">&para;</a></h4>
<p>Por último, también realizamos tests sobre los controllers:</p>
<ul>
<li><code>UsuarioWebTest.java</code></li>
<li><code>TareaWebTest.java</code></li>
</ul>
<p>En estos tests se comprueba que el resultado de realizar un <code>GET</code> o un
<code>POST</code> sobre los endpoints correspondientes devuelven un HTML que
contiene alguna cadena que coincide con lo esperado.</p>
<p>Existen dos enfoques a la hora de definir estos tests. </p>
<ul>
<li>Podemos, al igual que hemos hecho en los tests de servicio,
  introducir los datos de prueba al comienzo de cada test.</li>
<li>Podemos <em>mockear</em> los servicios para que devuelvan los datos que nos
  interesan.</li>
</ul>
<p>Utilizamos ambos enfoques para que aprendas a trabajar con los dos. En
la clase <code>TareaWebTest</code> se utilizan los datos de prueba de la base de
datos y en la clase <code>UsuarioWebTest</code> se mockean los servicios.</p>
<p>La utilización de <em>mocks</em> es muy útil también para poder testear los
métodos que tienen un acceso restringido al usuario que hace la
operación. Por ejemplo, la consulta o modificación de una
tarea. Mockeamos el <code>managerUserSession</code> para simular que el usuario
está logeado.</p>
<p>Mostramos a continuación los ficheros de test de controllers.</p>
<p>Para los tests de tareas se añaden datos de prueba a la base de datos y después
se comprueba que los controllers devuelven páginas HTML que contienen los
resultados esperados.</p>
<div class="highlight"><span class="filename">src/test/java/madstodolist/controller/TareaWebTest.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.controller</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/clean-db.sql&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TareaWebTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MockMvc</span><span class="w"> </span><span class="n">mockMvc</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Declaramos los servicios como Autowired</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">TareaService</span><span class="w"> </span><span class="n">tareaService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UsuarioService</span><span class="w"> </span><span class="n">usuarioService</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Moqueamos el managerUserSession para poder moquear el usuario logeado</span>
<span class="w">    </span><span class="nd">@MockBean</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ManagerUserSession</span><span class="w"> </span><span class="n">managerUserSession</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Método para inicializar los datos de prueba en la BD</span>
<span class="w">    </span><span class="c1">// Devuelve un mapa con los identificadores del usuario y de la primera tarea añadida</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">addUsuarioTareasBD</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Añadimos un usuario a la base de datos</span>
<span class="w">        </span><span class="n">UsuarioData</span><span class="w"> </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">();</span>
<span class="w">        </span><span class="n">usuario</span><span class="p">.</span><span class="na">setEmail</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuario</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">usuario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usuarioService</span><span class="p">.</span><span class="na">registrar</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Y añadimos dos tareas asociadas a ese usuario</span>
<span class="w">        </span><span class="n">TareaData</span><span class="w"> </span><span class="n">tarea1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tareaService</span><span class="p">.</span><span class="na">nuevaTareaUsuario</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Lavar coche&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">tareaService</span><span class="p">.</span><span class="na">nuevaTareaUsuario</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Renovar DNI&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Devolvemos los ids del usuario y de la primera tarea añadida</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">ids</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
<span class="w">        </span><span class="n">ids</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tarea1</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ids</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">listaTareas</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario con dos tareas en la BD</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Moqueamos el método usuarioLogeado para que devuelva el usuario 1L,</span>
<span class="w">        </span><span class="c1">// el mismo que se está usando en la petición. De esta forma evitamos</span>
<span class="w">        </span><span class="c1">// que salte la excepción de que el usuario que está haciendo la</span>
<span class="w">        </span><span class="c1">// petición no está logeado.</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">managerUserSession</span><span class="p">.</span><span class="na">usuarioLogeado</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// se realiza la petición GET al listado de tareas del usuario,</span>
<span class="w">        </span><span class="c1">// el HTML devuelto contiene las descripciones de sus tareas.</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">((</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">allOf</span><span class="p">(</span>
<span class="w">                        </span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Lavar coche&quot;</span><span class="p">),</span>
<span class="w">                        </span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Renovar DNI&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="p">))));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getNuevaTareaDevuelveForm</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario con dos tareas en la BD</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Ver el comentario en el primer test</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">managerUserSession</span><span class="p">.</span><span class="na">usuarioLogeado</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// si ejecutamos una petición GET para crear una nueva tarea de un usuario,</span>
<span class="w">        </span><span class="c1">// el HTML resultante contiene un formulario y la ruta con</span>
<span class="w">        </span><span class="c1">// la acción para crear la nueva tarea.</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlPeticion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas/nueva&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;action=\&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas/nueva\&quot;&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">urlPeticion</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">((</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">allOf</span><span class="p">(</span>
<span class="w">                        </span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;form method=\&quot;post\&quot;&quot;</span><span class="p">),</span>
<span class="w">                        </span><span class="n">containsString</span><span class="p">(</span><span class="n">urlAction</span><span class="p">)</span>
<span class="w">                </span><span class="p">))));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postNuevaTareaDevuelveRedirectYAñadeTarea</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario con dos tareas en la BD</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Ver el comentario en el primer test</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">managerUserSession</span><span class="p">.</span><span class="na">usuarioLogeado</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// realizamos la petición POST para añadir una nueva tarea,</span>
<span class="w">        </span><span class="c1">// el estado HTTP que se devuelve es un REDIRECT al listado</span>
<span class="w">        </span><span class="c1">// de tareas.</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas/nueva&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlRedirect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">post</span><span class="p">(</span><span class="n">urlPost</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;titulo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Estudiar examen MADS&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">status</span><span class="p">().</span><span class="na">is3xxRedirection</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">redirectedUrl</span><span class="p">(</span><span class="n">urlRedirect</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// y si después consultamos el listado de tareas con una petición</span>
<span class="w">        </span><span class="c1">// GET el HTML contiene la tarea añadida.</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">urlRedirect</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">((</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Estudiar examen MADS&quot;</span><span class="p">))));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteTareaDevuelveOKyBorraTarea</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario con dos tareas en la BD</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">();</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaLavarCocheId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Ver el comentario en el primer test</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">managerUserSession</span><span class="p">.</span><span class="na">usuarioLogeado</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// realizamos la petición DELETE para borrar una tarea,</span>
<span class="w">        </span><span class="c1">// se devuelve el estado HTTP que se devuelve es OK,</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tareas/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tareaLavarCocheId</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">urlDelete</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">status</span><span class="p">().</span><span class="na">isOk</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// y cuando se pide un listado de tareas del usuario, la tarea borrada ya no aparece.</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlListado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">urlListado</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span>
<span class="w">                        </span><span class="n">allOf</span><span class="p">(</span><span class="n">not</span><span class="p">(</span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Lavar coche&quot;</span><span class="p">)),</span>
<span class="w">                                </span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Renovar DNI&quot;</span><span class="p">))));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">editarTareaActualizaLaTarea</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Un usuario con dos tareas en la BD</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addUsuarioTareasBD</span><span class="p">();</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;usuarioId&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">tareaLavarCocheId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ids</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;tareaId&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Ver el comentario en el primer test</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">managerUserSession</span><span class="p">.</span><span class="na">usuarioLogeado</span><span class="p">()).</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">usuarioId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// realizamos una petición POST al endpoint para editar una tarea</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlEditar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tareas/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tareaLavarCocheId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/editar&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlRedirect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">post</span><span class="p">(</span><span class="n">urlEditar</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;titulo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Limpiar cristales coche&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">status</span><span class="p">().</span><span class="na">is3xxRedirection</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">redirectedUrl</span><span class="p">(</span><span class="n">urlRedirect</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// Y si realizamos un listado de las tareas del usuario</span>
<span class="w">        </span><span class="c1">// ha cambiado el título de la tarea modificada</span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">urlListado</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/usuarios/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usuarioId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/tareas&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">urlListado</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Limpiar cristales coche&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Para los tests de usuarios usamos el enfoque de moquear los servicios con los
datos que queremos que devuelvan (no tocamos la base de datos) y, al igual que
antes, comprobamos que los controllers devuelven las páginas HTML con los datos
correctos.</p>
<div class="highlight"><span class="filename">src/test/java/madstodolist/controller/UsuarioWebTest.java</span><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.controller</span><span class="p">;</span>

<span class="c1">// Imports</span>
<span class="p">...</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="c1">//</span>
<span class="c1">// A diferencia de los tests web de tarea, donde usábamos los datos</span>
<span class="c1">// de prueba de la base de datos, aquí vamos a practicar otro enfoque:</span>
<span class="c1">// moquear el usuarioService.</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UsuarioWebTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MockMvc</span><span class="w"> </span><span class="n">mockMvc</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Moqueamos el usuarioService.</span>
<span class="w">    </span><span class="c1">// En los tests deberemos proporcionar el valor devuelto por las llamadas</span>
<span class="w">    </span><span class="c1">// a los métodos de usuarioService que se van a ejecutar cuando se realicen</span>
<span class="w">    </span><span class="c1">// las peticiones a los endpoint.</span>
<span class="w">    </span><span class="nd">@MockBean</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UsuarioService</span><span class="w"> </span><span class="n">usuarioService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">servicioLoginUsuarioOK</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Moqueamos la llamada a usuarioService.login para que</span>
<span class="w">        </span><span class="c1">// devuelva un LOGIN_OK y la llamada a usuarioServicie.findByEmail</span>
<span class="w">        </span><span class="c1">// para que devuelva un usuario determinado.</span>

<span class="w">        </span><span class="n">UsuarioData</span><span class="w"> </span><span class="n">anaGarcia</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsuarioData</span><span class="p">();</span>
<span class="w">        </span><span class="n">anaGarcia</span><span class="p">.</span><span class="na">setNombre</span><span class="p">(</span><span class="s">&quot;Ana García&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">anaGarcia</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">usuarioService</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;12345678&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">UsuarioService</span><span class="p">.</span><span class="na">LoginStatus</span><span class="p">.</span><span class="na">LOGIN_OK</span><span class="p">);</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">usuarioService</span><span class="p">.</span><span class="na">findByEmail</span><span class="p">(</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">anaGarcia</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// Realizamos una petición POST al login pasando los datos</span>
<span class="w">        </span><span class="c1">// esperados en el mock, la petición devolverá una redirección a la</span>
<span class="w">        </span><span class="c1">// URL con las tareas del usuario</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;eMail&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;12345678&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">status</span><span class="p">().</span><span class="na">is3xxRedirection</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">redirectedUrl</span><span class="p">(</span><span class="s">&quot;/usuarios/1/tareas&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">servicioLoginUsuarioNotFound</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Moqueamos el método usuarioService.login para que devuelva</span>
<span class="w">        </span><span class="c1">// USER_NOT_FOUND</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">usuarioService</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="s">&quot;pepito.perez@gmail.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;12345678&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">UsuarioService</span><span class="p">.</span><span class="na">LoginStatus</span><span class="p">.</span><span class="na">USER_NOT_FOUND</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// Realizamos una petición POST con los datos del usuario mockeado y</span>
<span class="w">        </span><span class="c1">// se debe devolver una página que contenga el mensaja &quot;No existe usuario&quot;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;eMail&quot;</span><span class="p">,</span><span class="s">&quot;pepito.perez@gmail.com&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="s">&quot;12345678&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;No existe usuario&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">servicioLoginUsuarioErrorPassword</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// GIVEN</span>
<span class="w">        </span><span class="c1">// Moqueamos el método usuarioService.login para que devuelva</span>
<span class="w">        </span><span class="c1">// ERROR_PASSWORD</span>
<span class="w">        </span><span class="n">when</span><span class="p">(</span><span class="n">usuarioService</span><span class="p">.</span><span class="na">login</span><span class="p">(</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;000&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">thenReturn</span><span class="p">(</span><span class="n">UsuarioService</span><span class="p">.</span><span class="na">LoginStatus</span><span class="p">.</span><span class="na">ERROR_PASSWORD</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// WHEN, THEN</span>
<span class="w">        </span><span class="c1">// Realizamos una petición POST con los datos del usuario mockeado y</span>
<span class="w">        </span><span class="c1">// se debe devolver una página que contenga el mensaja &quot;Contraseña incorrecta&quot;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;eMail&quot;</span><span class="p">,</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="s">&quot;000&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;Contraseña incorrecta&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="4-metodologia-de-desarrollo">4. Metodología de desarrollo<a class="headerlink" href="#4-metodologia-de-desarrollo" title="Permanent link">&para;</a></h2>
<p>En cuanto a la metodología de desarrollo, en esta práctica
repasaremos e introduciremos el uso de:</p>
<ul>
<li><a href="https://git-scm.com">Git</a> como sistema de control de versiones que nos permitirá
  registrar paso a paso los cambios realizados en el desarrollo,
  realizando e integrando ramas de <em>features</em> en las que
  desarrollaremos pequeños incrementos que añadirán poco a poco las
  funcionalidades necesarias en la aplicación.</li>
<li><a href="https://github.com">GitHub</a> como servicio en el que publicaremos los cambios e
  integraremos las ramas usando pull requests (PRs). Utilizaremos un
  gran número de características de GitHub para realizar el
  seguimiento del desarrollo del proyecto: issues, labels,
  milestones, etc.</li>
<li>JUnit y las <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-testing.html">características de testing de Spring
  Boot</a>
  para realizar continuamente pruebas unitarias que
  validen el desarrollo.</li>
</ul>
<p>El objetivo es desarrollar software de una forma similar a cómo se
hace en cientos de proyectos punteros de desarrollo <em>open
source</em>. </p>
<p>Existen muchos proyectos que tienen un desarrollo abierto,
transparente, en GitHub. Podemos aprender de sus metodologías
estudiándolos. A continuación listamos ejemplos de repositorios en
GitHub interesantes, en los que podemos estudiar los procesos de <em>pull
requests</em>, issues, tableros, etc. y las dinámicas de comunicación
que utilizan.</p>
<ul>
<li><a href="https://github.com/CartoDB/cartodb">CartoDB</a>. Software español para
  representación visual de datos geográficos.</li>
<li><a href="https://github.com/vapor/vapor">Vapor</a>. Framework web en Swift.</li>
<li><a href="https://github.com/google/guice">Guice</a>. Framework de inyección de
  dependencias en Java.</li>
<li><a href="https://github.com/apple/swift-nio">swift-nio</a>. Framework asíncrono
  de entrada-salida en Swift. </li>
<li><a href="https://github.com/spring-projects/spring-boot">Spring
  Boot</a>. Framework web
  en Java.</li>
</ul>
<h3 id="git">Git<a class="headerlink" href="#git" title="Permanent link">&para;</a></h3>
<p>Git es el sistema de control de versiones más utilizado en la
actualidad. Es muy flexible, distribuido, adaptable a múltiples flujos
de trabajo e ideal para una metodología de desarrollo en
equipo. Suponemos que ya tienes cierta experiencia con su uso. Puedes
usar los siguientes enlaces para repasar su funcionamiento.</p>
<ul>
<li><a href="../01-intro-spring-boot/comandos-git.html">Resumen de comandos de Git</a>: Resumen de comandos
  principales para empezar a trabajar con Git.</li>
<li><a href="https://www.atlassian.com/git/tutorials/">Atlassian Git Tutorials</a>:
  Tutoriales muy orientados al uso de Git con gran cantidad de
  ejemplos. Es recomendable repasar los tutoriales básicos <a href="https://www.atlassian.com/git/tutorials/setting-up-a-repository">Getting
  Started</a>
  y los tutoriales
  <a href="https://www.atlassian.com/git/tutorials/syncing">Syncing</a> y <a href="https://www.atlassian.com/git/tutorials/using-branches">Using
  Branches</a> en
  el apartado <em>Collaborating</em>.</li>
<li><a href="https://git-scm.com/book/en/v2">Libro de Scott Chacon</a>: Completo
  manual con todos los detalles de todos los comandos de Git.</li>
</ul>
<p>Cuando utilicemos git es muy importante realizar unos mensajes de
<em>commit</em> claros. Un mensaje de <em>commit</em> es la forma de comunicar a los
compañeros del equipo qué cambios se han introducido en la aplicación
y ponerlos en contexto (explicar por qué se han hecho, dar algún
detalle de implementación, etc.). El post
<a href="http://chris.beams.io/posts/git-commit/">How to Write a Git Commit Message</a>
explica muy bien esto.</p>
<h3 id="flujo-de-trabajo">Flujo de trabajo<a class="headerlink" href="#flujo-de-trabajo" title="Permanent link">&para;</a></h3>
<p>Desarrollaremos la aplicación de forma iterativa, utilizando
inicialmente un flujo de trabajo Git denominado <em>feature branch</em>
(consultar la
<a href="https://guides.github.com/introduction/flow/">guía de GitHub</a>) en el
que cada característica nueva se implementa en una rama separada que
después se mezcla con la rama principal de desarrollo. Más adelante
veremos otros flujos de trabajo. Puedes ver una introducción a
distintos flujos de trabajo básicos con Git en este
<a href="https://www.atlassian.com/git/tutorials/comparing-workflows">documento de Atlassian</a>.</p>
<p>Para implementar este flujo de trabajo utilizaremos los siguientes
instrumentos de GitHub que facilitan la comunicación entre los
miembros del equipo:</p>
<ul>
<li>
<p><strong>Issues</strong> (<em>incidencias</em>): GitHub permite abrir issues
  (incidencias o tareas), asignarlos a personas, realizar comentarios,
  asignar etiquetas y cerrarlos cuando la implementación ha
  terminado. Consultar
  <a href="https://guides.github.com/features/issues/">Mastering Issues</a>.</p>
<p><img src="./imagenes/github-issues.png" width="500px"/></p>
<p>Definiremos distintos tipos de issues en función de su
propósito: <em>bug</em>, <em>technical</em>, <em>enhancement</em>. Los issues que
implementan una historia de usuario los etiquetaremos con el
código de la historia de usuario. Puede haber más de un issue
asociado con una historia de usuario y de esta forma podemos
agruparlos.</p>
<p><img src="./imagenes/labels-issues.png" width="400px"/></p>
<p>Cada issue se desarrollará en una rama de Git y se integrará en la
rama <em>main</em> haciendo un pull request.</p>
</li>
<li>
<p><strong>Pull Requests</strong>: Un pull request permite avisar al equipo de que
  se va a integrar en la rama principal una rama con un desarrollo
  nuevo. Cuando creamos un PR, GitHub crea una página en la que se
  pueden realizar comentarios, revisiones de código o definir
  políticas de aceptación del PR. Consultar
  <a href="https://help.github.com/articles/about-pull-requests/">About pull requests</a>.</p>
<p>Implementaremos cada issue en una rama separada de git y la
integraremos en la rama <code>main</code> haciendo un <em>pull
request</em>. Cuando se mezcle el PR en <code>main</code> el issue se
cerrará.</p>
<p><img src="./imagenes/github-pr.png" width="700px"/></p>
<p>Más adelante añadiremos otra rama de largo recorrido <code>releases</code> para
incluir en ella las releases del proyecto.</p>
</li>
<li>
<p><strong>Milestones</strong> y <strong>Releases</strong>: Etiquetaremos cada issue con el
  <em>milestone</em> en el que queremos que se lance. Para identificar el
  milestone usaremos el <a href="https://semver.org">versionado semántico</a>:
  MAJOR.MINOR.PATCH. </p>
<p><img src="./imagenes/github-milestones.png" width="600px"/></p>
<p>Usaremos la funcionalidad de GitHub <em>Releases</em> para etiquetar los
commits en los que queramos marcar una versión nueva del
proyecto. Podemos añadir información sobre las novedades de la
versión (normalmente serán enlaces a los issues ese milestone).</p>
<p><img src="./imagenes/github-releases.png" width="600px"/></p>
</li>
<li>
<p><strong>Tablero de proyecto</strong>: Un tablero de proyecto en GitHub nos
  ayudará a hacer un seguimiento de en qué estado se encuentra cada
  issue: cuáles han sido implementados, cuáles faltan por asignar,
  implementar, probar, etc. Vamos a utilizar la funcionalidad propia
  de GitHub llamada <em>Projects</em>. Consultar <a href="https://docs.github.com/en/issues/planning-and-tracking-with-projects/learning-about-projects/quickstart-for-projects">Quickstart for Projects</a></p>
<p><img src="./imagenes/github-tablero.png" width="700px"/></p>
<p>Cuando se crea un pull request que resuelve un issue enlazaremos
el issue con el pull request. Podremos ver en el tablero que bajo
el issue aparece su PR enlazado y podremos desplegarlo en la
propia tarjeta (funcionalidad nueva de GitHub).</p>
<p><img src="./imagenes/pr-enlazado.png" width="500px"/></p>
</li>
</ul>
<p>También utilizaremos un panel de <a href="https://trello.com/">Trello</a> para representar las
historias de usuario que se van implementando en el proyecto. </p>
<p><img src="./imagenes/historias-usuario-trello.png" width="600px"/></p>
<p>Cada historia de usuario tendrá un código numérico y podrá
implementarse con uno o más issues. En GitHub crearemos una etiqueta
por cada historia de usuario y se la asignaremos a los issues que se
usen para implementarla.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Puede parecer redundante el uso de dos tableros, uno para las
historias de usuario y otro para los issues y <em>PR</em>. La
justificación es que los objetivos de ambos tableros son distintos
(y los contenidos también). El
tablero Trello es un <strong>tablero de funcionalidades de usuario</strong>, que
es gestionado por el <em>product owner</em>, usado por el equipo de
desarrollo y puede ser compartido también con clientes y
gerencia. En la terminología de Scrum será el <em>product
backlog</em>. Mientras que el tablero de GitHub será un <strong>tablero
técnico</strong> gestionado por el equipo de desarrollo. En terminología
de Scrum será el <em>sprint backlog</em>. </p>
</div>
<p>La documentación en Trello y en GitHub (en los issues, en los PRs y
en el propio <code>README.md</code> del proyecto) hay que escribirla en
<strong>Markdown</strong>, un lenguaje de marcado muy popular y sencillo de
dominar. Si no has trabajado todavía con él puedes leer estas <a href="https://help.github.com/categories/writing-on-github/">guías
de GitHub</a>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Existen herramientas y servicios más avanzados para gestionar
todos estos elementos del desarrollo. Por ejemplo
<a href="https://www.atlassian.com/software/jira">Jira</a>,
<a href="https://www.jetbrains.com/youtrack/">YouTrack</a> o
<a href="https://www.atlassian.com/software/confluence">Confluence</a>. Pero
la combinación de GitHub + Trello es suficiente para lo que vamos a
realizar en la asignatura y para aprender los objetivos y el
funcionamiento de estos tipos de sistemas basados en incidencias.</p>
</div>
<h2 id="5-antes-de-empezar-la-practica">5. Antes de empezar la práctica<a class="headerlink" href="#5-antes-de-empezar-la-practica" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Una vez logeado en GitHub, copia el enlace con una invitación que
   compartiremos en el foro de Moodle. Con esa invitación se creará
   automáticamente tu repositorio <code>mads-todolist-&lt;usuario&gt;</code> en la
   organización <a href="https://github.com/mads-ua-23-24">mads-ua</a>. Al igual
   que el repositorio de la primera parte de la práctica es un
   repositorio privado al que tienes acceso tú y el profesor. Contiene
   el código inicial de un proyecto base (es una copia del repositorio
   <a href="https://github.com/domingogallardo/mads-todolist-inicial">domingogallardo/mads-todolist-inicial</a>)
   en la que se han comprimido todos los commits en uno.</p>
<p>Es importante que tengas en cuenta que el repositorio recién
creado no reside en tu cuenta, sino en la organización
<code>mads-ua-23-24</code>. Puedes acceder a él desde el <em>dashboard</em> de GitHub que
aparece cuando te logeas.</p>
</li>
<li>
<p>Descarga el proyecto y comprueba que se compila y ejecuta
   correctamente:</p>
<div class="highlight"><pre><span></span><code>$ git clone https://github.com/mads-ua/mads-todolist-&lt;usuario&gt;.git
$ cd mads-todolist-&lt;usuario&gt;
$ ./mvnw spring-boot:run
</code></pre></div>
<p>Comprueba que la aplicación está funcionando en
<a href="http://localhost:8080/login">http://localhost:8080/login</a> en la máquina host.</p>
<p><img src="./imagenes/login.png" width="600px"/></p>
<p>Para la aplicación haciendo CTR+C en el terminal.</p>
</li>
<li>
<p>Importa el proyecto en IntelliJ para trabajar, ejecutar los tests y
   lanzar la aplicación desde este entorno.</p>
</li>
<li>
<p>Es posible examinar el esquema de la base de datos y los datos
   accediendo a la base de datos H2 en memoria añadiendo las
   siguientes preferencias:</p>
<div class="highlight"><pre><span></span><code><span class="n">spring</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">console</span><span class="p">.</span><span class="na">enabled</span><span class="o">=</span><span class="kc">true</span>
<span class="n">spring</span><span class="p">.</span><span class="na">h2</span><span class="p">.</span><span class="na">console</span><span class="p">.</span><span class="na">path</span><span class="o">=/</span><span class="n">h2</span><span class="o">-</span><span class="n">console</span>
</code></pre></div>
<p>Una vez lanzada la aplicación, podemos acceder a
<a href="http://localhost:8080/h2-console">http://localhost:8080/h2-console</a> introduciendo como <code>JDBC URL</code>
la dirección de la fuente de datos <code>jdbc:h2:mem:dev</code> y como
<code>User name</code> la cadena <code>sa</code></p>
<p><img src="./imagenes/h2-console-login.png" width="400px"/></p>
<p>Y examinar tablas en concreto:</p>
<p><img src="./imagenes/h2-console-tablas.png" width="600px"/></p>
</li>
</ol>
<h2 id="6-desarrollo-de-la-practica">6. Desarrollo de la práctica<a class="headerlink" href="#6-desarrollo-de-la-practica" title="Permanent link">&para;</a></h2>
<p>En esta primera práctica vamos a desarrollar las siguientes historias de usuario o features:</p>
<ol>
<li>Página <em>Acerca de</em></li>
<li>Barra de menú</li>
<li>Página listado de usuarios</li>
<li>Página descripción de usuario</li>
<li>Usuario administrador (opcional)</li>
<li>Protección del listado y descripción de usuarios (opcional)</li>
<li>Bloqueo de usuarios por el usuario administrador (opcional)</li>
</ol>
<p>La práctica va a consistir en la realización en tu proyecto de todos
los elementos necesarios para implementar estas features : tablero Trello,
issues, pull requests (con sus <em>commits</em> en los que se desarrolla paso a paso
cada issue) y tablero del proyecto. </p>
<p>Haremos paso a paso la historia de usuario 1, creando la primera
versión 1.0.1 de la aplicación. Las siguientes características las
deberás desarrollar tu mismo y entregar la versión 1.1.0.</p>
<h3 id="version-101">Versión 1.0.1<a class="headerlink" href="#version-101" title="Permanent link">&para;</a></h3>
<p>Para que veas la metodología de desarrollo, vamos a desarrollar una <strong>versión
1.0.1</strong> en la que se implementa la primera característica: <strong>Página <em>Acerca
de</em></strong>. Todo el resto de funcionalidades las deberás incorporar en la <strong>versión
1.1.0</strong>, que deberás desarrollar durante las cuatro semanas que dura esta práctica.</p>
<h4 id="tablero-trello">Tablero Trello<a class="headerlink" href="#tablero-trello" title="Permanent link">&para;</a></h4>
<p>Crea un en Trello un <strong>tablero público</strong> llamado <code>ToDoList MADS</code>. Va a servir
como <em>backlog</em> de las historias de usuario que debes realizar en
la práctica.  Añade en él 3 columnas, tal y se explica en el
apartado anterior de metodología de desarrollo.</p>
<p>Añade el enlace en el README del repositorio GitHub, para que el profesor pueda
acceder a consultar el estado del proyecto.</p>
<p>Un ejemplo de tablero es el <a href="https://trello.com/b/5zWOT6uO/todolist-inicial">Trello del proyecto mads-todolist-inicial</a>.</p>
<p>Utilizaremos el tablero Trello para documentar las características a
desarrollar en la aplicación. Deberá haber una tarjeta para cada
característica. Cada característica deberá tener un número y un título.</p>
<p><img src="imagenes/trello-version-1.png" width="600px"/></p>
<p>Añade la descripción de la característica <strong>Página <em>Acerca de</em></strong>:</p>
<p><img src="imagenes/trello-acerca-de.png" width="700px"/></p>
<p>Cuando empecemos a trabajar en la historia de usuario moveremos la
tarjeta a <em>En marcha</em> y cuando la hayamos terminado de testear e
integrar en la rama principal la moveremos a <em>Terminadas</em>.</p>
<h4 id="tablero-de-github">Tablero de GitHub<a class="headerlink" href="#tablero-de-github" title="Permanent link">&para;</a></h4>
<p>GitHub ha cambiado recientemente la forma de gestionar visualmente los
<em>issues</em> para hacerla mucho más flexible y potente.</p>
<p>En la versión actual, la funcionalidad se denomina <em>Proyectos</em>. Un
proyecto está asociado a un usuario de GitHub y puede contener issues de más de
un repositorio. Un usuario puede crear los proyectos que considere
necesarios. También se pueden crear proyectos asociados a
organizaciones.</p>
<p>En cuanto a la forma de visualizar los issues, podemos seleccionar dos
formas: como un tablero o como una hoja de cálculo. La primera forma
es más sencilla y la segunda más potente. En la asignatura usaremos la primera.</p>
<p>Puedes encontrar más información sobre los GitHub Projects en <a href="https://docs.github.com/en/issues/planning-and-tracking-with-projects/learning-about-projects/quickstart-for-projects">este
enlace</a>.</p>
<p>En la asignatura vamos a usar los proyectos de GitHub para mostrar, en
forma de tablero, los issues del repositorio de la práctica. También
podremos acceder a los pull requests desde cada uno de los issues
(enlazaremos los issues a su pull request).</p>
<div class="admonition note">
<p class="admonition-title">Aviso</p>
<p>Aunque se han añadido en los apuntes las nuevas imágenes sobre el
proceso de creación de un proyecto, no se han actualizado todas
las imágenes en las que aparece el tablero de proyectos, por lo
que puede que alguna imagen no represente fielmente la aparencia
real que tiene en la actualidad.</p>
</div>
<p>Lo primero que debes hacer es crear un proyecto desde el enlace
<code>Projects</code> en la organización <a href="https://github.com/mads-ua-23-24">mads-ua-23-24</a>.</p>
<p><img src="./imagenes/project-profile.png" width="600px"></p>
<p>Selecciona la opción <strong>Board</strong> y ponle como nombre <strong>tu usuario de GitHub</strong>:</p>
<p><img src="./imagenes/crear-proyecto.png" width="600px"/></p>
<p>Define una columna adicional <em>In Pull Request</em>, entre <em>In Progress</em> y
<em>Done</em>:</p>
<p><img src="./imagenes/proyecto-todolist.png" width="600px"/></p>
<p>En las columnas colocaremos los issues del proyecto (y los PRs estarán
enlazados en ellos). GitHub permite automatizar el movimiento de las
tarjetas de una columna a otra.</p>
<p>Activa dos flujos de trabajo. Uno para que cuando un issue nuevo se
añada al proyecto se coloque en la columna <em>To Do</em>:</p>
<p><img src="./imagenes/workflow-1.png" width="600px"/></p>
<p>Y otro para que cuando se cierre un issue se mueva a la columna de <em>Done</em>:</p>
<p><img src="./imagenes/workflow-2.png" width="600px"/></p>
<p>El resto de cambios de los issues los tendrás que hacer
manualmente. Por ejemplo, cuando crees el <em>pull request</em> asociado a un
issue tendrás que mover el issue a la columna de <em>In Pull Request</em>.</p>
<p>En resumen, las condiciones de las fichas que habrá en cada columna
son las siguientes: </p>
<ul>
<li>Columna <code>To do</code>: Nuevos issues añadidos al proyecto. Cuando
  añadimos el proyecto al issue (en la página del issue) GitHub
  lo coloca automáticamente en esta columna.</li>
<li>Columna <code>In progress</code>: issues que se han comenzado a implementar
  (se ha creado una rama su desarrollo). Manual.</li>
<li>Columna <code>In pull request</code>: moveremos a esta columna el issue abramos
  un PR y lo enlacemos con el issue. Manual.
  GitHub lo coloca automáticamente en esta columna. implementado por el pull request manualmente.</li>
<li>Columna <code>Done</code>: pull requests cerrados. GitHub lo detecta automáticamente.</li>
</ul>
<p>Por último, en la opción <em>Settings &gt; Manage access</em> comparte el
tablero con mi usuario de GitHub <code>domingogallardo</code>, para que pueda
revisarlo:</p>
<p><img src="./imagenes/acceso-proyecto.png" width="600px"/></p>
<p>Y cambia el <em>base role</em> a modo <em>No access</em> para solo tengan acceso al
tablero las personas colaboradoras.</p>
<p><img src="./imagenes/project-no-access.png" width="600px"/></p>
<p>Por último, desde la página <em>Projects</em> del repositorio, añade el
proyecto al repositorio:</p>
<p><img src="./imagenes/project-repository.png" width="600px"/></p>
<h4 id="issues">Issues<a class="headerlink" href="#issues" title="Permanent link">&para;</a></h4>
<p>Añade en el proyecto las etiquetas que vamos a usar inicialmente.</p>
<p><img src="./imagenes/labels-practica.png" width="400px"/></p>
<p>Crea el primer issue, correspondiente a la <em>feature</em> a desarrollar
<strong>Página <em>Acerca de</em></strong>. </p>
<p><img src="./imagenes/issue-acerca-de-detalle.png" width="600px"/></p>
<p>Crea el milestone 1.0.1. Y, desde la página del issue, añade el
milestone y el proyecto. Automáticamente se añadirá en la columna <code>To Do</code>.</p>
<p><img src="./imagenes/pagina-issue.png" width="600px"/></p>
<p>En el listado de issues del repositorio debe aparecer este recién creado:</p>
<p><img src="./imagenes/issue-acerca-de-listado.png" width="500px"/></p>
<h4 id="desarrollo">Desarrollo<a class="headerlink" href="#desarrollo" title="Permanent link">&para;</a></h4>
<p>Para desarrollar el issue abriremos una rama en Git, realizaremos
commits sobre ella hasta estar terminado y después crearemos un <em>pull
request</em> en GitHub para realizar la integración con la rama <code>main</code>.</p>
<p>Mueve en el tablero la tarjeta con el issue a la columna <code>In
progress</code>.</p>
<p><img src="./imagenes/in-progress-issue-1.png" width="500px" /></p>
<p>Empezamos el desarrollo importando el proyecto en IntelliJ y abriendo
un terminal para trabajar con Git:</p>
<p><img src="./imagenes/intellij-practica.png" width="700px"/></p>
<p>En el terminal escribimos los comandos para crear la rama en la que
desarrollaremos la feature y subirla:</p>
<div class="highlight"><pre><span></span><code>(main) $ git checkout -b acerca-de
(acerca-de) $ git push -u origin acerca-de
</code></pre></div>
<h5 id="primer-commit">Primer commit<a class="headerlink" href="#primer-commit" title="Permanent link">&para;</a></h5>
<p>Hacemos un primer commit.</p>
<p>Cambia en <code>pom.xml</code> el nombre del proyecto (<code>artifactId</code>) a <code>mads-todolist-&lt;tu-nombre&gt;</code> y
la versión a <code>1.0.1-SNAPSHOT</code>. El sufijo <code>SNAPSHOT</code> indica <em>en
desarrollo</em>. Cuando hagamos el release de la versión 1.0.1
eliminaremos el sufijo.</p>
<p>Realiza el commit y súbelo a GitHub:</p>
<div class="highlight"><pre><span></span><code><span class="hll">(acerca-de) $ git status (comprobamos los ficheros que han cambiado)
</span>On branch acerca-de
Your branch is up to date with &#39;origin/acerca-de&#39;.

Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

    modified:   README.md
    modified:   pom.xml

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
<span class="hll">(acerca-de) $ git add .
</span><span class="hll">(acerca-de) $ git status (comprobamos que está listo para añadirse en el commit)
</span><span class="hll">(acerca-de) $ git commit -m &quot;Cambiado el nombre del proyecto y empezamos versión 1.0.1&quot;
</span>On branch acerca-de
Your branch is up to date with &#39;origin/acerca-de&#39;.

Changes to be committed:
  (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)

    modified:   README.md
    modified:   pom.xml
(acerca-de) $ git push
</code></pre></div>
<p>Consulta en GitHub que el <em>commit</em> se ha subido en GitHub:</p>
<p><img src="./imagenes/commit-practica-github.png" width="600px"/></p>
<p>De esta forma habrás comprobado que tienes permiso de escritura en
el repositorio y que ya puedes comenzar a realizar la práctica.</p>
<h5 id="segundo-commit">Segundo commit<a class="headerlink" href="#segundo-commit" title="Permanent link">&para;</a></h5>
<p>En el segundo commit incluiremos el desarrollo de los elementos
necesarios para la página <em>acerca de</em>:</p>
<ul>
<li>Acción en controller</li>
<li>Vista</li>
</ul>
<p>Añade los siguientes ficheros:</p>
<p><strong>Controller <code>main/java/madstodolist/controller/HomeController.java</code></strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist.controller</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.ui.Model</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HomeController</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/about&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">about</span><span class="p">(</span><span class="n">Model</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;about&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p><strong>Vista <code>main/resources/templates/about.html</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">head</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments :: head (titulo=&#39;Acerca de&#39;)&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container-fluid&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container-fluid&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>ToDoList<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Desarrollada por TU NOMBRE <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Versión 1.0.1 (en desarrollo)<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Fecha de release: pendiente de release<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments::javascript&quot;</span><span class="p">/&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p>Prueba la página accediendo a la url
<a href="http://localhost:8080/about">http://localhost:8080/about</a>. </p>
<p><img src="./imagenes/pagina-acerca-de.png" width="400px"/></p>
<p>Añade un test que automatiza la comprobación de que la URL <code>/about</code>
debe devolver el nombre de la aplicación.</p>
<p><strong>Test <code>test/java/madstodolist/AcercaDeWebTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">madstodolist</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.web.servlet.MockMvc</span><span class="p">;</span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.hamcrest.Matchers.containsString</span><span class="p">;</span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get</span><span class="p">;</span>
<span class="kn">import static</span><span class="w"> </span><span class="nn">org.springframework.test.web.servlet.result.MockMvcResultMatchers.content</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureMockMvc</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AcercaDeWebTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MockMvc</span><span class="w"> </span><span class="n">mockMvc</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getAboutDevuelveNombreAplicacion</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mockMvc</span><span class="p">.</span><span class="na">perform</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;/about&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">andExpect</span><span class="p">(</span><span class="n">content</span><span class="p">().</span><span class="na">string</span><span class="p">(</span><span class="n">containsString</span><span class="p">(</span><span class="s">&quot;ToDoList&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Puedes lanzar el test pulsando en IntelliJ con el botón derecho en el
fichero (en el panel del proyecto) y seleccionando la opción <em>Run
AcercaDeWebTest</em>.</p>
<p>Puedes lanzar también todos los tests en el terminal para comprobar
que no se ha roto nada.</p>
<div class="highlight"><pre><span></span><code>(acerca-de) $ ./mvnw test
...
[INFO] 
[INFO] Tests run: 34, Failures: 0, Errors: 0, Skipped: 0
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  21.879 s
</code></pre></div>
<p>Por último, confirma el commit en la rama y súbelo a GitHub. En el
panel <code>Git</code>:</p>
<div class="highlight"><pre><span></span><code>(acerca-de) $ git add .
(acerca-de) $ git status (comprueba que se han añadido los ficheros)
(acerca-de) $ git commit -m &quot;Añadida vista y controller &#39;about&#39;&quot;
(acerca-de) $ git push
</code></pre></div>
<h5 id="tercer-commit">Tercer commit<a class="headerlink" href="#tercer-commit" title="Permanent link">&para;</a></h5>
<p>En el tercer commit pondremos un enlace a la página <em>acerca de</em> en la página de
login de la aplicación.</p>
<p>Realiza el siguiente cambio:</p>
<div class="highlight"><span class="filename">formLogin.html</span><pre><span></span><code><span class="w"> </span>                        &lt;a class=&quot;btn btn-link&quot; href=&quot;/registro&quot;&gt;Ir a registro&lt;/a&gt;
<span class="gi">+                        &lt;a class=&quot;btn btn-link&quot; href=&quot;/about&quot;&gt;Acerca de&lt;/a&gt;</span>
<span class="w"> </span>                    &lt;/div&gt;
<span class="w"> </span>            &lt;/form&gt;
</code></pre></div>
<p>Prueba que funciona correctamente, prueba los tests, haz el commit y
súbelo a GitHub:</p>
<div class="highlight"><pre><span></span><code>(acerca-de) $ git status
(acerca-de) $ git add .
(acerca-de) $ git commit -m &quot;Añadido enlace a página &#39;about&#39; en página &#39;login&#39;&quot;
(acerca-de) $ git push
</code></pre></div>
<h4 id="pull-request">Pull request<a class="headerlink" href="#pull-request" title="Permanent link">&para;</a></h4>
<p>Una vez terminada la implementación de la feature en la rama,
creamos un pull request en GitHub para indicar que estamos listos
para mezclar la rama con la feature con la rama principal de
desarrollo (<em>main</em>).</p>
<h5 id="creacion-del-pull-request">Creación del pull request<a class="headerlink" href="#creacion-del-pull-request" title="Permanent link">&para;</a></h5>
<p>Accede en GitHub a la rama <code>acerca-de</code> y comprueba que se han subido
todos los cambios pulsando <code>Compare</code>.</p>
<p><img src="./imagenes/rama-acerca-de.png" width="700px"/></p>
<p>Aparecerá la siguiente página, con la información de los cambios que
introducen todos los commits de la rama:</p>
<p><img src="./imagenes/compara-cambios-pr.png" width="700px"/></p>
<p>Pulsa después el botón <em>Create pull request</em> para crear el pull request.</p>
<p>Escribe como título del PR: <code>Añadida página 'Acerca de'</code> y en el comentario escribe:</p>
<div class="highlight"><pre><span></span><code>Closes #1
</code></pre></div>
<p>Verás que al escribir <code>#1</code> aparecerá el nombre del issue. Si escribes
sólo <code>#</code> verás una lista de los últimos issues. </p>
<p>De esta forma estamos enlazando el PR con el issue. Cuando se cierre
el pull request se cerrará automáticamente el issue. También podremos
acceder desde el issue al PR enlazado.</p>
<p>Pulsa en el botón para crear el pull request. Debe quedar la
siguiente pantalla en la que informa del PR recién creado:</p>
<p><img src="./imagenes/pull-request-practica.png" width="700px"/></p>
<p>En el proyecto mueve la tarjeta con el issue a la columna <code>In
Pull Request</code>. Verás que se ha añadido en la parte inferior de la
tarjeta un desplegable con la información sobre el PR enlazado.</p>
<p><img src="./imagenes/movido-a-in-pull-request.png" width="700px"/></p>
<p>En este momento los compañeros del equipo podrían revisar el pull
request y el código que se va a introducir. En la propia página del
pull request es posible conversar y realizar comentarios que puede
aclarar el autor del PR. Y también es posible subir nuevos commits con
modificaciones o ampliaciones correspondientes a las sugerencias
indicadas.</p>
<p>Haremos esto en futuras prácticas.</p>
<p>Podemos ver que GitHub informa de que no hay conflictos con la rama
<code>main</code> y que es posible hacer el merge en GitHub.</p>
<p>Antes de pulsar el botón para realizar el merge, lanzamos los tests
(estando en la rama) para comprobar que no se ha roto nada y que los
tests que se han añadido pasan correctamente (en este caso no hemos
añadido ninguno).</p>
<div class="highlight"><pre><span></span><code>(acerca-de) $ ./mvnw test
...
[INFO] 
[INFO] Tests run: 34, Failures: 0, Errors: 0, Skipped: 0
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  21.879 s
</code></pre></div>
<p>Veremos en la próxima práctica cómo configurar GitHub para que esta
comprobación se haga de forma automática en GitHub.</p>
<p>Aunque deberíamos también comprobar que los tests pasan correctamente
después de mezclar la rama con <code>main</code>, dejamos de hacer esta
comprobación porque a partir de la próxima práctica lo haremos también
de forma automática en GitHub.</p>
<!--

##### Comprobación de tests en main #####

Antes de pulsar el botón para que GitHub mezcle la rama `acerca-de` en
la rama `main` debemos comprobar que todos los tests pasarían
correctamente después de la mezcla. Podría ser que algún test
funcionara en la rama, pero se rompiera después de hacer la mezcla en
`main` porque fuera incompatible con alguna modificación de código que
se ha hecho esa rama. 

Veremos en la próxima práctica cómo configurar GitHub para que esta
comprobación se haga de forma automática, pero en esta práctica vamos
a hacerlo manualmente en nuestro ordenador.

Una opción sería mezclar la rama `acerca-de` en `main`, lanzar los
tests y después deshacer la mezcla. Pero vamos a usar otra opción:
mezclaremos la rama `main` en la rama `acerca-de` y lanzaremos los
tests ahí. Así dejamos la rama `main` limpia y no tenemos que deshacer
nada. El código de `main` en la rama de `acerca-de` no va a molestar
porque Git lo identifica correctamente como un código que no es de la
rama `acerca-de` y en el caso de tener que hacer algún commit
adicional y subirlo a GitHub, en GitHub se va a mostrar correctamente
sólo el código adicional (no el de la rama `main`).

Vamos a verlo paso a paso.

Mezclamos la rama `main` en la rama de desarrollo `acerca-de`, para
probar que no se ha roto nada (todos los tests deben seguir pasando) y
que los tests que hemos añadido también funcionan correctamente (en
este caso no hemos añadido ninguno).

En el terminal:

<div class="highlight"><pre><span></span><code>(acerca-de) $ git checkout main
(main) $ git pull (bajamos cambios que se hayan subido main. En
                     este caso no habrá ninguno, pero los habrán cuando
                     trabajemos en equipo)
(main) $ git checkout acerca-de
(acerca-de) $ git merge main (actualizamos la rama de desarrollo con los
                         cambios que se hayan incluido en la rama
                         principal. En este caso no habrá ninguno,
                         pero los habrán cuando trabajemos en equipo)
</code></pre></div>

Lanzamos los tests (lo podemos hacer en el terminal o en IntelliJ):

<div class="highlight"><pre><span></span><code>(main) $ ./mvnw test
...
[INFO] 
[INFO] Tests run: 31, Failures: 0, Errors: 0, Skipped: 0
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  21.879 s
</code></pre></div>

Si algún test fallara, debemos corregirlo en la rama de desarrollo y
subir el commit a la rama. Veremos que se actualizará el pull request
y aparecerá la información del nuevo commit.

Una vez que hemos comprobados que los tests pasan correctamente
podemos confirmar la mezcla del PR en GitHub.

-->

<p>Pulsa el botón de <code>Merge pull request</code> (con la opción por defecto
<code>Create a merge commit</code>) y confírmalo. </p>
<p><img src="./imagenes/merge-pull-request.png" width="600px"/></p>
<p>Borra la rama en GitHub, pulsando el botón correspondiente.</p>
<p><img src="./imagenes/merge-pull-request-1.png" width="600px"/></p>
<p>Este <em>merge</em> lo has hecho en GitHub. Debes por último integrarlo en tu
repositorio local. En el terminal:</p>
<div class="highlight"><pre><span></span><code>(acerca-de) $ git checkout main
(main) $ git pull (bajamos los cambios)
(main) $ git branch -d acerca-de (borramos la rama)
(main) $ git remote prune origin (borramos referencias a rama remota)
(main) $ git log --oneline --graph --all
    *   9527ae2 (HEAD -&gt; main, origin/main, origin/HEAD) Merge pull request #2 from mads-ua-18/acerca-de
    |\  
    | * 672c28f Añadido enlace a página &#39;about&#39; en página &#39;login&#39;
    | * 3fdfb83 Añadida ruta, vista y controller &#39;about&#39;
    | * a332017 Cambiado el nombre del proyecto y empezamos versión 1.0.0
    |/  
    * 6767016 Commit inicial
</code></pre></div>
<p>Comprobamos también la historia de <em>commits</em> en GitHub. Aparecerá el
<em>commit</em> de <em>merge</em> introducido por el pull request.</p>
<p><img src="./imagenes/historia-commits-practica1.png" width="800px"/></p>
<p>De esta forma hemos cerrado el PR e integrado su código en la rama
principal de desarrollo. El issue ligado al PR se habrá cerrado
automáticamente y en el tablero de proyecto debe haber cambiado
la tarjeta a la columna <code>Done</code>.</p>
<h4 id="actualizamos-tablero-trello">Actualizamos tablero Trello<a class="headerlink" href="#actualizamos-tablero-trello" title="Permanent link">&para;</a></h4>
<p>Actualizamos el tablero Trello moviendo la historia de usuario a la
columna <em>Terminadas</em>.</p>
<p><img src="./imagenes/trello-terminadas.png" width="600px"/></p>
<h4 id="release-101">Release 1.0.1<a class="headerlink" href="#release-101" title="Permanent link">&para;</a></h4>
<p>Vamos a ver por último cómo crear un <em>release</em> y poner en producción
la aplicación. Lo vamos a hacer ahora como ejemplo, creando el release
1.0.1 y tendrás que hacerlo otra vez más al final de la práctica, creando el
release 1.1.0.</p>
<p>Para hacer el release haremos un commit directamente sobre la rama
<code>main</code> (más adelante explicaremos una forma más elaborada de hacer un
release, cuando expliquemos el flujo de trabajo de GitFlow).</p>
<p>Crea un commit con la confirmación del número de versión y fecha en
los ficheros <code>pom.xml</code> y <code>about.html</code></p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><span class="w"> </span>    &lt;groupId&gt;es.ua.mads&lt;/groupId&gt;
<span class="w"> </span>    &lt;artifactId&gt;mads-todolist-dgallardo&lt;/artifactId&gt;
<span class="gd">-    &lt;version&gt;1.0.1-SNAPSHOT&lt;/version&gt;</span>
<span class="gi">+    &lt;version&gt;1.0.1&lt;/version&gt;</span>
</code></pre></div>
<div class="highlight"><span class="filename">about.html</span><pre><span></span><code><span class="w"> </span>   &lt;h1&gt;ToDo List&lt;/h1&gt;
<span class="w"> </span>       &lt;ul&gt;
<span class="w"> </span>        &lt;h1&gt;ToDo List&lt;/h1&gt;
<span class="w"> </span>        &lt;ul&gt;
<span class="w"> </span>            &lt;li&gt;Desarrollada por Domingo Gallardo&lt;/li&gt;
<span class="gd">-            &lt;li&gt;Versión 1.0.1 (en desarrollo)&lt;/li&gt;</span>
<span class="gd">-            &lt;li&gt;Fecha de release: pendiente de release&lt;/li&gt;</span>
<span class="gi">+            &lt;li&gt;Versión 1.0.1&lt;/li&gt;</span>
<span class="gi">+            &lt;li&gt;Fecha de release: 17/9/2018&lt;/li&gt;</span>
<span class="w"> </span>        &lt;/ul&gt;
}
</code></pre></div>
<p>Añadimos el commit y lo subimos a GitHub</p>
<div class="highlight"><pre><span></span><code>(main) $ git add .
(main) $ git commit -m &quot;Cambio de versión a 1.0.1&quot;
(main) $ git push
</code></pre></div>
<p>Y creamos la versión 1.0.1 en GitHub pulsando en el enlace <code>Create a new release</code> en la página principal: </p>
<p><img src="./imagenes/release-practica1.png" width="700px"/></p>
<p>Un release en GitHub se guarda como una una etiqueta Git, junto con
información asociada. Se suelen indicar las nuevas features añadidas
en el release mediante enlaces a los pull requests
añadidos. </p>
<p><img src="./imagenes/primer-release-practica1.png" width="700px"/></p>
<p>El resultado será:</p>
<p><img src="./imagenes/release-practica1-terminado.png" width="400px"/></p>
<h4 id="puesta-en-produccion">Puesta en producción<a class="headerlink" href="#puesta-en-produccion" title="Permanent link">&para;</a></h4>
<p>Debes por último poner en producción la nueva versión, igual que
hicimos en la práctica 1, creando una imagen Docker, subiéndola a
Docker Hub y poniéndola en ejecución en el servidor de la asignatura.</p>
<p>Para crear la imagen Docker primero debes crear el fichero JAR con la
aplicación:</p>
<div class="highlight"><pre><span></span><code>$ ./mvnw package
$ ls -l target/*.jar
target/mads-todolist-domingogallardo-1.0.1.jar
</code></pre></div>
<p>Y después construir la imagen docker:</p>
<div class="highlight"><pre><span></span><code>$ docker build -t &lt;usuario-docker&gt;/mads-todolist .
</code></pre></div>
<p>Sube la máquina a Docker Hub (automáticamente se etiquetara como
<code>latest</code>). Y etiqueta la máquina docker con la versión <code>1.0.1</code> y
súbela también.</p>
<div class="highlight"><pre><span></span><code>$ docker push &lt;usuario-docker&gt;/mads-todolist 
Using default tag: latest
$ docker tag &lt;usuario-docker&gt;/mads-todolist &lt;usuario-docker&gt;/mads-todolist:1.0.1
$ docker push &lt;usuario-docker&gt;/mads-todolist:1.0.1
</code></pre></div>
<p>Conéctate al servidor de la asignatura, descarga en él la máquina
Docker y pon en producción la aplicación. Comprueba que todo funciona
correctamente y después para y borra el contenedor y la imagen.</p>
<p>En clase de prácticas deberás hacer lo mismo y el profesor revisará
que la aplicación en producción funciona correctamente.</p>
<h3 id="resto-de-la-practica-version-110">Resto de la práctica (versión 1.1.0)<a class="headerlink" href="#resto-de-la-practica-version-110" title="Permanent link">&para;</a></h3>
<p>El resto de la práctica consistirá en desarrollar la versión 1.1.0,
usando la misma metodología vista anteriormente.</p>
<p>Deberás desarrollar tres características nuevas obligatorias y 3 opcionales:</p>
<ul>
<li>(Obligatoria) Barra de menú</li>
<li>(Obligatoria) Página de listado de usuarios</li>
<li>(Obligatoria) Página de descripción de un usuario</li>
<li>(Opcional) Usuario administrador </li>
<li>(Opcional) Protección listado y descripción de usuario</li>
<li>(Opcional) Administrador puede bloquear el acceso a usuarios</li>
</ul>
<p>Deberás implementar cada característica siguiendo la metodología que
hemos usado anteriormente. En la implementación, deberás añadir el
código necesario en cada una de las capas de la aplicación:</p>
<ul>
<li>Capa de presentación (vista)</li>
<li>Nuevo método en la capa de controller</li>
<li>Métodos necesarios en la capa de servicio y de repository</li>
</ul>
<p>En cada característica deberás también incluir <strong>tests</strong> que prueben los
nuevos métodos añadidos en la capa de servicio, así como los nuevos
controllers y vistas añadidos.</p>
<h4 id="barra-de-menu">Barra de menú<a class="headerlink" href="#barra-de-menu" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>La aplicación deberá tener una barra de menú común a todas sus
  páginas, menos en las páginas de login y registro.</p>
</li>
<li>
<p>La barra de menú estará situada en la parte superior de la página y
será un <a href="https://getbootstrap.com/docs/4.0/components/navbar/">Navbar</a>
de Bootstrap.</p>
</li>
<li>
<p>La barra de menú tendrá como mínimo los siguientes elementos (de izquierda a derecha):</p>
</li>
<li><code>ToDoList</code>: enlace a la página <em>acerca de</em>.</li>
<li><code>Tareas</code>: enlace a la página de tareas, con la lista de tareas
  pendientes del usuario.</li>
<li>
<p><em>Nombre usuario</em>: A la derecha de la página. Desplegable con las opciones:</p>
<ul>
<li><code>Cuenta</code>: Futura página para gestionar la cuenta</li>
<li><code>Cerrar sesión &lt;nombre usuario&gt;</code>: cierra la sesión y lleva a la
 página de login.</li>
</ul>
</li>
<li>
<p>En la página <em>acerca de</em> se debe cambiar la barra de menú
  dependiendo de si el usuario está o no logeado. Si está logeado será
  la barra común con el resto de las páginas. Si el usuario no está
  logeado, aparecerán enlaces a las páginas de login y registro.</p>
</li>
</ul>
<h4 id="listado-de-usuarios">Listado de usuarios<a class="headerlink" href="#listado-de-usuarios" title="Permanent link">&para;</a></h4>
<ul>
<li>Si se introduce la URL <code>/registrados</code> aparecerá un listado de los
  usuarios registrados (identificador y correo electrónico).</li>
</ul>
<h4 id="descripcion-de-usuario">Descripción de usuario<a class="headerlink" href="#descripcion-de-usuario" title="Permanent link">&para;</a></h4>
<ul>
<li>En la lista de usuarios habrá un enlace para acceder a su descripción.</li>
<li>En la descripción de un usuario aparecerán todos sus datos, menos la contraseña.</li>
<li>La ruta para obtener la descripción de un usuario registrado será <code>/registrados/:id</code>. </li>
</ul>
<h4 id="usuario-administrador-opcional">Usuario administrador (opcional)<a class="headerlink" href="#usuario-administrador-opcional" title="Permanent link">&para;</a></h4>
<p>Al realizar el registro será posible darse de alta como usuario
administrador.</p>
<ul>
<li>Para darse de alta como administrador se deberá activar un <em>check
  box</em> en la página de registro.</li>
<li>Sólo puede haber un administrador. Si ya existe un administrador, no
  debe aparecer el <em>check box</em> en la página de registro.</li>
<li>El usuario administrador accederá directamente a la lista de usuarios.</li>
</ul>
<h4 id="proteccion-de-listado-de-usuario-y-descripcion-de-usuario-opcional">Protección de listado de usuario y descripción de usuario (opcional)<a class="headerlink" href="#proteccion-de-listado-de-usuario-y-descripcion-de-usuario-opcional" title="Permanent link">&para;</a></h4>
<ul>
<li>Proteger las páginas con el listado de usuarios y la descripción de
usuario para que sólo las pueda consultar el administrador. En el caso
en que un usuario no administrador intente acceder a esas páginas,
devolver un código de error HTTP "No autorizado" y un mensaje
indicando que no se tiene suficiente permiso (de forma similar a como
se gestionan los accesos a las páginas de tareas sin estar logeado).</li>
</ul>
<h4 id="bloqueo-de-usuarios-por-usuario-administrador-opcional">Bloqueo de usuarios por usuario administrador (opcional)<a class="headerlink" href="#bloqueo-de-usuarios-por-usuario-administrador-opcional" title="Permanent link">&para;</a></h4>
<ul>
<li>Añadir en el listado de usuarios un botón para que el
  administrador pueda bloquear o habilitar el acceso a cada uno de los
  usuarios. </li>
<li>Si el usuario tiene bloqueado el acceso cuando intente logearse
  aparecerá un mensaje de error indicándoselo.</li>
</ul>
<h2 id="7-documentacion-entrega-y-evaluacion">7. Documentación, entrega y evaluación<a class="headerlink" href="#7-documentacion-entrega-y-evaluacion" title="Permanent link">&para;</a></h2>
<p>Deberás añadir una página documentación <code>/doc/practica2.md</code> en la que
debes realizar una breve <strong>documentación técnica</strong> de entre 500 y 800
palabras.</p>
<p>Debes suponer que estás trabajando con un equipo de desarrollo y que
debes dejar una breve documentación para que el resto del equipo sepa
cómo ha evolucionado la implementación de la aplicación. <strong>No debe ser
una manual de usuario, no es una documentación para el cliente</strong>.</p>
<p>Por ejemplo, la documentación podría contener:</p>
<ul>
<li>Listado de nuevas clases y métodos implementados.</li>
<li>Listado de plantillas thyemeleaf añadidas.</li>
<li>Explicación de los tests implementados.</li>
<li>Explicación de código fuente relevante de las nuevas funcionalidades
  implementadas.</li>
</ul>
<p>Obligatoriamente debes incluir en la documentación algún ejemplo de
código fuente que has añadido y que consideres interesante y su
explicación.</p>
<p>Deberás escribir esta documentación en Markdown. Tienes disponible en
GitHub una breve pero útil <a href="https://guides.github.com/features/mastering-markdown/">introducción a
Markdown</a>.</p>
<ul>
<li>La práctica tiene una duración de 4 semanas y debe estar terminada
  el martes 17 de octubre.</li>
<li>La parte obligatoria puntúa sobre 6 y la opcional sobre 4 puntos.</li>
<li>La calificación de la práctica tiene un peso de un 25% en la nota
  final de prácticas.</li>
<li>Para realizar la entrega se debe subir a Moodle un ZIP que contenga
  todo el proyecto, incluyendo el directorio <code>.git</code> que contiene la
  historia Git. Para ello comprime tu directorio local del proyecto
  <strong>después de haber hecho un <code>./mvnw clean</code></strong> para eliminar el
  directorio <code>target</code> que contiene los binarios compilados. Debes
  dejar también en Moodle la URL del repositorio en GitHub.</li>
</ul>
<p>Para la evaluación se tendrá en cuenta:</p>
<ul>
<li>Desarrollo continuo (los <em>commits</em> deben realizarse a lo largo de
  las 4 semanas y no dejar todo para la última semana).</li>
<li>Correcto desarrollo de la metodología.</li>
<li>Diseño e implementación del código y de los tests de las
  características desarrolladas. Correcto funcionamiento.</li>
<li>Documentación.</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>