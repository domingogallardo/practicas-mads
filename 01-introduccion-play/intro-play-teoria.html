



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Introducción a Play Framework para las prácticas de MADS # - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Helvetica:300,400,400i,700|Source+Code+Pro">
        <style>body,input{font-family:"Helvetica","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#introduccion-a-play-framework-para-las-practicas-de-mads" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Prácticas MADS" class="md-header-nav__button md-logo">
          
            <img src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Prácticas MADS
            </span>
            <span class="md-header-nav__topic">
              Introducción a Play Framework para las prácticas de MADS #
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo">
      
        <img src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Práctica 0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Práctica 0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/intro-spring-boot.html" title="Introducción a Sprign Boot para MADS" class="md-nav__link">
      Introducción a Sprign Boot para MADS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/comandos-git.html" title="Comandos Git" class="md-nav__link">
      Comandos Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica0.html" title="Práctica 0" class="md-nav__link">
      Práctica 0
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-intro-spring-boot/practica1.html" title="Práctica 1" class="md-nav__link">
      Práctica 1
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-pruebas-tdd/integration-tdd.html" title="Práctica 2" class="md-nav__link">
      Práctica 2
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aplicacion-play-proyecto-inicial" title="Aplicación play-proyecto-inicial" class="md-nav__link">
    Aplicación play-proyecto-inicial
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#descarga-de-la-aplicacion" title="Descarga de la aplicación" class="md-nav__link">
    Descarga de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-intellij-para-trabajar-con-la-aplicacion-play" title="Uso de IntelliJ para trabajar con la aplicación Play" class="md-nav__link">
    Uso de IntelliJ para trabajar con la aplicación Play
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uso-de-visual-studio-code-para-trabajar-con-la-aplicacion-play" title="Uso de Visual Studio Code para trabajar con la aplicación Play" class="md-nav__link">
    Uso de Visual Studio Code para trabajar con la aplicación Play
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lanzar-la-aplicacion-play" title="Lanzar la aplicación Play" class="md-nav__link">
    Lanzar la aplicación Play
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fichero-routes" title="Fichero routes" class="md-nav__link">
    Fichero routes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controllers" title="Controllers" class="md-nav__link">
    Controllers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vistas" title="Vistas" class="md-nav__link">
    Vistas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inyeccion-de-dependencias" title="Inyección de dependencias" class="md-nav__link">
    Inyección de dependencias
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests" title="Tests" class="md-nav__link">
    Tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aplicacion-mads-todolist-inicial" title="Aplicación mads-todolist-inicial" class="md-nav__link">
    Aplicación mads-todolist-inicial
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#descarga-de-la-aplicacion-mads-todolist-inicial" title="Descarga de la aplicación mads-todolist-inicial" class="md-nav__link">
    Descarga de la aplicación mads-todolist-inicial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#importacion-en-intellj-idea" title="Importación en IntellJ IDEA" class="md-nav__link">
    Importación en IntellJ IDEA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion-de-la-aplicacion-usando-la-base-de-datos-en-memoria" title="Ejecución de la aplicación usando la base de datos en memoria" class="md-nav__link">
    Ejecución de la aplicación usando la base de datos en memoria
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#base-de-datos-mysql-con-docker" title="Base de datos MySQL con Docker" class="md-nav__link">
    Base de datos MySQL con Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejecucion-de-la-aplicacion-usando-la-base-de-datos-mysql" title="Ejecución de la aplicación usando la base de datos MySQL" class="md-nav__link">
    Ejecución de la aplicación usando la base de datos MySQL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#panel-database-de-intellij" title="Panel Database de IntelliJ" class="md-nav__link">
    Panel Database de IntelliJ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-de-la-aplicacion" title="Configuración de la aplicación" class="md-nav__link">
    Configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gestion-de-persistencia-con-jpa" title="Gestión de persistencia con JPA" class="md-nav__link">
    Gestión de persistencia con JPA
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicios" title="Servicios" class="md-nav__link">
    Servicios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controllers_1" title="Controllers" class="md-nav__link">
    Controllers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vistas_1" title="Vistas" class="md-nav__link">
    Vistas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests_1" title="Tests" class="md-nav__link">
    Tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tecnologias-usadas" title="Tecnologías usadas" class="md-nav__link">
    Tecnologías usadas
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#play-framework" title="Play Framework" class="md-nav__link">
    Play Framework
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java-persistence-api-jpa" title="Java Persistence API (JPA)" class="md-nav__link">
    Java Persistence API (JPA)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootstrap" title="Bootstrap" class="md-nav__link">
    Bootstrap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="introduccion-a-play-framework-para-las-practicas-de-mads">Introducción a Play Framework para las prácticas de MADS<a class="headerlink" href="#introduccion-a-play-framework-para-las-practicas-de-mads" title="Permanent link">&para;</a></h1>
<p>Vamos a ver cómo lanzar y desarrollar una aplicación Play Framework en
Java. Presentaremos las principales características de este framework
de desarrollo de aplicaciones web mediante ejemplos concretos de
código que vamos a utilizar en las prácticas de la asignatura.</p>
<h2 id="aplicacion-play-proyecto-inicial">Aplicación <code>play-proyecto-inicial</code><a class="headerlink" href="#aplicacion-play-proyecto-inicial" title="Permanent link">&para;</a></h2>
<h3 id="descarga-de-la-aplicacion">Descarga de la aplicación<a class="headerlink" href="#descarga-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>La aplicación <code>play-proyecto-inicial</code> se encuentra en GitHub:
<a href="https://github.com/domingogallardo/play-proyecto-inicial">https://github.com/domingogallardo/play-proyecto-inicial</a>. Es un
esqueleto de aplicación Play con ejemplos básicos del funcionamiento
del framework.</p>
<p>Puedes descargarla usando el comando <code>git clone</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$  git clone https://github.com/domingogallardo/play-proyecto-inicial.git
</pre></div>
</td></tr></table>

<p>Se creará el directorio <code>play-proyecto-inicial</code> en el que se habrá
descargado la aplicación Play.</p>
<h3 id="uso-de-intellij-para-trabajar-con-la-aplicacion-play">Uso de IntelliJ para trabajar con la aplicación Play<a class="headerlink" href="#uso-de-intellij-para-trabajar-con-la-aplicacion-play" title="Permanent link">&para;</a></h3>
<p>Aunque es posible trabajar con editores como <em>Visual Studio Code</em>,
vamos a explicar cómo desarrollar las aplicaciones Play usando el IDE
IntelliJ IDEA.</p>
<p>Las aplicaciones Play se pueden escribir en Java y en Scala. Nosotros
usaremos Java. Una parte importante de las librerías del framework
están escritas en Scala, por lo que debe estar instalado el plugin de
Scala en IntelliJ.</p>
<p>Se debe importar el proyecto usando la opción <code>sbt</code>, la herramienta de
build que usa Play. </p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/import-intellij-1.png" width="400px"/></p>
<p>Sbt es una herramienta similar a Maven para Java, es la herramienta que
se usa para construir proyectos Scala. El fichero de configuración de
un proyecto sbt es el fichero <code>build.sbt</code> situado en el directorio
raíz.</p>
<p>Para compilar los proyectos también es necesario tener instalado
JDK. Nos aseguramos de que aparece en el panel de importación. Si no,
seleccionamos el directorio donde se encuentra la versión del JDK que
vamos a utilizar.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/import-intellij-2.png" width="400px"/></p>
<p>Es conveniente activar la auto-importación del proyecto sbt. De esta
forma, si IntelliJ detecta algún cambio en la configuración sbt
realiza la importación de forma automática.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/sbt-enable-auto-import.png" width="300px"/></p>
<p>Si se pincha en el icono de la esquina inferior izquierda de la
ventana de IntelliJ podremos activar o desactivar la visualización de
los nombres de los paneles en los bordes de la ventana. </p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/mostrar-nombre-paneles.png" width="80px"/></p>
<p>Es recomendable dejarlos visibles.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/bordes-con-nombres-paneles.png" width="400px"/></p>
<p>Utilizaremos el panel <code>Terminal</code> para trabajar con <code>sbt</code> y con
<code>git</code>. Es recomendable abrir dos tabs, uno para cada cosa. </p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/terminal.png" width="500px"/></p>
<h3 id="uso-de-visual-studio-code-para-trabajar-con-la-aplicacion-play">Uso de Visual Studio Code para trabajar con la aplicación Play<a class="headerlink" href="#uso-de-visual-studio-code-para-trabajar-con-la-aplicacion-play" title="Permanent link">&para;</a></h3>
<p>Si no es posible utilizar un editor avanzado como IntelliJ es posible
usar en su lugar <em>Visual Studio Code</em>.</p>
<p>Abre la carpeta con el directorio del proyecto y abre un terminal con
la opción <em>Ver &gt; Terminal integrado</em>. En ese terminal lanzaremos el
comando Docker para trabajar con <code>sbt</code>. Puedes abrir otro terminal
pulsando en el símbolo <code>+</code> para trabajar con Git.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/visual-studio-code.png" width="700px"/></p>
<h3 id="lanzar-la-aplicacion-play">Lanzar la aplicación Play<a class="headerlink" href="#lanzar-la-aplicacion-play" title="Permanent link">&para;</a></h3>
<p>Podemos ejecutar la aplicación Play de tres formas. Utilizaremos las
tres a lo largo de las prácticas.</p>
<ul>
<li>Usando una máquina Docker.</li>
<li>Usando el <code>sbt shell</code> que proporciona IntelliJ.</li>
<li>Usando la configuración de ejecución de IntelliJ.</li>
</ul>
<h4>Máquina Docker</h4>
<p>La máquina docker <code>domingogallardo/playframework</code> contiene todo el
software y librerías para ejecutar aplicaciones Play 2.5.18. La
ventaja de utilizar la máquina Docker es que Una vez
descargada la máquina ya no es necesario descargar librerías
adicionales. Está instalada en los laboratorios de la EPS.</p>
<p>Nos movemos al directorio de la aplicación Play y desde el terminal
lanzamos el comando <code>docker run</code> para ejecutar la máquina sobre el
directorio actual conectando el puerto 9000 en el mismo puerto de
nuestra máquina:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cd play-proyecto-inicial
$ docker run --rm  -it -v &quot;${PWD}:/code&quot; -p 9000:9000 domingogallardo/playframework
[play-java] $ 
</pre></div>
</td></tr></table>

<p>Aparecerá el prompt de sbt con el nombre del proyecto. Podremos lanzar
comandos de sbt como <code>run</code> o <code>test</code>. Haciendo <code>run</code> se ejecuta la
aplicación web. Por defecto el puerto al que hay que atacar es
el 9000. Accediendo a la URL <a href="http://localhost:9000">http://localhost:9000</a> pondremos en
marcha la aplicación. Haciendo <code>test</code> se lanzan los tests incluidos en
la aplicación.</p>
<p>Con <code>exit</code> se sale del prompt de sbt y automáticamente se para el
contenedor y se elimina el contenedor de Docker.</p>
<h4>Shell sbt de IntelliJ</h4>
<p>También es posible arrancar el shell de <code>sbt</code> en un panel propio que
proporciona IntelliJ.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/sbt-shell.png" width="400px"/></p>
<p>Cuando lo ejecutamos por primera vez se descargan todas las librerías
necesarias. </p>
<h4>Configuración de ejecución de IntelliJ</h4>
<p>También podemos crear una configuración de ejecución de IntelliJ con
la que podremos ejecutar y depurar los proyectos con la opción <em>Run &gt;
Edit Configurations..</em>.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/run-debug-configuration.png" width="400px"/></p>
<p>Una vez creada la configuración podremos seleccionarla y realizar una
ejecución o una depuración de la aplicación pulsando los botones
correspondientes en la parte superior de la ventana de IntelliJ.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/botones-run-debug.png" width="200px"/></p>
<h3 id="fichero-routes">Fichero routes<a class="headerlink" href="#fichero-routes" title="Permanent link">&para;</a></h3>
<p>El <code>routes</code>, situado en el directorio <code>conf</code>, especifica el código a
ejecutar como respuesta a una petición HTTP.</p>
<p><strong>Fichero <code>conf/routes</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># Routes
# This file defines all application routes (Higher priority routes first)
# ~~~~

# An example controller showing a sample home page
GET     /                           controllers.HomeController.index
# An example controller showing how to use dependency injection
GET     /count                      controllers.CountController.count
# An example controller showing how to write asynchronous code
GET     /message                    controllers.AsyncController.message

# Map static resources from the /public folder to the /assets URL path
GET     /assets/*file               controllers.Assets.versioned(path=&quot;/public&quot;, file: Asset)
</pre></div>
</td></tr></table>

<p>Por ejemplo, cuando se recibe la petición <code>GET /</code> (cuando en
el navegador escribimos la URL <code>http::/localhost/</code>) se ejecutará el
método <code>index</code> de la clase <code>controllers.HomeController</code>. O cuando
desde el navegador accedamos a la URL <code>http://localhost/count</code> se
generará la petición <code>GET /count</code> y se ejecutará el método <code>count</code> de
la clase <code>controllers.CountController</code>.</p>
<h3 id="controllers">Controllers<a class="headerlink" href="#controllers" title="Permanent link">&para;</a></h3>
<p>El código a ejecutar cuando se realiza una petición HTTP se define en
métodos de clases que heredan de <code>Controller</code>. Se suelen colocar en el paquete
<code>controllers</code>. </p>
<p>Por ejemplo, en la clase <code>controllers.HomeController</code> se define el
método <code>index</code>.</p>
<p><strong>Fichero <code>app/controllers/HomeController.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="kd">extends</span> <span class="n">Controller</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * An action that renders an HTML page with a welcome message.</span>
<span class="cm">     * The configuration in the &lt;code&gt;routes&lt;/code&gt; file means that</span>
<span class="cm">     * this method will be called when the application receives a</span>
<span class="cm">     * &lt;code&gt;GET&lt;/code&gt; request with a path of &lt;code&gt;/&lt;/code&gt;.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">index</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="s">&quot;Your new application is ready.&quot;</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Los métodos de las clases <code>Controller</code> deben devolver un objeto
<code>Result</code> que representa la respuesta HTTP a la petición. En el caso
anterior se devuelve un OK (código HTTP 200) junto con el código HTML
resultante de renderizar la vista <code>index</code>.</p>
<h3 id="vistas">Vistas<a class="headerlink" href="#vistas" title="Permanent link">&para;</a></h3>
<p>Las páginas HTML que se devuelven se construyen mediante
<em>vistas</em>. Las vistas se definen mediante plantillas Scala definidas
en el directorio <code>views</code>. En la llamada a renderizar la vista se
pueden pasar parámetros cuyos valores se utilizan en la propia vista.</p>
<p>Por ejemplo, la vista anterior <code>index</code> se define en el fichero
<code>index.scala.html</code> situado en el directorio <code>views</code>.</p>
<p><strong>Fichero <code>views/index.scala.html</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@*
 * This template takes a single argument, a String containing a
 * message to display.
 *@
@(message: String)

@*
 * Call the `main` template with two arguments. The first
 * argument is a `String` with the title of the page, the second
 * argument is an `Html` object containing the body of the page.
 *@
@main(&quot;Welcome to Play&quot;) {

    @*
     * Get an `Html` object by calling the built-in Play welcome
     * template and passing a `String` message.
     *@
    @welcome(message, style = &quot;java&quot;)

}
</pre></div>
</td></tr></table>

<p>La vista recibe un parámetro <code>String</code>. En el cuerpo de la vista se
puede escribir código HTML, código Scala, y también llamar a otras
plantillas. Por ejemplo, en la vista anterior se llama a la plantilla
<code>main</code> que se define en el fichero <code>main.scala.html</code>, pasándole como
parámetro el código HTML generado por la plantilla <code>welcome</code>, definida
en el fichero <code>welcome.scala.html</code>.</p>
<p><strong>Fichero <code>views/main.scala.html</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@*
 * This template is called from the `index` template. This template
 * handles the rendering of the page header and body tags. It takes
 * two arguments, a `String` for the title of the page and an `Html`
 * object to insert into the body of the page.
 *@
@(title: String)(content: Html)

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        @* Here&#39;s where we render the page title `String`. *@
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>@title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">stylesheets</span><span class="err">/</span><span class="na">main</span><span class="err">.</span><span class="na">css</span><span class="err">&quot;)&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;image/png&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">images</span><span class="err">/</span><span class="na">favicon</span><span class="err">.</span><span class="na">png</span><span class="err">&quot;)&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">hello</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        @* And here&#39;s where we render the `Html` object containing
         * the page content. *@
        @content
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>views/welcome.scala.html</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@(message: String, style: String = &quot;java&quot;)

@defining(play.core.PlayVersion.current) { version =&gt;

    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/@@documentation/resources/style/main.css&quot;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;top&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;wrapper&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://playframework.com/documentation/@version/Home&quot;</span><span class="p">&gt;</span>@message<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;content&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;wrapper doc&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">article</span><span class="p">&gt;</span>

            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome to Play<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
                Congratulations, you’ve just created a new Play application. This page will help you with the next few steps.
            <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

            <span class="p">&lt;</span><span class="nt">blockquote</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
                    You’re using Play @version
                <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">blockquote</span><span class="p">&gt;</span>

    ...
}
</pre></div>
</td></tr></table>

<p>Para incorporar el valor del parámetro en la plantilla hay que
preceder el parámetro con <code>@</code>. En el ejemplo anterior se obtiene así
el mensaje, que se pinta en la parte superior de la página.</p>
<p>La página HTML resultante mostrada en el navegador es la siguiente:</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/vista-main.png" width="500px"/></p>
<p>La directiva <code>@defining</code> permite obtener un valor y
asignárselo a una variable que se utiliza en un bloque de código. En
el caso anterior se utiliza para obtener la versión de Play. Otro
ejemplo de su utilización es el que aparece en la documentación de
Play sobre plantillas:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@defining(user.getFirstName() + &quot; &quot; + user.getLastName()) { fullName =&gt;
  <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Hello @fullName<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
}
</pre></div>
</td></tr></table>

<h3 id="inyeccion-de-dependencias">Inyección de dependencias<a class="headerlink" href="#inyeccion-de-dependencias" title="Permanent link">&para;</a></h3>
<p>Play usa el framework Java de Google <a href=""><em>Guice</em></a> para realizar inyección
de dependencias.</p>
<p>La anotación <code>@Inject</code> hace que Play inyecte en la variable anotada un
objeto nuevo del tipo indicado por la variable. Se puede definir la
anotación en la variable o en el constructor de la clase. </p>
<p>Es posible definir <em>singletons</em> con la anotación <code>@Singleton</code>.</p>
<p>En la aplicación ejemplo se define un servicio y un controller para
implementar un contador que se incrementa en cada petición a la acción
<code>count</code>. En el controller se inyecta el componente <code>counter</code>:</p>
<p><strong>Fichero <code>controllers/CountController.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">play.mvc.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">services.Counter</span><span class="o">;</span>

<span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountController</span> <span class="kd">extends</span> <span class="n">Controller</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Counter</span> <span class="n">counter</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">CountController</span><span class="o">(</span><span class="n">Counter</span> <span class="n">counter</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">this</span><span class="o">.</span><span class="na">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * An action that responds with the {@link Counter}&#39;s current</span>
<span class="cm">     * count. The result is plain text. This action is mapped to</span>
<span class="cm">     * &lt;code&gt;GET&lt;/code&gt; requests with a path of &lt;code&gt;/count&lt;/code&gt;</span>
<span class="cm">     * requests by an entry in the &lt;code&gt;routes&lt;/code&gt; config file.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">count</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">nextCount</span><span class="o">()));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>El contador se define con una interfaz y una implementación
concreta. </p>
<p><strong>Fichero <code>services/Counter.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">services</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * This interface demonstrates how to create a component that is injected</span>
<span class="cm"> * into a controller. The interface represents a counter that returns a</span>
<span class="cm"> * incremented number each time it is called.</span>
<span class="cm"> *</span>
<span class="cm"> * The {@link Modules} class binds this interface to the</span>
<span class="cm"> * {@link AtomicCounter} implementation.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Counter</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">nextCount</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>services/AtomicCounter.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">services</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.*</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * This class is a concrete implementation of the {@link Counter} trait.</span>
<span class="cm"> * It is configured for Guice dependency injection in the {@link Module}</span>
<span class="cm"> * class.</span>
<span class="cm"> *</span>
<span class="cm"> * This class has a {@link Singleton} annotation because we need to make</span>
<span class="cm"> * sure we only use one counter per application. Without this</span>
<span class="cm"> * annotation we would get a new instance every time a {@link Counter} is</span>
<span class="cm"> * injected.</span>
<span class="cm"> */</span>
<span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicCounter</span> <span class="kd">implements</span> <span class="n">Counter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">atomicCounter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextCount</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">return</span> <span class="n">atomicCounter</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>La definición de la clase concreta que se inyecta se realiza en el
método <code>configure()</code> de una clase llamada <code>Module</code> que debe extender
<code>AbstractModule</code> y estar situada en el paquete raíz.</p>
<p><strong>Fichero <code>Module.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">com.google.inject.AbstractModule</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">services.AtomicCounter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">services.Counter</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * This class is a Guice module that tells Guice how to bind several</span>
<span class="cm"> * different types. This Guice module is created when the Play</span>
<span class="cm"> * application starts.</span>
<span class="cm"> *</span>
<span class="cm"> * Play will automatically use any class called `Module` that is in</span>
<span class="cm"> * the root package. You can create modules in other locations by</span>
<span class="cm"> * adding `play.modules.enabled` settings to the `application.conf`</span>
<span class="cm"> * configuration file.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Module</span> <span class="kd">extends</span> <span class="n">AbstractModule</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Set AtomicCounter as the implementation for Counter.</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">Counter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">AtomicCounter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<h3 id="tests">Tests<a class="headerlink" href="#tests" title="Permanent link">&para;</a></h3>
<p>Los tests se encuentran en el directorio <code>tests</code>. Se utiliza <code>JUnit</code>
como framework de testing.</p>
<p>Desde los tests se puede comprobar los distintos componentes de la
aplicación, incluyendo plantillas y peticiones a controllers.</p>
<h4>Lanzamiento de los tests desde sbt</h4>
<p>Para lanzar los tests desde la consola <code>sbt</code> se debe usar el comando
<code>test</code>. </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[play-java] $ test
[info] Updating {file:/code/}root...
[info] Resolving jline#jline;2.14.3 ...
[info] Done updating.
[info] Test run started
[info] Test ApplicationTest.simpleCheck started
[info] Test ApplicationTest.renderTemplate started
[info] Test run finished: 0 failed, 0 ignored, 2 total, 1.337s
[info] Test run started
[info] Test IntegrationTest.test started
[info] application - Creating Pool for datasource &#39;default&#39;
[info] application - ApplicationTimer demo: Starting application at 2018-08-21T07:41:46.226Z
[info] application - ApplicationTimer demo: Stopping application at 2018-08-21T07:41:52.807Z after 6s.
[info] application - Shutting down connection pool.
[info] Test run finished: 0 failed, 0 ignored, 1 total, 9.704s
[info] Passed: Total 3, Failed 0, Errors 0, Passed 3
[success] Total time: 37 s, completed Aug 21, 2018 7:41:53 AM
</pre></div>
</td></tr></table>

<p>Podemos lanzar una parte de los tests con el comando <code>testOnly</code>
seguido del nombre completo de la clase (incluyendo el paquete en el
que esté incluida):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[play-java] $ testOnly ApplicationTest
[info] Test run started
[info] Test ApplicationTest.simpleCheck started
[info] Test ApplicationTest.renderTemplate started
[info] Test run finished: 0 failed, 0 ignored, 2 total, 1.405s
[info] Passed: Total 2, Failed 0, Errors 0, Passed 2
[success] Total time: 12 s, completed Aug 21, 2018 9:58:57 AM
[play-java] $ 
</pre></div>
</td></tr></table>

<h4>Lanzamiento de los tests de IntelliJ</h4>
<p>También es posible lanzar los tests desde el entorno IntelliJ pulsando
con el botón derecho la opción <code>Run</code> sobre la clase de test
seleccionada.</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/tests-intellij.png" width="400px"/></p>
<h2 id="aplicacion-mads-todolist-inicial">Aplicación <code>mads-todolist-inicial</code><a class="headerlink" href="#aplicacion-mads-todolist-inicial" title="Permanent link">&para;</a></h2>
<p>La aplicación <code>mads-todolist-inicial</code> es una versión inicial de la
aplicación que se va a desarrollar durante todo el cuatrimestre en la
asignatura. </p>
<p>Es una aplicación bastante más compleja que la vista
anteriormente. Entre otros, tiene los siguientes elementos:</p>
<ul>
<li>Distintos comandos HTTP en el fichero de rutas: GET, POST, DELETE.</li>
<li>Recogida de datos en formularios HTML y validación de los datos.</li>
<li>Base de datos gestionada con JPA (<em>Java Persisence API</em>), un ORM (<em>Object Relational
  Mapping</em>) implementado por la librería Hibernate. Se utiliza una
  capa de persistencia basada en clases <em>repository</em>.</li>
<li><em>Capa de servicio</em> que proporciona la <strong>lógica de negocio</strong> a los
  controllers.</li>
<li>Las <em>clases controller</em> sólo se encargan de hacer de interfaz de la
  capa de servicio: <ul>
<li>Recoger datos de la petición HTTP,</li>
<li>tratar y validar estas entradas, </li>
<li>llamar a la clase de servicio para que se realice la acción
  requerida, y</li>
<li>convertir la respuesta obtenida de la aplicación en una vista
  que se devuelve como respuesta de la petición.</li>
</ul>
</li>
<li>En las plantillas se incluye <em>Bootstrap</em> y scripts JavaScript.</li>
<li>Las clases de servicio y de <em>repository</em> se obtienen por inyección
  de dependencias.</li>
<li>Gran número de tests que prueban sobre todo la capa de servicios.</li>
<li>Distintos ficheros de configuración para poder arrancar la
  aplicación en distintos entornos: desarrollo, integración y <em>stage</em>
  (similar a producción).</li>
</ul>
<p>A continuación se muestran dos de sus pantallas.</p>
<table>
<tr>
<td><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/login.png" width="700px"/></td>
</tr>
<tr>
<td align="center"> Pantalla de login </td>
</table>

<table>
<tr>
<td><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/tareas.png" width="700px"/></td>
</tr>
<tr>
<td align="center"> Pantalla con listado de tareas </td>
</table>

<h3 id="descarga-de-la-aplicacion-mads-todolist-inicial">Descarga de la aplicación <code>mads-todolist-inicial</code><a class="headerlink" href="#descarga-de-la-aplicacion-mads-todolist-inicial" title="Permanent link">&para;</a></h3>
<p>Se encuentra en GitHub:
<a href="https://github.com/domingogallardo/mads-todolist-inicial">https://github.com/domingogallardo/mads-todolist-inicial</a>. </p>
<p>Puedes descargarla con el comando <code>git clone</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ git clone https://github.com/domingogallardo/mads-todolist-inicial.git
</pre></div>
</td></tr></table>

<p>Se creará el directorio <code>mads-todolist-inicial</code> en el que se habrá
descargado la aplicación.</p>
<h3 id="importacion-en-intellj-idea">Importación en IntellJ IDEA<a class="headerlink" href="#importacion-en-intellj-idea" title="Permanent link">&para;</a></h3>
<p>Al importar la aplicación en IntelliJ IDEA aparece el aviso de que
se ha detectado el framework JPA y da la opción de configurarlo. La
configuración es sencilla, sólo hay que aceptar la localización del
fichero <code>persistence.xml</code> que nos muestra la ventana de diálogo.</p>
<p>Hablaremos más adelante de JPA.</p>
<h3 id="ejecucion-de-la-aplicacion-usando-la-base-de-datos-en-memoria">Ejecución de la aplicación usando la base de datos en memoria<a class="headerlink" href="#ejecucion-de-la-aplicacion-usando-la-base-de-datos-en-memoria" title="Permanent link">&para;</a></h3>
<p>Si ejecutamos la aplicación usando el comando <code>docker run</code> ya visto se
utilizará la base de datos H2 en memoria. Los datos almacenados en
ella sólo durarán mientras que está en marcha el contenedor.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --rm  -it -v &quot;${PWD}:/code&quot; -p 9000:9000 domingogallardo/playframework
</pre></div>
</td></tr></table>

<h3 id="base-de-datos-mysql-con-docker">Base de datos MySQL con Docker<a class="headerlink" href="#base-de-datos-mysql-con-docker" title="Permanent link">&para;</a></h3>
<p>Si queremos que los datos introducidos persistan a distintas
activaciones de la aplicación web debemos usar una base de datos
externa. Esto es necesario cuando la aplicación esté en producción,
pero también puede ser útil para realizar pruebas manuales en
desarrollo.</p>
<p>Podemos utilizar Docker para poner en marcha un servidor MySQL con el
siguiente comando:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -d -p 3316:3306 --name db-mysql -e MYSQL_ROOT_PASSWORD=mads -e MYSQL_DATABASE=mads mysql:5
</pre></div>
</td></tr></table>

<p>El comando pone en marcha un servidor MySQL escuchando en el puerto
3316 del host con el nombre docker <code>db-mysql</code>, con la contraseña de
root indicada y creando la base de datos <code>mads</code>.</p>
<p>El puerto del host 3316 se mapea con el puerto interno del
contenedor 3306. Ponemos el puerto 3316 para evitar posibles
conflictos con un posible servidor de MySQL que tengamos funcionando
en el host.</p>
<div class="admonition warning">
<p class="admonition-title">Cuidado</p>
<p>En los laboratorios de la EPS está instalada la imagen
5.7.18 de MySQL. Hay que definir explícitamente esa versión en el
comando docker, escribiendo <code>mysql:5.7.18</code>.</p>
</div>
<p>Podemos comprobar que el contenedor está funcionando con el comando
<code>docker container ls</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container ls
CONTAINER ID  IMAGE  COMMAND                  CREATED         STATUS         PORTS                  NAMES
7c1bed0b5b7e  mysql  &quot;docker-entrypoint...&quot;   6 seconds ago   Up 4 seconds   0.0.0.0:3316-&gt;3306/tcp db-mysql
</pre></div>
</td></tr></table>

<p>Para parar y volver a poner en marcha el contenedor mysql puedes usar
los comandos <code>docker stop &lt;container-id&gt;</code> y <code>docker start
&lt;container-id&gt;</code>. Los datos añadidos en la base de datos se mantendrán
mientras que el contenedor no se borre. El comando <code>docker container
ls</code> lista los contenedores en marcha, y con la opción <code>-a</code> también los
parados.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container ls
CONTAINER ID        IMAGE                CREATED             STATUS              PORTS                               NAMES
bd057639b6ac        mysql:5              30 minutes ago      Up 22 minutes       33060/tcp, 0.0.0.0:3316-&gt;3306/tcp   db-mysql
$ docker container stop bd057639b6ac
$ docker container ls -a
CONTAINER ID        IMAGE                CREATED             STATUS                     PORTS               NAMES
bd057639b6ac        mysql:5              31 minutes ago      Exited (0) 7 seconds ago                       db-mysql
$ docker container start bd057639b6ac
$ docker container ls
CONTAINER ID        IMAGE                CREATED             STATUS              PORTS                               NAMES
bd057639b6ac        mysql:5              32 minutes ago      Up 5 seconds        33060/tcp, 0.0.0.0:3316-&gt;3306/tcp   db-mysql
</pre></div>
</td></tr></table>

<p>Podemos usar el identificador o el nombre del contenedor para pararlo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker container stop db-mysql
</pre></div>
</td></tr></table>

<p>Para borrar un contenedor debe estar parado y debemos usar el comando</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker container rm &lt;container-id&gt; o &lt;container-name&gt;
</pre></div>
</td></tr></table>

<h3 id="ejecucion-de-la-aplicacion-usando-la-base-de-datos-mysql">Ejecución de la aplicación usando la base de datos MySQL<a class="headerlink" href="#ejecucion-de-la-aplicacion-usando-la-base-de-datos-mysql" title="Permanent link">&para;</a></h3>
<h4>Desde Docker</h4>
<p>Lanzamos la aplicación con Docker, definiendo en variables de entorno
la URL, el usuario y la contraseña con la que debe conectarse la
aplicación a la base de datos. Usamos la opción <code>link</code> de docker para
definir el nombre lógico del contenedor al que debe conectarse la
aplicación.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --link db-mysql --rm -it -p 9000:9000 -e \
DB_URL=&quot;jdbc:mysql://db-mysql:3306/mads&quot; -e DB_USER_NAME=&quot;root&quot; -e \
DB_USER_PASSWD=&quot;mads&quot; -v &quot;${PWD}:/code&quot; domingogallardo/playframework
</pre></div>
</td></tr></table>

<p>Y desde la consola sbt modificamos la preferencia <code>config.file</code> para
que la aplicación utilice la configuración definida en el fichero
<code>conf/develop-mysql.conf</code> (lo explicamos más adelante).</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[mads-todolist-2018] $ set javaOptions += &quot;-Dconfig.file=conf/develop-mysql.conf&quot;
[mads-todolist-2018] $ run
</pre></div>
</td></tr></table>

<h4>Desde el run/debug de IntelliJ</h4>
<p>También es posible definir una configuración de run/debug en IntelliJ
en la que se inicialice la preferencia <code>config.file</code> y las variables
de entorno para conectarse con la base de datos, en el puerto del host
en el que está escuchando (3331, si hemos lanzado el servicio de base
de datos usando Docker como hemos visto anteriormente):</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/bdexterna-intellij.png" width="600px"/></p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/variables-entorno-intellij.png" width="300px"/></p>
<div class="admonition warning">
<p class="admonition-title">Cuidado</p>
<p>Si estás lanzando MySQL usando <em>Docker Toolbox</em> debes
modificar la <code>DB_URL</code> indicando el <em>host</em> al que conectarse (no será
<em>localhost</em>). La dirección IP será la que aparece en la consola de
docker al arrancar. Por ejemplo <code>jdbd:mysql://192.168.99.100/mads</code>.</p>
</div>
<h3 id="panel-database-de-intellij">Panel <code>Database</code> de IntelliJ<a class="headerlink" href="#panel-database-de-intellij" title="Permanent link">&para;</a></h3>
<p>Desde el panel <code>Database</code> de IntelliJ (en la esquina superior derecha)
es posible crear una conexión a la base de datos que nos permitirá
verificar cómo se guardan los datos de la aplicación.</p>
<p>Hay que añadir una base de datos de tipo MySQL y configurarla con los
siguientes parámetros:</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/conexionbd-intellij.png" width="500px"/></p>
<div class="admonition warning">
<p class="admonition-title">Cuidado</p>
<p>Igual que en el apartado anterior, si estás lanzando
MySQL usando <em>Docker Toolbox</em> debes indicar el <em>host</em> al que
conectarse (no será <em>localhost</em>) escribiendo la dirección IP que
aparece en la consola de docker al arrancar. </p>
</div>
<p>Es posible examinar el esquema de la base de datos:</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/esquema-bd.png" width="300px"/></p>
<p>Y examinar tablas en concreto:</p>
<p><img src="https://raw.githubusercontent.com/domingogallardo/apuntes-mads/master/practicas/01-introduccion-play/imagenes/tablabd-intellij.png" width="300px"/></p>
<h3 id="configuracion-de-la-aplicacion">Configuración de la aplicación<a class="headerlink" href="#configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>Los distintos parámetros de la aplicación Play se configuran en
un fichero de propiedades. </p>
<h4>Configuración por defecto</h4>
<p>El fichero de configuración que carga la
aplicación por defecto es <code>conf/application.conf</code>.</p>
<p>Por ejemplo, las propiedades relacionadas con la definición de la base
de datos que se definen en el fichero son las siguientes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># Default persistenceUnit for JPA
jpa.default = develop

db {
  # You can declare as many datasources as you want.
  # By convention, the default datasource is named `default`

  # https://www.playframework.com/documentation/latest/Developing-with-the-H2-Database
  # Memory H2 database
  default.driver = org.h2.Driver
  default.url = &quot;jdbc:h2:mem:play;MODE=MYSQL&quot;
  #default.username = sa
  #default.password = &quot;&quot;
  # Definiemos el nombre JNDI de la BD que va a usar la aplicación
  default.jndiName=DBTodoList

  # You can turn on SQL logging for any datasource
  # https://www.playframework.com/documentation/latest/Highlights25#Logging-SQL-statements
  # default.logSql=true
}
</pre></div>
</td></tr></table>

<p>En el fichero por defecto se define una conexión con la base de datos
de memoria H2 en la fuente de datos llamada <code>default</code> (la fuente de
datos que usa por defecto la aplicación). Se definen las siguientes propiedades:</p>
<ul>
<li><code>jpa.default</code>: Nombre de la unidad de persistencia JPA que se usará en la aplicación.</li>
<li><code>db.default.driver</code>: Driver de la base de datos.</li>
<li><code>db.default.url</code>: URL de conexión a la base de datos.</li>
<li><code>db.default.jndiName</code>: Nombre lógico JNDI que se asigna a la base de datos.</li>
<li><code>db.default.logSql</code>: Si se descomenta se mostrará en la consola el log de todas las
  operaciones sobre la base de datos.</li>
</ul>
<h4>Otras configuraciones</h4>
<p>Como ya hemos visto, modificando la propiedad del sistema Java
<code>config.file</code> podemos definir un fichero de configuración distinto.</p>
<p>Se definen también los siguientes ficheros adicionales que se usarán
para lanzar la aplicación en distintas configuraciones:</p>
<ul>
<li><code>develop-mysql.conf</code>: configuración de desarrollo con base de datos
  externa. La aplicación trabaja sobre una base de datos MySQL externa cuyo
  esquema se actualiza automáticamente al modificar y añadir nuevas
  entidades a la aplicación.</li>
<li><code>production.conf</code>: configuración de producción. La aplicación
  trabaja sobre una base de datos MySQL externa, cuyo esquema es
  validado para que se corresponda con las entidades de la aplicación.</li>
</ul>
<p><strong>Fichero <code>conf/develop-mysql.conf</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>include &quot;application.conf&quot;

db.default.driver=com.mysql.jdbc.Driver
db.default.url=${?DB_URL}
db.default.username=${?DB_USER_NAME}
db.default.password=${?DB_USER_PASSWD}
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>conf/production.conf</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>include &quot;application.conf&quot;

play.crypto.secret=&quot;abcdefghijkl&quot;

jpa.default = production

db.default.driver=com.mysql.jdbc.Driver
db.default.url=${?DB_URL}
db.default.username=${?DB_USER_NAME}
db.default.password=${?DB_USER_PASSWD}
</pre></div>
</td></tr></table>

<p>Los dos ficheros de configuración incluyen el fichero
<code>application.conf</code> y después modifican las propiedades necesarias. Los
valores de los parámetros de configuración de la base de datos <code>url</code>,
<code>username</code> y <code>password</code> se obtienen de las variables de entorno.</p>
<h3 id="gestion-de-persistencia-con-jpa">Gestión de persistencia con JPA<a class="headerlink" href="#gestion-de-persistencia-con-jpa" title="Permanent link">&para;</a></h3>
<p>Para la gestión de la persistencia de los datos en una aplicación Play
usaremos JPA (<em>Java Persistence API</em>), en concreto la implementación
5.2.5 de Hibernate.</p>
<h4>Definición del modelo de datos</h4>
<p>El framework JPA permite definir el esquema de la base de datos usando
anotaciones en las clases denominadas de entidad. Para cada clase de
entidad se define una tabla en la base de datos, con columnas que se
mapean con sus atributos.</p>
<p>Por ejemplo, la clase <code>Usuario</code> define una tabla <code>Usuario</code> en la base
de datos. Los distintos atributos (<code>login</code>, <code>email</code>, ...) se
corresponden con las columnas de la tabla. </p>
<p>El atributo <code>id</code> se corresponde con la clave primaria de la tabla. JPA
define varias estrategias para obtener esa clave primera, y se ha
escogido la estrategia <code>AUTO</code>. Cuando un usuario creado en memoria se haga
persistente en la base de datos, este atributo se actualizará con el
valor obtenido por Hibernate. La estrategia <code>AUTO</code> se basa en obtener
el valor de la clave primaria usando una tabla auxiliar
<code>hibernate_sequence</code> que guarda el siguiente valor a asignar a una
nueva clave primaria.</p>
<p>Además de los atributos, en la clase se define un constructor con los
atributos obligatorios para definir un usuario, unos <em>getters</em> y
<em>setters</em> y los métodos <code>equals</code> y <code>hashCode</code> para comparar usuarios.</p>
<p><strong>Fichero <code>models/Usuario.java</code>:</strong></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Usuario</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">login</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nombre</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">apellidos</span><span class="o">;</span>
    <span class="nd">@Temporal</span><span class="o">(</span><span class="n">TemporalType</span><span class="o">.</span><span class="na">DATE</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">fechaNacimiento</span><span class="o">;</span>
    <span class="c1">// Relación uno-a-muchos entre usuario y tarea</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usuario&quot;</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Tarea</span><span class="o">&gt;</span> <span class="n">tareas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usuarios&quot;</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// Un constructor vacío necesario para JPA</span>
    <span class="kd">public</span> <span class="nf">Usuario</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="c1">// El constructor principal con los campos obligatorios</span>
    <span class="kd">public</span> <span class="nf">Usuario</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">login</span> <span class="o">=</span> <span class="n">login</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Getters y setters necesarios para JPA</span>
    <span class="o">...</span>

    <span class="c1">// Función para imprimr los datos de un usuario</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">fechaStr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fechaNacimiento</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SimpleDateFormat</span> <span class="n">formateador</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;dd-MM-yyyy&quot;</span><span class="o">);</span>
            <span class="n">fechaStr</span> <span class="o">=</span> <span class="n">formateador</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">fechaNacimiento</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Usuario id: %s login: %s password: %s nombre: %s &quot;</span> <span class="o">+</span>
                        <span class="s">&quot;apellidos: %s e-mail: %s fechaNacimiento: %s&quot;</span><span class="o">,</span>
                <span class="n">id</span><span class="o">,</span> <span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">nombre</span><span class="o">,</span> <span class="n">apellidos</span><span class="o">,</span> <span class="n">email</span><span class="o">,</span> <span class="n">fechaNacimiento</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="c1">// Funciones hashCode y equals para poder comparar usuarios y</span>
    <span class="c1">// necesarias para poder crear un Set de usuarios</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Devolvemos el hash de los campos obligatorios</span>
        <span class="k">return</span> <span class="n">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">login</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Si el usuario tiene un ID (se ha obtenido de la BD)</span>
    <span class="c1">// la comparación se basa en ese ID. Si el ID no existe (el usuario</span>
    <span class="c1">// se ha creado en memoria y todavía no se ha sincronizado con la BD)</span>
    <span class="c1">// la comparación se basa en los atributos obligatorios.</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">Usuario</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">Usuario</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">other</span><span class="o">.</span><span class="na">id</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Si tenemos los ID, comparamos por ID</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
        <span class="o">}</span>
            <span class="c1">// sino comparamos por campos obligatorios</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">login</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">login</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">login</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">login</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">email</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">email</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">email</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">email</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>En la definición de la entidad también se incluyen relaciones con
otras entidades. En este caso un <code>Usuario</code> tiene muchas <code>Tarea</code>s (una
relación una-a-muchos) y puede participar en <code>Equipo</code>s (relación
muchos-a-muchos). </p>
<p>La relación uno-a-muchos se representa en la base de datos con una
clave ajena. El atributo <code>mappedBy</code> indica que la clave ajena se va a
guardar en la columna correspondiente con el atributo <code>usuario</code> de la
entidad <code>Tarea</code>.</p>
<p>La relación muchos-a-muchos se representa en la base de datos con una
tabla auxiliar con dos claves ajenas. El atributo <code>mappedBy</code> indica
que la definición de esa tabla se encuentra en el atributo <code>usuario</code>
de la entidad <code>Equipo</code>.</p>
<p>Las definiciones de <code>Tarea</code> y <code>Equipo</code> son las siguientes:</p>
<p><strong>Fichero <code>models/Tarea.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tarea</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">titulo</span><span class="o">;</span>
    <span class="c1">// Relación muchos-a-uno entre tareas y usuario</span>
    <span class="nd">@ManyToOne</span>
    <span class="c1">// Nombre de la columna en la BD que guarda físicamente</span>
    <span class="c1">// el ID del usuario con el que está asociado una tarea</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;usuarioId&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Usuario</span> <span class="n">usuario</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Tarea</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="c1">// Constructor, getters y setters, equals y hashCode</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>models/Equipo.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Equipo</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nombre</span><span class="o">;</span>
    <span class="nd">@ManyToMany</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Equipo_Usuario&quot;</span><span class="o">,</span>
        <span class="n">joinColumns</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fk_equipo&quot;</span><span class="o">)</span> <span class="o">},</span>
        <span class="n">inverseJoinColumns</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fk_usuario&quot;</span><span class="o">)})</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// Un constructor vacío necesario para JPA</span>
    <span class="kd">public</span> <span class="nf">Equipo</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="c1">// Constructor, getters y setters, equals y hashCode</span>

    <span class="c1">// Métodos de actualización de la relación muchos-a-muchos con usuario</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUsuario</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usuarios</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
        <span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeUsuario</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">usuarios</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
        <span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table>

<h4>Fichero de configuración de JPA</h4>
<p>El fichero <code>conf/META-INF/persistence.xml</code> es necesario para que JPA
funcione correctamente. Es el fichero de configuración en el que se
definen distintos elementos necesarios para la configuración de JPA.</p>
<ul>
<li>Nombre JNDI de la fuente de datos con la que se conectará la
  aplicación: <code>DBTodoList</code>, definida en el fichero de configuración de
  la aplicación Play (<code>/conf/application.conf</code>).</li>
<li>Clases entidad que se definen en la aplicación.</li>
<li>Propiedad <code>hibernate.hbm2ddl.auto</code> que indica cómo JPA va a
  gestionar las tablas en la base de datos.<ul>
<li>Si el valor es <code>update</code>, al arrancar la aplicación las tablas de
  la base de datos se actualizan (o se crean, si la base de datos
  está vacía) para que se correspondan con las entidades. Se suele
  utilizar este valor cuando estamos desarrollando la aplicación.</li>
<li>Si el valor es <code>validate</code>, al arrancar la aplicación se
  comprueba si la base de datos contiene tablas que se
  corresponden con las definiciones de las entidades. Si no es
  así, JPA lanza una excepción y deja de funcionar. Se suele
  utilizar este valor en el funcionamiento de la aplicación en
  producción.</li>
</ul>
</li>
</ul>
<p>Definimos dos configuraciones, una denominada <code>develop</code> y otra
denominada <code>production</code>. La única diferencia entre ellas es el valor
de la propiedad <code>hibernate.hbm2ddl.auto</code>.</p>
<p><strong>Fichero <code>conf/META-INF/persistence.xml</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">&lt;persistence</span> <span class="na">xmlns=</span><span class="s">&quot;http://xmlns.jcp.org/xml/ns/persistence&quot;</span>
   <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
   <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd&quot;</span>
   <span class="na">version=</span><span class="s">&quot;2.1&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- MySQL Persistence Unit - Develop: hbm2ddl.auto = UPDATE --&gt;</span>

<span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;develop&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;RESOURCE_LOCAL&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="nt">&lt;/provider&gt;</span>
   <span class="nt">&lt;non-jta-data-source&gt;</span>DBTodoList<span class="nt">&lt;/non-jta-data-source&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Usuario<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Tarea<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Equipo<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.dialect&quot;</span> <span class="na">value=</span><span class="s">&quot;org.hibernate.dialect.MySQL5Dialect&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;update&quot;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;/persistence-unit&gt;</span>

<span class="c">&lt;!-- MySQL Persistence Unit - Production: hbm2ddl.auto = VALIDATE --&gt;</span>

<span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;production&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;RESOURCE_LOCAL&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;provider&gt;</span>org.hibernate.jpa.HibernatePersistenceProvider<span class="nt">&lt;/provider&gt;</span>
   <span class="nt">&lt;non-jta-data-source&gt;</span>DBTodoList<span class="nt">&lt;/non-jta-data-source&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Usuario<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Tarea<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;class&gt;</span>models.Equipo<span class="nt">&lt;/class&gt;</span>
   <span class="nt">&lt;properties&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.dialect&quot;</span> <span class="na">value=</span><span class="s">&quot;org.hibernate.dialect.MySQL5Dialect&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;hibernate.hbm2ddl.auto&quot;</span> <span class="na">value=</span><span class="s">&quot;validate&quot;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;/properties&gt;</span>
<span class="nt">&lt;/persistence-unit&gt;</span>
<span class="nt">&lt;/persistence&gt;</span>
</pre></div>
</td></tr></table>

<h4>Actualización de los datos</h4>
<p>Se definen clases <em>repository</em> que definen métodos para actualizar las
entidades y realizar <em>queries</em> sobre ellas. Para dejar abierta la
posibilidad de cambiar la implementación, se definen con interfaces.</p>
<p><strong>Fichero <code>models/UsuarioRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UsuarioRepository</span> <span class="o">{</span>
    <span class="n">Usuario</span> <span class="nf">add</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">);</span>

    <span class="c1">// Queries</span>
    <span class="n">Usuario</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
    <span class="n">Usuario</span> <span class="nf">findByLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>models/TareaRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TareaRepository</span> <span class="o">{</span>
    <span class="n">Tarea</span> <span class="nf">add</span><span class="o">(</span><span class="n">Tarea</span> <span class="n">tarea</span><span class="o">);</span>
    <span class="n">Tarea</span> <span class="nf">update</span><span class="o">(</span><span class="n">Tarea</span> <span class="n">tarea</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Tarea</span> <span class="n">tarea</span><span class="o">);</span>

    <span class="c1">// Queries</span>
    <span class="n">Tarea</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Long</span> <span class="n">idTarea</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>models/EquipoRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EquipoRepository</span> <span class="o">{</span>
    <span class="n">Equipo</span> <span class="nf">add</span><span class="o">(</span><span class="n">Equipo</span> <span class="n">equipo</span><span class="o">);</span>
    <span class="n">Equipo</span> <span class="nf">update</span><span class="o">(</span><span class="n">Equipo</span> <span class="n">equipo</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Equipo</span> <span class="n">equipo</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">addUsuarioEquipo</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">,</span> <span class="n">Equipo</span> <span class="n">equipo</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">deleteUsuarioEquipo</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">,</span> <span class="n">Equipo</span> <span class="n">equipo</span><span class="o">);</span>

    <span class="c1">// Queries</span>
    <span class="n">Equipo</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Long</span> <span class="n">idEquipo</span><span class="o">);</span>
    <span class="n">Equipo</span> <span class="nf">findByNombre</span><span class="o">(</span><span class="n">String</span> <span class="n">nombre</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="nf">findUsuariosEquipo</span><span class="o">(</span><span class="n">String</span> <span class="n">nombreEquipo</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>La implementación utiliza JPA para realizar las actualizaciones y
consultas sobre las entidades. Cada método abre y cierra una
transacción en la que se propaga el cambio a la base de datos. </p>
<p>Para trabajar con JPA en Play se debe usar un objeto <code>JPAApi</code> que se
obtiene por inyección de dependencias. Play guarda en la variable
<code>jpaApi</code> una instancia con la que podemos, entre otras cosas, abrir y
cerrar transacciones.</p>
<p>Por ejemplo, la implementación de la parte de la interfaz
<code>EquipoRepository</code> que trata de la actualización de la entidad en la
base de datos es la siguiente:</p>
<p><strong>Fichero <code>models/JPAEquipoRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JPAEquipoRepository</span> <span class="kd">implements</span> <span class="n">EquipoRepository</span> <span class="o">{</span>
    <span class="n">JPAApi</span> <span class="n">jpaApi</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">JPAEquipoRepository</span><span class="o">(</span><span class="n">JPAApi</span> <span class="n">api</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jpaApi</span> <span class="o">=</span> <span class="n">api</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">add</span><span class="o">(</span><span class="n">Equipo</span> <span class="n">equipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">entityManager</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
            <span class="n">entityManager</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="n">entityManager</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">equipo</span><span class="o">;</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">update</span><span class="o">(</span><span class="n">Equipo</span> <span class="n">equipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Equipo</span> <span class="n">equipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">em</span><span class="o">();</span>
            <span class="n">Equipo</span> <span class="n">equipoBD</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Equipo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">entityManager</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">equipoBD</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUsuarioEquipo</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">,</span> <span class="n">Equipo</span> <span class="n">equipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">em</span><span class="o">();</span>
            <span class="n">Equipo</span> <span class="n">equipoBD</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
            <span class="n">Usuario</span> <span class="n">usuarioBD</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
            <span class="n">equipoBD</span><span class="o">.</span><span class="na">addUsuario</span><span class="o">(</span><span class="n">usuarioBD</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUsuarioEquipo</span><span class="o">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="o">,</span> <span class="n">Equipo</span> <span class="n">equipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">EntityManager</span> <span class="n">entityManager</span> <span class="o">=</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">em</span><span class="o">();</span>
            <span class="n">Equipo</span> <span class="n">equipoBD</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
            <span class="n">Usuario</span> <span class="n">usuarioBD</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
            <span class="n">equipoBD</span><span class="o">.</span><span class="na">removeUsuario</span><span class="o">(</span><span class="n">usuarioBD</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Todos los métodos trabajan con un <code>EntityManager</code>, que es la clase de
JPA que gestiona las actualizaciones y <em>queries</em> sobre la base de
datos.</p>
<p>Y las <em>queries</em> se implementan de la siguiente manera:</p>
<p><strong>Fichero <code>models/JPAEquipoRepository.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Long</span> <span class="n">idEquipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Equipo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">idEquipo</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">findByNombre</span><span class="o">(</span><span class="n">String</span> <span class="n">nombre</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                    <span class="s">&quot;select e from Equipo e where e.nombre = :nombre&quot;</span><span class="o">,</span> <span class="n">Equipo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;nombre&quot;</span><span class="o">,</span> <span class="n">nombre</span><span class="o">).</span><span class="na">getSingleResult</span><span class="o">();</span>
                <span class="k">return</span> <span class="n">equipo</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoResultException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                    <span class="s">&quot;select e from Equipo e&quot;</span><span class="o">,</span> <span class="n">Equipo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="nf">findUsuariosEquipo</span><span class="o">(</span><span class="n">String</span> <span class="n">nombreEquipo</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                    <span class="s">&quot;select u from Usuario u join u.equipos e where e.nombre = :nombreEquipo&quot;</span><span class="o">,</span> <span class="n">Usuario</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;nombreEquipo&quot;</span><span class="o">,</span> <span class="n">nombreEquipo</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoResultException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h4>Recuperación <em>eager</em> y <em>lazy</em> de las colecciones</h4>
<p>En la aplicación se definen relaciones <em>a-muchos</em> entre las
entidades:</p>
<ul>
<li>Relación <em>uno-a-muchos</em> entre usuarios y tareas: un usuario tiene muchas tareas</li>
<li>Relación <em>muchos-a-muchos</em> entre usuarios y equipos: un equipo tiene
  muchos usuarios y un usuario participa en varios equipos.</li>
</ul>
<p>En las entidades estas relaciones se definen de la siguiente forma:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Usuario</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// Relación uno-a-muchos entre usuario y tarea</span>
    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usuario&quot;</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Tarea</span><span class="o">&gt;</span> <span class="n">tareas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="nd">@ManyToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">&quot;usuarios&quot;</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tarea</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// Relación muchos-a-uno entre tareas y usuario</span>
    <span class="nd">@ManyToOne</span>
    <span class="c1">// Nombre de la columna en la BD que guarda físicamente</span>
    <span class="c1">// el ID del usuario con el que está asociado una tarea</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;usuarioId&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Usuario</span> <span class="n">usuario</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Equipo</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@ManyToMany</span>
    <span class="nd">@JoinTable</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Equipo_Usuario&quot;</span><span class="o">,</span>
        <span class="n">joinColumns</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fk_equipo&quot;</span><span class="o">)</span> <span class="o">},</span>
        <span class="n">inverseJoinColumns</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fk_usuario&quot;</span><span class="o">)})</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Relaciones <em>lazy</em></strong></p>
<p>Por defecto, todas las relaciones <em>a-muchos</em> en JPA se definen de
tipo <code>LAZY</code>. </p>
<p>La característica de los atributos marcados como <em>lazy</em> en JPA es que
no se traen a memoria cuando se recupera la entidad, sino cuando se
consultan. Por ejemplo, en el caso de equipos y usuarios, la lista de
usuarios de un equipo es un atributo <em>lazy</em>. Veamos el método
<code>findById</code> de un equipo que devuelve una entidad <code>Equipo</code> a partir de
su identificador:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">findById</span><span class="o">(</span><span class="n">Long</span> <span class="n">idEquipo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Equipo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">idEquipo</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>El método <code>jpaApi.withTransaction</code> abre y cierra una conexión con la base de
datos que es gestionada por el <em>entity manager</em>. La conexión está
abierta mientras se ejecuta el código dentro del <code>withTransaction</code> (la
llamada a <code>find</code> que recupera el equipo). Pero cuando se hace el
<code>return</code> esa conexión se cierra y se devuelve un equipo cuya lista de
usuarios no se ha cargado a memoria. </p>
<p>Si intentamos acceder a una colección <em>lazy</em> sin estar en el ámbito
del <em>entity manager</em> se producirá un error porque no se puede
inicializar esa colección. Por ejemplo, el siguiente test produce un
error cuando se llama al método <code>size()</code> y se intenta contar los
elementos de la conexión <em>lazy</em>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">errorLazy</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1005L</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
<span class="o">}</span>

<span class="c1">// Se produce el siguiente error:</span>
<span class="c1">// Test models.EquipoTest.errorLazy failed:</span>
<span class="c1">// org.hibernate.LazyInitializationException: failed to lazily initialize a collection </span>
<span class="c1">// of role: models.Equipo.usuarios, could not initialize proxy - no Session</span>
</pre></div>
</td></tr></table>

<p>¿Cómo podemos solucionar esto? La clave es que sólo podremos recuperar
una colección <em>lazy</em> <strong>estando en un <em>entity manager</em>
abierto</strong>. </p>
<p>Por ejemplo, podemos hacer un método específico que devuelve la
colección de usuarios de un equipo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Versión en la que se obtienen los usuarios accediendo a la colección lazy</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="nf">findUsuariosEquipo</span><span class="o">(</span><span class="n">Long</span> <span class="n">idEquipo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Equipo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">idEquipo</span><span class="o">);</span>
        <span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getUsuarios</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">usuarios</span><span class="o">;</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>La llamada a <code>size()</code> en la línea 5 accede a la colección estando el
<em>entity manager</em> abierto y trae a memoria sus elementos de la base de
datos. Por ello la colección de usuarios que se devuelve ya contiene
todos los usuarios del equipo.</p>
<p>Otra forma de recuperar colecciones <em>lazy</em> es haciendo directamente
una query:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// Versión en la que obtienen los usuarios mediante una query</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="nf">findUsuariosEquipo</span><span class="o">(</span><span class="n">Long</span> <span class="n">idEquipo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">jpaApi</span><span class="o">.</span><span class="na">withTransaction</span><span class="o">(</span><span class="n">entityManager</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
                <span class="s">&quot;select u from Usuario u join u.equipos e where e.id = :idEquipo&quot;</span><span class="o">,</span> <span class="n">Usuario</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;idEquipo&quot;</span><span class="o">,</span> <span class="n">idEquipo</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoResultException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Relaciones <em>eager</em></strong></p>
<p>Frente a la recuperación <em>lazy</em> de colecciones, también existe la
posibilidad de definir una colección como de tipo <em>EAGER</em>. En este
caso JPA se traerá siempre a memoria todos los elementos. Es el caso
de la relación entre un usuario y sus tareas.</p>
<p>En general, no es conveniente definir una relación como <em>eager</em> porque
puede provocar problemas de rendimiento en el caso en que haya muchos
elementos relacionados. </p>
<p>Pero si no hay muchos datos en la relación y los vamos a usar con
frecuencia, sí que es aconsejable usar el tipo <em>EAGER</em> para facilitar
el manejo de la entidad.</p>
<h3 id="servicios">Servicios<a class="headerlink" href="#servicios" title="Permanent link">&para;</a></h3>
<p>La capa de servicios es la capa intermedia entre la capa de
<em>controllers</em> y la de <em>repository</em>. Es la capa que implementa toda la
lógica de negocio de la aplicación.</p>
<p>La responsabilidad principal de la capa de servicios es obtener o
crear los objetos entidad necesarios para cada funcionalidad a partir
de los datos que manda la capa <em>controller</em>, trabajar con ellos en
memoria y hacer persistentes los cambios utilizando la capa
<em>repository</em>.</p>
<p>La capa de servicios también gestionará errores y lanzará excepciones
cuando no se pueda realizar alguna funcionalidad.</p>
<p>Los servicios obtienen instancias de <em>Repository</em> usando inyección de
dependencias.</p>
<p><strong>Ventajas de utilizar una capa de servicios</strong></p>
<p>Al utilizar clases de servicios podemos aislar la lógica de negocio de
la aplicación usando métodos y objetos Java, sin preocuparnos de cómo
obtener los datos de la interfaz de usuario ni de cómo mostrar los
resultados. De esto ya se ocuparán las clases <em>controller</em>. De esta
forma, si se necesita modificar la interfaz de usuario de la
aplicación, o convertirla en un servicio REST que devuelva JSON en
lugar de HTML sólo tendremos que tocar las clases <em>controller</em>, no las
de servicio.</p>
<p>Además, al no tener ninguna dependencia con la interfaz de usuario,
estas clases de servicios también podrán ser fácilmente testeadas. La
mayoría de los tests automáticos los haremos sobre ellas.</p>
<p><strong>Fichero <code>services/UsuarioService.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsuarioService</span> <span class="o">{</span>
    <span class="n">UsuarioRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="c1">// Play proporcionará automáticamente el UsuarioRepository necesario</span>
    <span class="c1">// usando inyección de dependencias</span>
    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">UsuarioService</span><span class="o">(</span><span class="n">UsuarioRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repository</span> <span class="o">=</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Usuario</span> <span class="nf">creaUsuario</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">repository</span><span class="o">.</span><span class="na">findByLogin</span><span class="o">(</span><span class="n">login</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UsuarioServiceException</span><span class="o">(</span><span class="s">&quot;Login ya existente&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Usuario</span><span class="o">(</span><span class="n">login</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
        <span class="n">usuario</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">usuario</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Usuario</span> <span class="nf">findUsuarioPorLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findByLogin</span><span class="o">(</span><span class="n">login</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Usuario</span> <span class="nf">findUsuarioPorId</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Usuario</span> <span class="nf">login</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findByLogin</span><span class="o">(</span><span class="n">login</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">usuario</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">usuario</span><span class="o">.</span><span class="na">getPassword</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">password</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">usuario</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>services/UsuarioServiceException.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsuarioServiceException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">UsuarioServiceException</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UsuarioServiceException</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h3 id="controllers_1">Controllers<a class="headerlink" href="#controllers_1" title="Permanent link">&para;</a></h3>
<p>Las clases <em>controllers</em> son las que gestionan la interfaz de usuario
de la aplicación. Se encargan de recibir los datos de las peticiones
HTTP, llamar a la clase de servicio necesaria para procesar la lógica
de negocio y mostrar la vista con la información resultante
proporcionada por la clase de servicio.</p>
<p>En la aplicación se definen tres clases controller:</p>
<ul>
<li><code>UsuarioController</code>: con métodos para registrar y logear usuarios.</li>
<li><code>TareasController</code>: con métodos para crear, borrar y modificar
  tareas de un usuario.</li>
<li><code>EquipoController</code>: con métodos para crear, añadir usuarios y listar equipos.</li>
</ul>
<p>Por ejemplo, la clase <code>EquipoController</code> define las acciones
relacionadas con crear equipos de usuarios.</p>
<p>En este controlador se obtienen los datos del formulario de la
petición HTTP usando un <code>DynamicForm</code> que contiene todos los valores
(Strings) asociados a los datos del formulario. </p>
<p>También es posible realizar un <em>mapping</em> automático entre los datos de
un formulario y un objeto Java usando un objeto <code>Form</code>. En el
<code>UsuarioController</code> se puede ver un ejemplo que usa las clases <code>Login</code>
y <code>Registro</code>. En este caso es posible definir restricciones en los
atributos y realizar una validación en el servidor.</p>
<p><strong>Fichero <code>controllers/EquipoController.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">controllers</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoController</span> <span class="kd">extends</span> <span class="n">Controller</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">FormFactory</span> <span class="n">formFactory</span><span class="o">;</span>
    <span class="nd">@Inject</span>
    <span class="n">EquipoService</span> <span class="n">equipoService</span><span class="o">;</span>

    <span class="nd">@Security.Authenticated</span><span class="o">(</span><span class="n">ActionAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">formularioNuevoEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">formNuevoEquipo</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Security.Authenticated</span><span class="o">(</span><span class="n">ActionAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">creaNuevoEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DynamicForm</span> <span class="n">requestData</span> <span class="o">=</span> <span class="n">formFactory</span><span class="o">.</span><span class="na">form</span><span class="o">().</span><span class="na">bindFromRequest</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">nombre</span> <span class="o">=</span> <span class="n">requestData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;nombre&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nombre</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">nombre</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">badRequest</span><span class="o">(</span><span class="n">formNuevoEquipo</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="s">&quot;Debes rellenar el nombre&quot;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">equipoService</span><span class="o">.</span><span class="na">addEquipo</span><span class="o">(</span><span class="n">nombre</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="s">&quot;Equipo &quot;</span> <span class="o">+</span> <span class="n">nombre</span> <span class="o">+</span> <span class="s">&quot; añadido correctamente&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">listaEquipos</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">allEquipos</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">listaEquipos</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">equipos</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Security.Authenticated</span><span class="o">(</span><span class="n">ActionAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">formularioAddUsuarioEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">formEquipoUsuario</span><span class="o">.</span><span class="na">render</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Security.Authenticated</span><span class="o">(</span><span class="n">ActionAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">addUsuarioEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DynamicForm</span> <span class="n">requestData</span> <span class="o">=</span> <span class="n">formFactory</span><span class="o">.</span><span class="na">form</span><span class="o">().</span><span class="na">bindFromRequest</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">requestData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;equipo&quot;</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">requestData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;usuario&quot;</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">equipoService</span><span class="o">.</span><span class="na">addUsuarioEquipo</span><span class="o">(</span><span class="n">usuario</span><span class="o">,</span> <span class="n">equipo</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="s">&quot;Usuario &quot;</span> <span class="o">+</span> <span class="n">usuario</span> <span class="o">+</span> <span class="s">&quot; añadido al equipo &quot;</span> <span class="o">+</span> <span class="n">equipo</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EquipoServiceException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">notFound</span><span class="o">(</span><span class="s">&quot;No existe usuario / equipo&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>La clase <code>UsuarioController</code> se encarga de las acciones de registro y login.</p>
<p><strong>Fichero <code>controllers/UsuarioController.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">controllers</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsuarioController</span> <span class="kd">extends</span> <span class="n">Controller</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">FormFactory</span> <span class="n">formFactory</span><span class="o">;</span>
    <span class="c1">// Play injecta un usuarioService junto con todas las dependencias necesarias:</span>
    <span class="c1">// UsuarioRepository y JPAApi</span>
    <span class="nd">@Inject</span>
    <span class="n">UsuarioService</span> <span class="n">usuarioService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">saludo</span><span class="o">(</span><span class="n">String</span> <span class="n">mensaje</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">saludo</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="s">&quot;El mensaje que he recibido es: &quot;</span> <span class="o">+</span> <span class="n">mensaje</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">formularioRegistro</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">formRegistro</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">formFactory</span><span class="o">.</span><span class="na">form</span><span class="o">(</span><span class="n">Registro</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">&quot;&quot;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">registroUsuario</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Form</span><span class="o">&lt;</span><span class="n">Registro</span><span class="o">&gt;</span> <span class="n">form</span> <span class="o">=</span> <span class="n">formFactory</span><span class="o">.</span><span class="na">form</span><span class="o">(</span><span class="n">Registro</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">bindFromRequest</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">badRequest</span><span class="o">(</span><span class="n">formRegistro</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="s">&quot;Hay errores en el formulario&quot;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">Registro</span> <span class="n">datosRegistro</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">usuarioService</span><span class="o">.</span><span class="na">findUsuarioPorLogin</span><span class="o">(</span><span class="n">datosRegistro</span><span class="o">.</span><span class="na">login</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">badRequest</span><span class="o">(</span><span class="n">formRegistro</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="s">&quot;Login ya existente: escoge otro&quot;</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">datosRegistro</span><span class="o">.</span><span class="na">password</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">datosRegistro</span><span class="o">.</span><span class="na">confirmacion</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">badRequest</span><span class="o">(</span><span class="n">formRegistro</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="s">&quot;No coinciden la contraseña y la confirmación&quot;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">creaUsuario</span><span class="o">(</span><span class="n">datosRegistro</span><span class="o">.</span><span class="na">login</span><span class="o">,</span> <span class="n">datosRegistro</span><span class="o">.</span><span class="na">email</span><span class="o">,</span> <span class="n">datosRegistro</span><span class="o">.</span><span class="na">password</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="o">(</span><span class="n">controllers</span><span class="o">.</span><span class="na">routes</span><span class="o">.</span><span class="na">UsuarioController</span><span class="o">.</span><span class="na">formularioLogin</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">formularioLogin</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">formLogin</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">formFactory</span><span class="o">.</span><span class="na">form</span><span class="o">(</span><span class="n">Login</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">&quot;&quot;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">loginUsuario</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Form</span><span class="o">&lt;</span><span class="n">Login</span><span class="o">&gt;</span> <span class="n">form</span> <span class="o">=</span> <span class="n">formFactory</span><span class="o">.</span><span class="na">form</span><span class="o">(</span><span class="n">Login</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">bindFromRequest</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">badRequest</span><span class="o">(</span><span class="n">formLogin</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="s">&quot;Hay errores en el formulario&quot;</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">Login</span> <span class="n">login</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">login</span><span class="o">.</span><span class="na">username</span><span class="o">,</span> <span class="n">login</span><span class="o">.</span><span class="na">password</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">usuario</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">notFound</span><span class="o">(</span><span class="n">formLogin</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">form</span><span class="o">,</span> <span class="s">&quot;Login y contraseña no existentes&quot;</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Añadimos el id del usuario a la clave `connected` de</span>
            <span class="c1">// la sesión de Play</span>
            <span class="c1">// https://www.playframework.com/documentation/2.5.x/JavaSessionFlash</span>
            <span class="c1">// Esa clave es la usada en la autenticación</span>
            <span class="n">session</span><span class="o">(</span><span class="s">&quot;connected&quot;</span><span class="o">,</span> <span class="n">usuario</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="o">(</span><span class="n">controllers</span><span class="o">.</span><span class="na">routes</span><span class="o">.</span><span class="na">TareasController</span><span class="o">.</span><span class="na">listaTareas</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Comprobamos si hay alguien logeado con @Security.Authenticated(ActionAuthenticator.class)</span>
    <span class="c1">// https://alexgaribay.com/2014/06/15/authentication-in-play-framework-using-java/</span>
    <span class="nd">@Security.Authenticated</span><span class="o">(</span><span class="n">ActionAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">logout</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">session</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="s">&quot;connected&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="o">(</span><span class="n">controllers</span><span class="o">.</span><span class="na">routes</span><span class="o">.</span><span class="na">UsuarioController</span><span class="o">.</span><span class="na">loginUsuario</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Security.Authenticated</span><span class="o">(</span><span class="n">ActionAuthenticator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">detalleUsuario</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">connectedUserStr</span> <span class="o">=</span> <span class="n">session</span><span class="o">(</span><span class="s">&quot;connected&quot;</span><span class="o">);</span>
        <span class="n">Long</span> <span class="n">connectedUser</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">connectedUserStr</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">connectedUser</span> <span class="o">!=</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">unauthorized</span><span class="o">(</span><span class="s">&quot;Lo siento, no estás autorizado&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">findUsuarioPorId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">usuario</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">notFound</span><span class="o">(</span><span class="s">&quot;Usuario no encontrado&quot;</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">Logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Encontrado usuario &quot;</span> <span class="o">+</span> <span class="n">usuario</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">usuario</span><span class="o">.</span><span class="na">getLogin</span><span class="o">());</span>
                <span class="k">return</span> <span class="n">ok</span><span class="o">(</span><span class="n">detalleUsuario</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">usuario</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>Para mapear los datos de los formularios se usan las clases <code>Login</code> y
<code>Registro</code>.</p>
<p><strong>Fichero <code>controllers/Login.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">play.data.validation.Constraints</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Login</span> <span class="o">{</span>
    <span class="nd">@Constraints.Required</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="nd">@Constraints.Required</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>controllers/Registro.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">play.data.validation.Constraints</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Registro</span> <span class="o">{</span>
    <span class="nd">@Constraints.Required</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">login</span><span class="o">;</span>
    <span class="nd">@Constraints.Required</span>
    <span class="nd">@Constraints.Email</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="nd">@Constraints.Required</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="nd">@Constraints.Required</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">confirmacion</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getLogin</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">login</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">login</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">login</span> <span class="o">=</span> <span class="n">login</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getConfirmacion</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">confirmacion</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConfirmacion</span><span class="o">(</span><span class="n">String</span> <span class="n">confirmacion</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">confirmacion</span> <span class="o">=</span> <span class="n">confirmacion</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h3 id="vistas_1">Vistas<a class="headerlink" href="#vistas_1" title="Permanent link">&para;</a></h3>
<p>Todas las vistas de la aplicación usan como plantilla base la vista
<code>main.scala.html</code>, en la que se carga el framework CSS <em>Bootstrap</em> y
la librería JavaScript <em>JQuery</em>. Ambos se encuentran en el directorio
<code>public</code>, el directorio por defecto en el que se guardan los recursos
estáticos de una aplicación Play.</p>
<p>Es importante hacer notar que se obtiene la ruta absoluta a los
ficheros estáticos llamando a <code>routes.Assets.versioned</code> con su ruta
relativa. De esta forma se modificar el directorio por defecto en el
que se guardan los recursos estáticos sin afectar a la aplicación.</p>
<p>A la plantilla <code>main</code> se le pasa el título de la página, scripts
JavaScript (por defecto vacío) y un contenido HTML que se inserta en
el cuerpo principal.</p>
<p><strong>Fichero <code>views/main.scala.html</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@*
 * This template is called from the `index` template. This template
 * handles the rendering of the page header and body tags. It takes
 * two arguments, a `String` for the title of the page and an `Html`
 * object to insert into the body of the page.
 *@
@(title: String, scripts: Html = Html(&quot;&quot;))(content: Html)
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        @* Here&#39;s where we render the page title `String`. *@
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>@title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">bootstrap</span><span class="err">/</span><span class="na">css</span><span class="err">/</span><span class="na">bootstrap</span><span class="err">.</span><span class="na">min</span><span class="err">.</span><span class="na">css</span><span class="err">&quot;)&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media</span><span class="o">=</span><span class="s">&quot;screen&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">stylesheets</span><span class="err">/</span><span class="na">main</span><span class="err">.</span><span class="na">css</span><span class="err">&quot;)&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;image/png&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">images</span><span class="err">/</span><span class="na">favicon</span><span class="err">.</span><span class="na">png</span><span class="err">&quot;)&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">hello</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
            @content
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">jquery</span><span class="err">.</span><span class="na">min</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;@routes.Assets.versioned(&quot;</span><span class="na">bootstrap</span><span class="err">/</span><span class="na">js</span><span class="err">/</span><span class="na">bootstrap</span><span class="err">.</span><span class="na">min</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
        @scripts
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>

<p>Un ejemplo del uso de esta plantilla es la plantilla principal del
listado de tareas. Se trata de una plantilla compleja, con bastantes
ejemplos de cómo usar los distintos elementos de Play:</p>
<ul>
<li>La plantilla recibe una lista de tareas, un usuario y un mensaje
(consultar en el controller <code>TareasController</code> cómo se obtienen esos
datos). </li>
<li>Define un script JavaScript en el que se realiza una petición
  <code>DELETE</code> a la URL que se le pasa como parámetro (se utilizará para
  lanzar la acción de borrar una tarea).</li>
<li>Utiliza una instrucción <code>for</code> para construir los elementos de la
  tabla de tareas.</li>
<li>En las acciones de añadir y editar tareas se usan enlaces a las URLs
  definidas por rutas inversas.</li>
</ul>
<p><strong>Fichero <code>views/listaTareas.scala.html</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>@(tareas: List[Tarea], usuario: Usuario, mensaje: String)
@scripts = {
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
        <span class="kd">function</span> <span class="nx">del</span><span class="p">(</span><span class="nx">urlBorrar</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">urlBorrar</span><span class="p">,</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
                <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">//refresh the page</span>
                    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
}
@main(&quot;Tareas del usuario @usuario.getLogin()&quot;, scripts) {

    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span> Listado de tareas de @usuario.getLogin()<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table table-striped&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Tareas<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Acción<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    @for(tarea <span class="p">&lt;</span><span class="nt">-</span> <span class="na">tareas</span><span class="err">)</span> <span class="err">{</span>
        <span class="err">&lt;</span><span class="na">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>@tarea.getTitulo()<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.TareasController.formularioEditaTarea(tarea.getId())&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;glyphicon glyphicon-pencil&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span><span class="ni">&amp;nbsp;</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">a</span> <span class="na">onmouseover</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;cursor: pointer;&quot;</span>
                <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;del(&#39;@routes.TareasController.borraTarea(tarea.getId())&#39;)&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;glyphicon glyphicon-trash&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      }

      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.TareasController.formularioNuevaTarea(usuario.getId())&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;glyphicon glyphicon-plus&quot;</span><span class="p">/&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;@routes.UsuarioController.logout()&quot;</span><span class="p">&gt;</span>Salir<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>

  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

  @if(mensaje != null) {
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-success&quot;</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;close&quot;</span> <span class="na">data-dismiss</span><span class="o">=</span><span class="s">&quot;alert&quot;</span> <span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;Close&quot;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;</span><span class="ni">&amp;times;</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
          @mensaje
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  }
}
</pre></div>
</td></tr></table>

<h3 id="tests_1">Tests<a class="headerlink" href="#tests_1" title="Permanent link">&para;</a></h3>
<p>La mayoría de los tests que contiene la aplicación son tests de
integración, en los que no se usan <em>mocks</em>, sino que se comprueba el
funcionamiento de la capa de servicio y la de repositorio.</p>
<p>Como framework de testing se usa <em>JUnit</em>. Los datos de prueba en las
tablas de la base de datos se definen y se cargan usando <em>DBUnit</em>.</p>
<p>Por ejemplo, la clase <code>models.EquipoTest</code> contiene tests para el
modelo <code>Equipo</code> y el <code>EquipoRepository</code>.</p>
<p>Los tests se realizarán utilizando la base de datos definida en el
fichero de configuración. En el fichero de configuración por defecto
(<code>conf/application.conf</code>) se define la base de datos de memoria
<code>H2</code>. </p>
<h4>Tests con la base de datos de memoria <code>H2</code></h4>
<p>Ejemplo de ejecución de los tests sobre la base de datos de memoria:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$  docker run --rm  -it -v &quot;${PWD}:/code&quot; -p 9000:9000 domingogallardo/playframework
[mads-todolist-inicial] $ test
..
[info] Test run finished: 0 failed, 0 ignored, 5 total, 1.753s
[info] Passed: Total 36, Failed 0, Errors 0, Passed 36
[success] Total time: 51 s, completed Aug 21, 2018 10:56:42 AM
</pre></div>
</td></tr></table>

<p>Podemos lanzar una clase de test en concreto:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[mads-todolist-inicial] $ testOnly models.EquipoTest
...
[info] Test run finished: 0 failed, 0 ignored, 6 total, 11.377s
[info] Passed: Total 6, Failed 0, Errors 0, Passed 6
[success] Total time: 38 s, completed Aug 22, 2018 7:41:09 AM
</pre></div>
</td></tr></table>

<h4>Tests con la base de datos MySQL</h4>
<p>La otra configuración que vamos a usar en los tests es
<code>conf/develop-mysql.conf</code>, en la que se utiliza una base de datos
MySQL. Como ya vimos anteriormente, para utilizar esta configuración
hay que lanzar el servicio de MySQL usando docker y definir en la
ejecución del contenedor de Play las variables de entorno <code>DB_URL</code>,
<code>DB_USER_NAME</code> y <code>DB_USER_PASSWD</code> con los datos correctos para acceder
a la base de datos MySQL.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run -d --rm -p 3306:3306 --name db-mysql -e MYSQL_ROOT_PASSWORD=mads -e MYSQL_DATABASE=mads mysql
$ docker run --link db-mysql --rm -it -p 9000:9000 -e \
DB_URL=&quot;jdbc:mysql://db-mysql:3306/mads&quot; -e DB_USER_NAME=&quot;root&quot; -e \
DB_USER_PASSWD=&quot;mads&quot; -v &quot;${PWD}:/code&quot; domingogallardo/playframework
[mads-todolist-inicial] $ set javaOptions += &quot;-Dconfig.file=conf/develop-mysql.conf&quot;
[mads-todolist-inicial] $ test
...
[success] Total time: 44 s, completed Aug 22, 2018 7:48:32 AM
[mads-todolist-inicial] $ 
</pre></div>
</td></tr></table>

<h4>Ejemplos de tests de la aplicación</h4>
<p>En la aplicación se definen tests sobre los modelos (clases entidad y
clases repositorio) y sobre los servicios. Como hemos mencionado antes
se tratan de unos tests de integración que se prueban directamente
sobre la base de datos activa en el fichero de configuración. Aunque
Play proporciona facilidades para el uso de <em>mocks</em> no los hemos
utilizado por simplificar la realización de los tests.</p>
<p>Se utiliza DBUnit para rellenar las tablas con los datos de
pruebas. El método <code>initData()</code> limpia las tablas e inicializa estos
datos con los existentes en <code>test/resources/test_dataset.xml</code> comienzo
de la ejecución de cada test.</p>
<p>DBUnit rellena las tablas físicas de la base de datos, no usa JPA. Hay
que utilizar los nombres de las tablas y de las columnas de la propia
base de datos, no los de las entidades JPA. Hay que incluir en el
fichero de dataset todas las tablas de la aplicación, incluyendo las
tablas auxiliares de las relaciones muchos-a-muchos, para que se
inicialicen los de datos de prueba (por ejemplo, la tabla
<code>Equipo_Usuario</code>).</p>
<p>Por último, se debe tener cuidado con las claves ajenas. No es posible
borrar una tabla si hay claves ajenas que referencian a algunos de sus
elementos. Para esto hay que considerar que DBUnit inserta los datos
de arriba a abajo y los borra de abajo a arriba.</p>
<p><strong>Fichero <code>test/resources/test_dataset.xml</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
 <span class="nt">&lt;dataset&gt;</span>
    <span class="nt">&lt;Usuario</span> <span class="na">id=</span><span class="s">&quot;1000&quot;</span> <span class="na">login=</span><span class="s">&quot;juangutierrez&quot;</span> <span class="na">nombre=</span><span class="s">&quot;Juan&quot;</span> <span class="na">apellidos=</span><span class="s">&quot;Gutierrez&quot;</span>
         <span class="na">password=</span><span class="s">&quot;123456789&quot;</span> <span class="na">eMail=</span><span class="s">&quot;juan.gutierrez@gmail.com&quot;</span> <span class="na">fechaNacimiento=</span><span class="s">&quot;1993-12-10&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Usuario</span> <span class="na">id=</span><span class="s">&quot;1005&quot;</span> <span class="na">login=</span><span class="s">&quot;anagarcia&quot;</span> <span class="na">nombre=</span><span class="s">&quot;Ana&quot;</span> <span class="na">apellidos=</span><span class="s">&quot;Garcia&quot;</span>
             <span class="na">password=</span><span class="s">&quot;123456789&quot;</span> <span class="na">eMail=</span><span class="s">&quot;ana.garcia@gmail.com&quot;</span> <span class="na">fechaNacimiento=</span><span class="s">&quot;1993-02-08&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Tarea</span> <span class="na">id=</span><span class="s">&quot;1001&quot;</span> <span class="na">titulo=</span><span class="s">&quot;Renovar DNI&quot;</span> <span class="na">usuarioId=</span><span class="s">&quot;1000&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Tarea</span> <span class="na">id=</span><span class="s">&quot;1002&quot;</span> <span class="na">titulo=</span><span class="s">&quot;Práctica 1 MADS&quot;</span> <span class="na">usuarioId=</span><span class="s">&quot;1000&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Equipo</span> <span class="na">id=</span><span class="s">&quot;1003&quot;</span> <span class="na">nombre=</span><span class="s">&quot;Equipo A&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Equipo</span> <span class="na">id=</span><span class="s">&quot;1004&quot;</span> <span class="na">nombre=</span><span class="s">&quot;Equipo B&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Equipo</span> <span class="na">id=</span><span class="s">&quot;1005&quot;</span> <span class="na">nombre=</span><span class="s">&quot;Equipo C&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Equipo_Usuario</span> <span class="na">fk_equipo=</span><span class="s">&quot;1003&quot;</span> <span class="na">fk_usuario=</span><span class="s">&quot;1000&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Equipo_Usuario</span> <span class="na">fk_equipo=</span><span class="s">&quot;1003&quot;</span> <span class="na">fk_usuario=</span><span class="s">&quot;1005&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Equipo_Usuario</span> <span class="na">fk_equipo=</span><span class="s">&quot;1004&quot;</span> <span class="na">fk_usuario=</span><span class="s">&quot;1000&quot;</span><span class="nt">/&gt;</span> 
  <span class="nt">&lt;/dataset&gt;</span>
</pre></div>
</td></tr></table>

<p>En cuanto a los tests propiamente dichos hay que resaltar algunos
puntos.</p>
<ul>
<li>Los objetos definidos con inyección de dependencias (la anotación
  <code>@Inject</code>) se instancian mediante el <code>Injector</code> de la aplicación
  Play. La aplicación se construye leyendo el fichero de
  configuración por defecto (se puede modificar con la variable
  <code>config.file</code> de las opciones Java al lanzar el test). De esta forma
  los objetos instanciados utilizarán la fuente de datos definida en
  la configuración de la aplicación (H2 o MySQL).</li>
<li>Los tests sobre los modelos contienen pruebas sobre las entidades
  (por ejemplo, se comprueba el método <code>equal</code> con entidades con y sin
  identificador) y sobre el repositorio del modelo, en los que se
  comprueba que las operaciones sobre la base de datos funcionan correctamente.</li>
<li>Los tests sobre los servicios contienen pruebas sobre los métodos de
  negocio de la clase servicio, incluyendo comprobaciones de que se
  lanzan excepciones si hay algún error.</li>
</ul>
<p><strong>Fichero <code>test/Models/EquipoTest.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">models</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoTest</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="n">Database</span> <span class="n">db</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kd">private</span> <span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>

    <span class="c1">// Se ejecuta sólo una vez, al principio de todos los tests</span>
    <span class="nd">@BeforeClass</span>
    <span class="kd">static</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initApplication</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Creamos la aplicación a partir del fichero de configuración.</span>
        <span class="c1">// El fichero de configuración se puede cambiar en el comando</span>
        <span class="c1">// para lanzar sbt y los tests:</span>
        <span class="c1">// sbt &#39;; set javaOptions += &quot;-Dconfig.file=conf/develop-mysql.conf&quot;; testOnly models.EquipoTest*&#39;</span>
        <span class="n">GuiceApplicationBuilder</span> <span class="n">guiceApplicationBuilder</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">GuiceApplicationBuilder</span><span class="o">().</span><span class="na">in</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">simple</span><span class="o">());</span>
        <span class="n">injector</span> <span class="o">=</span> <span class="n">guiceApplicationBuilder</span><span class="o">.</span><span class="na">injector</span><span class="o">();</span>
        <span class="c1">// Obtenemos la base de datos utilizada por la aplicación</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">Database</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// Necesario para inicializar JPA</span>
        <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">JPAApi</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initData</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Creamos la base de datos de test y le asignamos el nombre JNDI DBTodoList</span>
        <span class="n">JndiDatabaseTester</span> <span class="n">databaseTester</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JndiDatabaseTester</span><span class="o">(</span><span class="s">&quot;DBTodoList&quot;</span><span class="o">);</span>
        <span class="n">IDataSet</span> <span class="n">initialDataSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FlatXmlDataSetBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&quot;test/resources/test_dataset.xml&quot;</span><span class="o">));</span>
        <span class="n">databaseTester</span><span class="o">.</span><span class="na">setDataSet</span><span class="o">(</span><span class="n">initialDataSet</span><span class="o">);</span>
        <span class="n">databaseTester</span><span class="o">.</span><span class="na">setSetUpOperation</span><span class="o">(</span><span class="n">DatabaseOperation</span><span class="o">.</span><span class="na">CLEAN_INSERT</span><span class="o">);</span>
        <span class="n">databaseTester</span><span class="o">.</span><span class="na">onSetup</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testEqualsEquiposConId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Equipo</span> <span class="n">equipo1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo A&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo B&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo C&quot;</span><span class="o">);</span>
        <span class="n">equipo1</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">equipo2</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">equipo3</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2L</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="n">equipo1</span><span class="o">,</span> <span class="n">equipo2</span><span class="o">);</span>
        <span class="n">assertNotEquals</span><span class="o">(</span><span class="n">equipo1</span><span class="o">,</span> <span class="n">equipo3</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testEqualsEquiposSinId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Equipo</span> <span class="n">equipo1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo A&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo A&quot;</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo B&quot;</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="n">equipo1</span><span class="o">,</span> <span class="n">equipo2</span><span class="o">);</span>
        <span class="n">assertNotEquals</span><span class="o">(</span><span class="n">equipo1</span><span class="o">,</span> <span class="n">equipo3</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddEquipoJPARepositoryInsertsEquipoDatabase</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo A&quot;</span><span class="o">);</span>
        <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
        <span class="n">Logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Número de tarea: &quot;</span> <span class="o">+</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
        <span class="n">assertNotNull</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;Equipo A&quot;</span><span class="o">,</span> <span class="n">getNombreFromEquipoDB</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getNombreFromEquipoDB</span><span class="o">(</span><span class="n">Long</span> <span class="n">equipoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">titulo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">withConnection</span><span class="o">(</span><span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">selectStatement</span> <span class="o">=</span> <span class="s">&quot;SELECT NOMBRE FROM Equipo WHERE ID = ? &quot;</span><span class="o">;</span>
            <span class="n">PreparedStatement</span> <span class="n">prepStmt</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">selectStatement</span><span class="o">);</span>
            <span class="n">prepStmt</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">equipoId</span><span class="o">);</span>
            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">prepStmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
            <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;NOMBRE&quot;</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">titulo</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindEquipoPorId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoRepository</span> <span class="n">repository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;Equipo A&quot;</span><span class="o">,</span> <span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUpdateEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoRepository</span> <span class="n">repository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="o">(</span><span class="s">&quot;Equipo B&quot;</span><span class="o">);</span>
        <span class="n">equipo</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipoActualizado</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;Equipo B&quot;</span><span class="o">,</span> <span class="n">equipo</span><span class="o">.</span><span class="na">getNombre</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeleteEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoRepository</span> <span class="n">repository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
        <span class="n">equipo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">assertNull</span><span class="o">(</span><span class="n">equipo</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddUsuarioEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">UsuarioRepository</span> <span class="n">usuarioRepository</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">UsuarioRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1005L</span><span class="o">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1005L</span><span class="o">);</span>
        <span class="n">equipoRepository</span><span class="o">.</span><span class="na">addUsuarioEquipo</span><span class="o">(</span><span class="n">usuario</span><span class="o">,</span> <span class="n">equipo</span><span class="o">);</span>

        <span class="c1">// Recuperamos las entidades de la base de datos y comprobamos</span>
        <span class="c1">// que los datos se han actualizado</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="o">.</span><span class="na">findUsuariosEquipo</span><span class="o">(</span><span class="n">equipo</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">usuarios</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">Usuario</span> <span class="n">usuarioBD</span> <span class="o">=</span> <span class="n">usuarioRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1005L</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">usuarioBD</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<p><strong>Fichero <code>test/services/EquipoService.java</code></strong>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">services</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoServiceTest</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">private</span> <span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>

    <span class="nd">@BeforeClass</span>
    <span class="kd">static</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initApplication</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">GuiceApplicationBuilder</span> <span class="n">guiceApplicationBuilder</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">GuiceApplicationBuilder</span><span class="o">().</span><span class="na">in</span><span class="o">(</span><span class="n">Environment</span><span class="o">.</span><span class="na">simple</span><span class="o">());</span>
        <span class="n">injector</span> <span class="o">=</span> <span class="n">guiceApplicationBuilder</span><span class="o">.</span><span class="na">injector</span><span class="o">();</span>
        <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">JPAApi</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initData</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">JndiDatabaseTester</span> <span class="n">databaseTester</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JndiDatabaseTester</span><span class="o">(</span><span class="s">&quot;DBTodoList&quot;</span><span class="o">);</span>
        <span class="n">IDataSet</span> <span class="n">initialDataSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FlatXmlDataSetBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&quot;test/resources/test_dataset.xml&quot;</span><span class="o">));</span>
        <span class="n">databaseTester</span><span class="o">.</span><span class="na">setDataSet</span><span class="o">(</span><span class="n">initialDataSet</span><span class="o">);</span>
        <span class="n">databaseTester</span><span class="o">.</span><span class="na">setSetUpOperation</span><span class="o">(</span><span class="n">DatabaseOperation</span><span class="o">.</span><span class="na">CLEAN_INSERT</span><span class="o">);</span>
        <span class="n">databaseTester</span><span class="o">.</span><span class="na">onSetup</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listaEquipos</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoService</span> <span class="n">equipoService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">allEquipos</span><span class="o">();</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">equipos</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUsuarioEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoService</span> <span class="n">equipoService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">UsuarioService</span> <span class="n">usuarioService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">UsuarioService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">equipoService</span><span class="o">.</span><span class="na">addUsuarioEquipo</span><span class="o">(</span><span class="mi">1000L</span><span class="o">,</span> <span class="mi">1005L</span><span class="o">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">findUsuarioPorLogin</span><span class="o">(</span><span class="s">&quot;juangutierrez&quot;</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">());</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">equipos</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getUsuariosEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoService</span> <span class="n">equipoService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">UsuarioService</span> <span class="n">usuarioService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">UsuarioService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">findUsuariosEquipo</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">usuarios</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">findUsuarioPorLogin</span><span class="o">(</span><span class="s">&quot;anagarcia&quot;</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUsuarioEquipo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">EquipoService</span> <span class="n">equipoService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">EquipoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">UsuarioService</span> <span class="n">usuarioService</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">instanceOf</span><span class="o">(</span><span class="n">UsuarioService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">equipoService</span><span class="o">.</span><span class="na">deleteUsuarioEquipo</span><span class="o">(</span><span class="mi">1000L</span><span class="o">,</span> <span class="mi">1003L</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="n">equipoService</span><span class="o">.</span><span class="na">findUsuariosEquipo</span><span class="o">(</span><span class="mi">1003L</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">usuarios</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="o">.</span><span class="na">findUsuarioPorLogin</span><span class="o">(</span><span class="s">&quot;juangutierrez&quot;</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">usuario</span><span class="o">.</span><span class="na">getEquipos</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>

<h2 id="tecnologias-usadas">Tecnologías usadas<a class="headerlink" href="#tecnologias-usadas" title="Permanent link">&para;</a></h2>
<h3 id="play-framework">Play Framework<a class="headerlink" href="#play-framework" title="Permanent link">&para;</a></h3>
<p><a href="https://playframework.com">Play Framework</a> es un framework de
desarrollo rápido de aplicaciones web disponible en los lenguajes Java
y Scala. Vamos a utilizar la versión Java. El framework proporciona un
soporte de ejecución que tiene como base el servidor
<a href="http://netty.io">Netty</a>. Con este soporte es posible diseñar y poner
en marcha distintos tipos de aplicaciones: servicios HTTP, servicios
HTTP asíncronos basados en websockets, aplicaciones asíncronas basadas
en eventos, etc. Nosotros vamos a implementar una aplicación
tradicional que implementa un servicio HTTP. Vamos a utilizar la
<a href="https://www.playframework.com/documentation/2.5.x/JavaHome">versión 2.5 en Java</a>.</p>
<p>Para entender el funcionamiento de esta primera práctica es necesario
consultar la siguiente documentación del framework:</p>
<p>Sobre el funcionamiento de Play:</p>
<ul>
<li><a href="https://playframework.com/documentation/2.5.x/PlayConsole">Using the Play console</a></li>
<li><a href="https://playframework.com/documentation/2.5.x/Anatomy">Anatomy of a Play application</a></li>
</ul>
<p>Sobre peticiones y respuestas HTTP:</p>
<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaActions">Actions, Controllers and Results</a></li>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaRouting">HTTP routing</a></li>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaSessionFlash">Session and Flash scope</a></li>
</ul>
<p>Sobre plantillas:</p>
<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaTemplates">The template engine</a></li>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaTemplateUseCases">Common template use cases</a></li>
</ul>
<p>Sobre envío de datos de formularios:</p>
<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaForms">Handling form submission</a></li>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaFormHelpers#Rendering-an-%3Cinput%3E-element">Rendering an <input> element</a></li>
</ul>
<p>Sobre el acceso a base de datos y JPA</p>
<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaDatabase">Acceso a base de datos SQL</a></li>
<li><a href="https://www.playframework.com/documentation/2.5.x/JavaJPA">Integrating with JPA</a></li>
</ul>
<p>Sobre la inyección de dependencias</p>
<ul>
<li><a href="https://playframework.com/documentation/2.5.x/JavaDependencyInjection">Dependency Injection</a></li>
</ul>
<p>Sobre los tests en Play:</p>
<ul>
<li><a href="https://playframework.com/documentation/2.5.x/JavaTest">Testing your application</a></li>
</ul>
<p>Sobre la configuración de la aplicación Play:</p>
<ul>
<li><a href="https://www.playframework.com/documentation/2.5.x/ConfigFile">Configuración</a></li>
</ul>
<h3 id="java-persistence-api-jpa">Java Persistence API (JPA)<a class="headerlink" href="#java-persistence-api-jpa" title="Permanent link">&para;</a></h3>
<p>JPA es el API que utilizaremos para acceder a bases de datos y
gestionar entidades persistentes usando un modelo ORM (<em>Object
Relational Mapping</em>). Está integrado en Play, no es necesario instalar
ninguna librería adicional.</p>
<p>JPA también es conocido por el nombre de una de sus implementaciones
más populares, Hibernate. Es una tecnología muy usada y madura en el
mundo Java. Permite gestionar la persistencia directamente con el
modelo de objetos de la aplicación (se denominan <em>entidades</em>),
independizándola del modelo relacional basado en tablas y registros.</p>
<p>La implementación de JPA ObjectDB tiene unos tutoriales muy completos
y accesibles:</p>
<ul>
<li><a href="http://www.objectdb.com/java/jpa/getting/started">JPA Quick tour</a></li>
<li><a href="http://www.objectdb.com/java/jpa/entity">Entity classes</a></li>
<li><a href="http://www.objectdb.com/java/jpa/persistence">Using JPA</a></li>
<li><a href="http://www.objectdb.com/java/jpa/query">JPA Queries</a></li>
</ul>
<p>No es necesario estudiar todos los tutoriales. El objetivo de las
prácticas no es aprender JPA, sino desarrollar de forma ágil una
aplicación. Vamos a utilizar lo más básico de JPA y en la mayoría de
las ocasiones se va a proporcionar el código necesario. Además, en
caso de duda, siempre podrás realizar preguntas sobre cómo implementar
una determinada funcionalidad en el foro de Moodle.</p>
<p>La implementación de JPA que se utiliza en PlayFramework 2.5 es
Hibernate 5.1.0.Final.</p>
<p>Puedes encontrar toda la información sobre esta implementación en la
guía de usuario:</p>
<ul>
<li><a href="http://docs.jboss.org/hibernate/orm/5.1/userguide/html_single/Hibernate_User_Guide.html#associations-many-to-one">Hibernate ORM 5.1 User Guide</a></li>
</ul>
<h3 id="bootstrap">Bootstrap<a class="headerlink" href="#bootstrap" title="Permanent link">&para;</a></h3>
<p>Para hacer más atractivo el diseño de las páginas HTML vamos a usuar
el framework CSS
<a href="https://getbootstrap.com/docs/3.3/getting-started/">Bootstrap</a>. Es conveniente
tener a mano su documentación, en concreto la lista de componentes:</p>
<ul>
<li><a href="https://getbootstrap.com/docs/3.3/components/">Bootstrap components</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>