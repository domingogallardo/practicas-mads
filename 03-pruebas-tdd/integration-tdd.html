
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.5">
    
    
      
        <title>Práctica 3 - Prácticas MADS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Ubuntu";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#practica-3-integracion-con-github-actions-y-tdd" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href=".." title="Prácticas MADS" class="md-header__button md-logo" aria-label="Prácticas MADS" data-md-component="logo">
      
  <img src="../imagenes/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Prácticas MADS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Práctica 3
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Prácticas MADS" class="md-nav__button md-logo" aria-label="Prácticas MADS" data-md-component="logo">
      
  <img src="../imagenes/logo.png" alt="logo">

    </a>
    Prácticas MADS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        Práctica 1
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Práctica 1" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Práctica 1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01-intro-spring-boot/practica1.html" class="md-nav__link">
        Enunciado de la práctica
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01-intro-spring-boot/intro-spring-boot.html" class="md-nav__link">
        Introducción a Spring Boot
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01-intro-spring-boot/comandos-git.html" class="md-nav__link">
        Resumen de comandos Git
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-todolist/practica2.html" class="md-nav__link">
        Práctica 2
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Práctica 3
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="integration-tdd.html" class="md-nav__link md-nav__link--active">
        Práctica 3
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-desarrollo-de-la-release-120" class="md-nav__link">
    1. Desarrollo de la release 1.2.0
  </a>
  
    <nav class="md-nav" aria-label="1. Desarrollo de la release 1.2.0">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-integracion-continua-con-github-actions" class="md-nav__link">
    2. Integración continua con GitHub Actions
  </a>
  
    <nav class="md-nav" aria-label="2. Integración continua con GitHub Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tests-en-los-pull-requests" class="md-nav__link">
    Tests en los pull requests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#el-fichero-de-configuracion" class="md-nav__link">
    El fichero de configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#builds-en-actions" class="md-nav__link">
    Builds en Actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-configuracion-de-la-aplicacion-para-usar-una-bd-postgresql" class="md-nav__link">
    3. Configuración de la aplicación para usar una BD PostgreSQL
  </a>
  
    <nav class="md-nav" aria-label="3. Configuración de la aplicación para usar una BD PostgreSQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ficheros-de-configuracion-de-la-aplicacion" class="md-nav__link">
    Ficheros de configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-tests-de-integracion-en-github-actions" class="md-nav__link">
    4. Tests de integración en GitHub Actions
  </a>
  
    <nav class="md-nav" aria-label="4. Tests de integración en GitHub Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tests-del-desarrollador-vs-tests-de-integracion" class="md-nav__link">
    Tests del desarrollador vs. tests de integración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accion-para-lanzar-los-tests-con-la-bd-postgres" class="md-nav__link">
    Acción para lanzar los tests con la BD postgres
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-tdd" class="md-nav__link">
    5. TDD
  </a>
  
    <nav class="md-nav" aria-label="5. TDD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#008-listado-de-equipos" class="md-nav__link">
    008 Listado de equipos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_4" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resto-de-historias-de-usuario" class="md-nav__link">
    Resto de historias de usuario
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_5" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-documentacion-entrega-y-evaluacion" class="md-nav__link">
    6. Documentación, entrega y evaluación
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-desarrollo-de-la-release-120" class="md-nav__link">
    1. Desarrollo de la release 1.2.0
  </a>
  
    <nav class="md-nav" aria-label="1. Desarrollo de la release 1.2.0">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-integracion-continua-con-github-actions" class="md-nav__link">
    2. Integración continua con GitHub Actions
  </a>
  
    <nav class="md-nav" aria-label="2. Integración continua con GitHub Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tests-en-los-pull-requests" class="md-nav__link">
    Tests en los pull requests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#el-fichero-de-configuracion" class="md-nav__link">
    El fichero de configuración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#builds-en-actions" class="md-nav__link">
    Builds en Actions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_1" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-configuracion-de-la-aplicacion-para-usar-una-bd-postgresql" class="md-nav__link">
    3. Configuración de la aplicación para usar una BD PostgreSQL
  </a>
  
    <nav class="md-nav" aria-label="3. Configuración de la aplicación para usar una BD PostgreSQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ficheros-de-configuracion-de-la-aplicacion" class="md-nav__link">
    Ficheros de configuración de la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_2" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-tests-de-integracion-en-github-actions" class="md-nav__link">
    4. Tests de integración en GitHub Actions
  </a>
  
    <nav class="md-nav" aria-label="4. Tests de integración en GitHub Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tests-del-desarrollador-vs-tests-de-integracion" class="md-nav__link">
    Tests del desarrollador vs. tests de integración
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accion-para-lanzar-los-tests-con-la-bd-postgres" class="md-nav__link">
    Acción para lanzar los tests con la BD postgres
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_3" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-tdd" class="md-nav__link">
    5. TDD
  </a>
  
    <nav class="md-nav" aria-label="5. TDD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#008-listado-de-equipos" class="md-nav__link">
    008 Listado de equipos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_4" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resto-de-historias-de-usuario" class="md-nav__link">
    Resto de historias de usuario
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pasos-a-seguir_5" class="md-nav__link">
    Pasos a seguir
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-documentacion-entrega-y-evaluacion" class="md-nav__link">
    6. Documentación, entrega y evaluación
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="practica-3-integracion-con-github-actions-y-tdd">Práctica 3: Integración con GitHub Actions y TDD<a class="headerlink" href="#practica-3-integracion-con-github-actions-y-tdd" title="Permanent link">&para;</a></h1>
<p>En esta práctica 3 de la asignatura realizaremos dos tareas principales:</p>
<ul>
<li>Configuraremos un sistema de integración continua usando las
  <em>actions</em> del repositorio de GitHub. En este sistema se lanzarán los
  tests automáticamente en cada <em>pull request</em>. Después definiremos
  una nueva configuración del proyecto en la que se lanzarán los tests
  sobre la base de datos <a href="https://www.postgresql.org">PostgreSQL</a>.</li>
<li>Añadiremos nuevas funcionalidades usando la práctica XP de TDD
  (<em>Test Driven Design</em>).</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Lee con cuidado todo el enunciado y dedica especial atención a los
apartados con el título <code>Pasos a seguir</code>. Ahí están
especificadas las acciones que debes realizar en la práctica.</p>
</div>
<p>La duración de la práctica es de 3 semanas y la fecha límite de
entrega es el día 8 de noviembre.</p>
<h2 id="1-desarrollo-de-la-release-120">1. Desarrollo de la <em>release</em> 1.2.0<a class="headerlink" href="#1-desarrollo-de-la-release-120" title="Permanent link">&para;</a></h2>
<p>En esta práctica vamos a desarrollar la versión 1.2.0 de la aplicación
<code>ToDoList</code>. A todos los <em>issues</em> y <em>pull requests</em> les debes poner este
<em>milestone</em>, indicando que el objetivo es resolverlos y entregarlos en
esta <em>release</em>.</p>
<h3 id="pasos-a-seguir">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir" title="Permanent link">&para;</a></h3>
<ul>
<li>Cambia el número de versión (en el fichero <em>Acerca De</em> y en el
  <code>pom.xml</code>) a <code>1.2.0-SNAPSHOT</code> para indicar que lo que hay en main
  es la versión 1.2.0 <strong>en progreso</strong>. Esta versión la lanzaremos al
  final del desarrollo de la práctica, en su entrega.</li>
</ul>
<h2 id="2-integracion-continua-con-github-actions">2. Integración continua con GitHub Actions<a class="headerlink" href="#2-integracion-continua-con-github-actions" title="Permanent link">&para;</a></h2>
<p><a href="https://docs.github.com/en/free-pro-team@latest/actions">GitHub
Actions</a> es
un servicio de GitHub que permite realizar integración continua
en su propia web, sin necesidad de configurar un servidor propio de integración
continua.</p>
<p>Puedes consultar el funcionamiento de GitHub Actions leyendo su documentación,
comenzando por las páginas <a href="https://docs.github.com/en/free-pro-team@latest/actions/quickstart">Quickstart for GitHub
Actions</a>,
<a href="https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/introduction-to-github-actions">Introduction to GitHub
Actions</a>
y <a href="https://docs.github.com/en/free-pro-team@latest/actions/guides/building-and-testing-java-with-maven">Building and testing Java with
Maven</a>. </p>
<p>En la práctica vamos a comenzar configurando GitHub Actions para que
todos los <em>pull requests</em> deban pasar los tests de integración antes
de realizar el <em>merge</em> con <code>main</code>.</p>
<h3 id="tests-en-los-pull-requests">Tests en los pull requests<a class="headerlink" href="#tests-en-los-pull-requests" title="Permanent link">&para;</a></h3>
<p>Usando GitHub Actions es posible configurar el repositorio de GitHub
para que todos los <em>pull requests</em> deban pasar los tests de
integración en el servicio.</p>
<p>En la siguiente imagen vemos el aspecto en GitHub de un <em>pull request</em>
estando activa la integración con Actions. Una vez abierto el PR,
se lanzan los flujos de trabajo (<em>workflows</em>) definidos en 
el directorio <code>.github/workflows</code>. </p>
<p>GitHub comprueba si la integración de main con la rama pasa los tests
definidos en el workflow. Sólo si los tests pasan es posible realizar
el <em>merge</em> del PR en main.</p>
<p><img src="imagenes/pull-request-actions.png" width="600px"/></p>
<h3 id="el-fichero-de-configuracion">El fichero de configuración<a class="headerlink" href="#el-fichero-de-configuracion" title="Permanent link">&para;</a></h3>
<p>Para configurar GitHub Actions basta con añadir un fichero de flujo de
trabajo en el directorio <code>.github/workflows</code>.</p>
<p>El fichero con el flujo de trabajo inicial lo llamaremos <code>developer-tests.yml</code>:</p>
<p><strong>Fichero <code>.github/workflows/developer-tests.yml</code></strong></p>
<div class="highlight"><pre><span></span><code>name: Tests

on: push

jobs:
  # El nombre del job es launch-test
  launch-tests:
    runs-on: ubuntu-latest
    # Todos los pasos se ejecutan en el contenedor openjda:8-jdk-alpine
    container: openjdk:8-jdk-alpine

    steps:
      # Hacemos un checkout del código del repositorio 
      - uses: actions/checkout@v2
      # Y lanzamos los tests
      - name: Launch tests with Maven
        run:  ./mvnw test
</code></pre></div>
<p>Puntos interesantes a destacar:</p>
<ul>
<li>El nombre del flujo de trabajo es <code>Tests</code>.</li>
<li>El nombre del job es <code>launch-tests</code>.</li>
<li>Con la palabra clave <code>on</code> se define el evento que causa que se lance
  el flujo de trabajo. Es en cualquier commit subido a GitHub  (push).</li>
<li>En <code>jobs</code> se definen los trabajos en paralelo a realizar por el
  flujo de trabajo. En nuestro caso sólo habrá uno.</li>
<li>En <code>runs-on</code> se define la máquina base sobre la que se van a
  ejecutar los siguientes pasos del flujo.</li>
<li>En <code>container</code> se especifica el contenedor Docker que se va a usar
  para ejecutar los pasos del flujo de trabajo.</li>
<li>En <code>uses: actions/checkout@v2</code> se especifica que se obtenga la
  versión 2 de la acción llamada <code>actions/checkout</code>. Esta acción se
  descarga el repositorio en la máquina especificada anteriormente y
  lo deja listo para ejecutar los tests o cualquier otra acción.</li>
<li>Por último, con el comando <code>run: ./mvnw test</code> se indica que el flujo
  de trabajo debe lanzar este comando, que es el que lanza los
  tests. </li>
<li>Los nombres <code>Tests</code> y <code>launch-tests</code> son nombres arbitrarios que
  indicamos y que después aparecen en la interfaz de Actions y nos
  sirven para localizar los distintos pasos.</li>
</ul>
<h3 id="builds-en-actions">Builds en Actions<a class="headerlink" href="#builds-en-actions" title="Permanent link">&para;</a></h3>
<p>En la pestaña <code>Actions</code> de GitHub tenemos toda la información de los
<em>builds</em>. Es posible visualizarla mientras que se está realizando el
build o cuando ya ha terminado. Allí podremos ver el detalle de la
ejecución de los tests y consultar la salida de los mismos para
comprobar su resultado.</p>
<p>En la siguiente imagen se ha capturado el build en ejecución. El color
naranja significa que el proceso está en ejecución.</p>
<p><img src="imagenes/builds-github-actions.png" width="600px"/></p>
<h3 id="pasos-a-seguir_1">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_1" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Crea un <em>issue</em> llamado <code>Integración continua con GitHub
  Actions</code>. Abre una rama <code>integracion-continua-actions</code>, súbela a GitHub y abre un pull
  request.</p>
</li>
<li>
<p>Añade el fichero <code>.github/workflows/developer-tests.yml</code>. Haz un
  commit y súbelo a GitHub.</p>
</li>
<li>
<p>Comprueba que se pasan los tests y que se marca como correcto el
  <em>pull request</em>.</p>
</li>
<li>
<p>Modifica un test para que falle y sube un nuevo commit. Recarga la
  página del pull request y comprueba que el commit aparece como
  erróneo en GitHub cuando el <em>build</em> falla. Pincha en el enlace
  <em>details</em> para comprobar la descripción del fallo.</p>
</li>
<li>
<p>Corrige el test que falla, vuelve a subir el commit y comprueba que
  el nuevo commit y el PR pasan correctamente.</p>
</li>
<li>
<p>Cierra el <em>pull request</em>, mezclándolo con <code>main</code>. Se volverán a
  lanzar los tests en GitHub y el commit aparecerá marcado como
  correcto. Baja los cambios al repositorio local y borra la rama.</p>
<div class="highlight"><pre><span></span><code>$ (integracion-continua-actions) git checkout main
$ (main) git pull
$ (main) git branch -d integracion-continua-actions
$ (main) git remote prune origin
</code></pre></div>
</li>
</ul>
<h2 id="3-configuracion-de-la-aplicacion-para-usar-una-bd-postgresql">3. Configuración de la aplicación para usar una BD PostgreSQL<a class="headerlink" href="#3-configuracion-de-la-aplicacion-para-usar-una-bd-postgresql" title="Permanent link">&para;</a></h2>
<p>Hasta ahora hemos trabajado con la aplicación en una configuración
local con nuestro ordenador de desarrollo trabajando sobre una base de
datos H2 en memoria. Pero el objetivo final es poner la aplicación en
producción, en un servidor en Internet y usando una base de datos
PostgreSQL en producción. </p>
<p>Además, te habrás dado cuenta de que es muy engorroso probar la
aplicación con la base de datos de memoria. Tienes que volver a
introducir todos los datos de prueba cada vez que paramos y ponemos en
marcha la aplicación.</p>
<p>En esta práctica vamos a ver cómo configurar la aplicación para poder
trabajar con una base datos PostgreSQL, tanto en su ejecución como en
los tests.</p>
<p>Para configurar la aplicación vamos a utilizar los denominados
<em>perfiles</em>. Definiremos, además del perfil base, un perfil adicional
para lanzar la aplicación y los tests usando la base de datos
PostgreSQL.</p>
<p>La configuración de tests con base de datos PostgreSQL la utilizaremos
para ejecutar los tests de integración sobre la base de datos PostgreSQL
en el proceso de integración continua de GitHub Actions.</p>
<p>Para lanzar un servidor de base de datos PostgreSQL usaremos Docker, de
forma que no tendremos que realizar ninguna instalación en nuestro
ordenador.</p>
<p><img src="imagenes/app-contenedor.png" width="500px" /></p>
<h3 id="ficheros-de-configuracion-de-la-aplicacion">Ficheros de configuración de la aplicación<a class="headerlink" href="#ficheros-de-configuracion-de-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>Ya hemos comentado que la configuración de la aplicación se define en
el fichero <code>application.properties</code>. Ahí se definen distintas
propiedades de la ejecución de la aplicación que se pueden modificar
(puerto en el que se lanza la aplicación, base de datos con la que
conectarse, etc.). </p>
<p>Tenemos dos ficheros <code>application.properties</code>: uno en el directorio
<code>src/main/resources</code> que define la configuración de ejecución y otro
en el directorio <code>src/test/resources</code> que define la configuración que
se carga cuando se lanzan los tests.</p>
<p>Spring Boot permite definir ficheros de configuración adicionales
que pueden <strong>sobreescribir y añadir propiedades</strong> a las definidas en el
fichero de configuración por defecto. El nombre de estos ficheros de
configuración debe ser <code>application-xxx.properties</code> donde <code>xxx</code> define
el nombre del perfil. En nuestro caso definiremos los ficheros
<code>application-postgres.properties</code> (uno en el directorio <code>main</code> y otro
en <code>test</code>) para definir las configuraciones de ejecución y de test con
PostgreSQL.</p>
<p>Estos ficheros de configuración adicionales se cargan después de
cargar la configuración por defecto definida en <code>application.properties</code>.</p>
<h3 id="pasos-a-seguir_2">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_2" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Crea un nuevo <em>issue</em> llamado <code>Añadir perfiles y permitir trabajar
  con PostgreSQL</code>. Crea una rama nueva (llámala <code>perfiles</code>, por ejemplo) y
  abre un pull request. </p>
<div class="highlight"><pre><span></span><code>$ (main) git checkout -b perfiles
$ (perfiles) git push -u origin perfiles
</code></pre></div>
</li>
<li>
<p>Copia el siguiente fichero en <code>src/main/resources/application-postgres.properties</code>:</p>
<div class="highlight"><pre><span></span><code>spring.datasource.url=jdbc:postgresql://localhost:5432/mads
spring.datasource.username=mads
spring.datasource.password=mads
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.PostgreSQL9Dialect
spring.sql.init.mode=never
</code></pre></div>
<p>Este va a ser el perfil que activemos para utilizar la conexión
con la BD PostgreSQL.</p>
<p>En este fichero de configuración se define la URL de conexión a la
base de datos <code>mads</code>, su usuario (<code>mads</code>) y contraseña (<code>mads</code>) y
el dialecto que se va a utilizar para trabajar desde JPA con la
base de datos (<code>org.hibernate.dialect.PostgreSQL9Dialect</code>).</p>
<p>La propiedad <code>spring.sql.init.mode=never</code> indica
que no se debe cargar ningún fichero de datos inicial. Por esto,
el fichero <code>data.sql</code> no se va a cargar en la base de datos,
deberás registrar un usuario inicial para poder probar la
aplicación. La ventaja es que al trabajar con la base de datos
real todos los datos van a quedar grabados aunque se pare la
aplicación.</p>
</li>
<li>
<p>Vamos ahora a añadir el perfil de test. Copia el siguiente fichero
  en <code>src/test/resources/application-postgres.properties</code>:</p>
<div class="highlight"><pre><span></span><code>spring.datasource.url=jdbc:postgresql://localhost:5432/mads_test
spring.datasource.username=mads
spring.datasource.password=mads
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.PostgreSQL9Dialect
</code></pre></div>
<p>En este perfil la conexión se hace con una base de datos
diferente: <code>mads_test</code>, para no sobreescribir la base de datos
definida en el perfil de ejecución.</p>
<p>Recuerda que en el perfil por defecto
<code>resources/application.properties</code> se define el valor de
<code>spring.jpa.hibernate.ddl-auto</code> como <code>create</code>. De esta forma la
base de datos se inicializa antes de cargar los datos de los tests
y de ejecutarlos. También usamos una base de datos distinta
(<code>mads_test</code>) para no sobreescribir la base de datos definida en
el perfil de ejecución.</p>
</li>
<li>
<p>Añade la siguiente dependencia en el fichero <code>pom.xml</code> para que se
   descargue el driver <code>postgresql:42.2.22</code>. También añade las líneas
   para poder especificar perfiles desde línea de comando. La variable
   <code>profiles</code> se definirá desde línea de comando cuando se llame a
   Maven:</p>
<p>Fichero <code>pom.xml</code>:</p>
<div class="highlight"><pre><span></span><code>            <span class="nt">&lt;artifactId&gt;</span>h2<span class="nt">&lt;/artifactId&gt;</span>
             <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
<span class="hll">         <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">             <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">             <span class="nt">&lt;version&gt;</span>42.2.22<span class="nt">&lt;/version&gt;</span>
</span><span class="hll">         <span class="nt">&lt;/dependency&gt;</span>
</span>         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>

        ...

            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="hll">                <span class="nt">&lt;configuration&gt;</span>
</span><span class="hll">                    <span class="nt">&lt;profiles&gt;</span>${profiles}<span class="nt">&lt;/profiles&gt;</span>
</span><span class="hll">                <span class="nt">&lt;/configuration&gt;</span>
</span>            <span class="nt">&lt;/plugin&gt;</span>
</code></pre></div>
</li>
<li>
<p>Para lanzar la aplicación necesitarás un servidor PostgreSQL en el
   puerto 5432 con el usuario <code>mads</code>, la contraseña <code>mads</code> y la base
   de datos <code>mads</code>. Es muy sencillo descargarlo y ejecutarlo si tienes
   instalado Docker. Ejecuta desde el terminal:</p>
<div class="highlight"><pre><span></span><code>docker run -d -p 5432:5432 --name postgres-develop -e POSTGRES_USER=mads -e POSTGRES_PASSWORD=mads -e POSTGRES_DB=mads postgres:13
</code></pre></div>
<p>Docker se descarga la imagen <code>postgres:13</code> y lanza el contenedor (una
instancia en marcha de una imagen) conectado al puerto 5432 (no debe
estar ocupado) y sobre la base de datos <code>mads</code>. Le da como nombre
<code>postgres-develop</code>.</p>
<p>Puedes ejecutar los siguientes comandos de Docker:</p>
<div class="highlight"><pre><span></span><code>$ docker container ls -a (comprueba todos los contenedores en marcha)
$ docker container stop &lt;nombre o id de contenedor&gt; (para un contenedor)
$ docker container start &lt;nombre o id de contenedor&gt; (pone en marcha un contenedor)
$ docker container logs &lt;mombre o id de contenedor&gt; (muestra logs del contenedor)
$ docker container rm nombre o id de contenedor&gt; (elimina un contenedor)
</code></pre></div>
</li>
<li>
<p>Arranca la aplicación con el siguiente comando:</p>
<div class="highlight"><pre><span></span><code>./mvnw spring-boot:run -D profiles=postgres
</code></pre></div>
<p>Se activará el perfil <code>postgres</code> y se cargarán las preferencias de
<code>src/main/resource/application.properties</code> y
<code>src/main/resource/application-postgres.properties</code>.</p>
<p>Prueba a introducir datos en la aplicación y comprueba que se
están guardando en la base de datos utilizando por ejemplo el
panel <code>Database</code> de <em>IntelliJ</em>. Deberás añadir una <em>Data Source</em>
de tipo <em>PostgreSQL</em>, configurando el usuario y contraseña de
acceso a <code>mads</code>:</p>
<p><img src="imagenes/data-source.png" width="700px"/></p>
<p>Añade la conexión con la base de datos <code>mads</code> pulsando en el
pequeño recuadro junto al nombre de la fuente de datos:</p>
<p><img src="imagenes/conexion-data-source.png" width="400px"/></p>
<p>Y después ya podrás examinar la base de datos <code>mads</code>, pulsando en
la tabla que quieras y seleccionando con el botón derecho <em>Edit Data</em>:</p>
<p><img src="imagenes/panel-database.png" width="700px"/></p>
</li>
<li>
<p>Cierra la aplicación y vuelve a abrirla. Comprueba que los datos
   que se han creado en la ejecución anterior siguen estando. </p>
<p>Podemos también parar el contenedor y volverlo a reiniciar y los
datos se conservarán. Al parar el contenedor no se eliminan los
datos, sólo al borrarlo.</p>
</li>
<li>
<p>También podemos arrancar la aplicación con el perfil de postgres
    lanzando directamente el fichero JAR de la siguiente forma:</p>
<div class="highlight"><pre><span></span><code>$ ./mvnw package
$ java -Dspring.profiles.active=postgres -jar target/*.jar 
</code></pre></div>
<p>Para lanzar la aplicación desde <em>IntelliJ</em> trabajando con el nuevo
perfil podemos seleccionar la opción <code>Edit Configurations...</code> del
menú de configuraciones, duplicar la configuración <code>Application</code>,
renombrándola por <code>Application PostgreSQL</code> y añadir en el campo
<code>Active profiles</code> el nombre del perfil nuevo que acabamos de crear
<code>postgres</code>. Es posible que debas recargar el proyecto Maven para
actualizar las dependencias.</p>
</li>
<li>
<p>Cierra la aplicación. Paramos el contenedor con la base de datos de
   desarrollo haciendo <code>docker container stop postgres-develop</code>:</p>
<div class="highlight"><pre><span></span><code>$ docker container ls -a 
CONTAINER ID        IMAGE        ...    NAME
520fee61d51e        posgres:13   ...    postgres-develop
$ docker container stop postgres-develop
</code></pre></div>
<p>Además de por línea de comando, también es posible gestionar los
contenedores usando la aplicación <em>Docker Desktop</em> que se
encuentra en la propia instalación de Docker.</p>
</li>
<li>
<p>Vamos ahora a ver cómo lanzar los tests sobre una base de datos
   PostgreSQL. Lanzamos ahora otro contenedor con la base de datos de test (<code>mads_test</code>):</p>
<div class="highlight"><pre><span></span><code>docker run -d -p 5432:5432 --name postgres-test -e POSTGRES_USER=mads -e POSTGRES_PASSWORD=mads -e POSTGRES_DB=mads_test postgres:13
</code></pre></div>
<p>Y lanzamos los tests usando el perfil <code>postgres</code> con la base de datos PostgreSQL con el siguiente comando:</p>
<div class="highlight"><pre><span></span><code>./mvnw -D spring.profiles.active=postgres test
</code></pre></div>
</li>
<li>
<p>Podemos lanzar también los tests desde <em>IntelliJ</em> editando la
    configuración de lanzamiento de test y añadiendo la variable de
    entorno <code>spring.profiles.active=postgres</code>. Podríamos, por ejemplo,
    llamar a esta configuración <code>Tests con PostgreSQL</code>.</p>
</li>
<li>
<p>Dado que las configuraciones de test y de ejecución utilizan
    distintas bases de datos, debemos tener en funcionamiento la base
    de datos correspondiente a lo que queremos hacer en cada
    momento. Esto es muy fácil usando los contenedores de Docker. Por
    ejemplo, podemos parar el contenedor PostgreSQL con la base de datos
    de test y arrancar el contenedor con la base de datos de
    desarrollo:</p>
<div class="highlight"><pre><span></span><code>$ docker container ls -a 
$ docker container stop postgres-test
$ docker container start postgres-develop
</code></pre></div>
</li>
<li>
<p>Realiza un commit con los cambios, súbelos a la rama y cierra el
    pull request para integrarlo en <code>main</code>:</p>
<div class="highlight"><pre><span></span><code>$ (perfiles) git add .
$ (perfiles) git commit -m &quot;Añadidos perfiles para trabajar con PostgreSQL&quot;
$ (perfiles) git push
// Mezclamos el Pull Request en GitHub
$ (perfiles) git checkout main
$ (main) git pull
$ (main) git branch -d perfiles
$ (main) git remote prune origin
</code></pre></div>
</li>
</ol>
<h2 id="4-tests-de-integracion-en-github-actions">4. Tests de integración en GitHub Actions<a class="headerlink" href="#4-tests-de-integracion-en-github-actions" title="Permanent link">&para;</a></h2>
<p>Vamos a modificar la configuración de GitHub Actions para conseguir un
sistema de integración continua que ejecute los tests de integración
usando la base de datos real PostgreSQL.</p>
<p>La ejecución de los tests usando la base de datos de memoria H2 será
responsabilidad del desarrollador y se hará en el entorno de trabajo
local, tal y como se ha hecho desde la primera práctica.</p>
<h3 id="tests-del-desarrollador-vs-tests-de-integracion">Tests del desarrollador vs. tests de integración<a class="headerlink" href="#tests-del-desarrollador-vs-tests-de-integracion" title="Permanent link">&para;</a></h3>
<p>Podemos considerar los tests que usan la base de datos real como
<em>tests de integración</em> y los tests que usan la base de datos en
memoria como <em>tests del desarrollador</em>.</p>
<p>No usamos el nombre de <em>tests unitarios</em> de forma consciente, para
evitar conflictos con la nomenclatura. Cuando hablamos de <em>tests del
desarrollador</em> nos referimos a tests que van a ejecutar continuamente
los desarrolladores en su equipo local cuando están trabajando con la
aplicación y añadiendo funcionalidades. Son tests rápidos, que se
pueden lanzar desde el propio IDE, y que deben ser ejecutados antes de
cada commit.</p>
<p>Frente a estos tests, los tests de integración necesitan una
configuración adicional (poner en marcha la base de datos de test en
nuestro caso) y se ejecutan menos frecuentemente.</p>
<p>Vamos a actualizar GitHub Actions para que se lancen allí los tests
usando la base de datos PostgreSQL. De esta forma nosotros lanzaremos en
local los tests que usan la BD de memoria y los tests de integración
se lanzarán en GitHub cada vez que vaya a mezclarse un pull request.</p>
<h3 id="accion-para-lanzar-los-tests-con-la-bd-postgres">Acción para lanzar los tests con la BD postgres<a class="headerlink" href="#accion-para-lanzar-los-tests-con-la-bd-postgres" title="Permanent link">&para;</a></h3>
<p>Para lanzar los tests de integración en GitHub debemos modificar el
fichero de configuración del flujo de trabajo para que lance un
contenedor de PostgreSQL y después se ejecuten los tests sobre ese
contenedor.</p>
<p>Para tener más flexibilidad en la configuración de la conexión con
PostgreSQL vamos a modificar el perfil de Spring Boot, añadiendo unas
variables con unos valores por defecto que se pueden modificar
definiendo su valor en variables de entorno con el mismo nombre.</p>
<p>En concreto, definimos las variables <code>POSTGRES_HOST</code>, <code>POSTGRES_PORT</code>,
<code>DB_USER</code> y <code>DB_PASSWD</code>.</p>
<p><strong>Fichero <code>src/test/resources/application-postgres.properties</code></strong>:</p>
<div class="highlight"><pre><span></span><code>POSTGRES_HOST=localhost
POSTGRES_PORT=5432
DB_USER=mads
DB_PASSWD=mads
spring.datasource.url=jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/mads_test
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWD}
spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.PostgreSQL9Dialect
</code></pre></div>
<p>Ya podemos añadir un nuevo fichero de flujo de trabajo. Lo llamamos <code>integration-tests.yml</code></p>
<p><strong>Fichero <code>.github/workflows/integration-tests.yml</code></strong>:</p>
<div class="highlight"><pre><span></span><code>name: Integration tests

on: push

jobs:
  container-job:
    runs-on: ubuntu-latest
    container: openjdk:8-jdk-alpine
    services:
      # Etiqueta usada para acceder al contenedor del servicio
      postgres:
        # Imagen Docker Hub
        image: postgres:13
        # Variables para arrancar PostgreSQL
        env:
          POSTGRES_USER: mads
          POSTGRES_PASSWORD: mads
          POSTGRES_DB: mads_test
        # Definimos chequeos para esperar hasta que postgres ya ha comenzado
        options: &gt;-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v2
      - name: Launch tests with Maven
        run:  ./mvnw test -D spring.profiles.active=postgres
        env:
          POSTGRES_HOST: postgres
</code></pre></div>
<ul>
<li>
<p>Se especifica el servicio <code>postgres</code> que se va a usar en el flujo de
  trabajo. Para configurar este servicio se define la imagen docker
  (<code>postgres:13</code>) y las variables de entorno que se van a proporcionar
  al arrancar, para configurar la base de datos (usuario, contraseña y
  base de datos). Estamos definiendo un contenedor docker similar al
  que hemos usado con los tests cuando hicimos la prueba en local.</p>
</li>
<li>
<p>El nuevo comando de test activa el perfil <code>postgres</code>. Es el mismo
  comando que usamos cuando hicimos la prueba en local.</p>
</li>
<li>
<p>En la última línea se actualiza el parámetro <code>POSTGRES_HOST</code> para
  que la conexión se realice con el host <code>postgres</code> que es el que
  nombre que se ha definido en el servicio.</p>
</li>
</ul>
<h3 id="pasos-a-seguir_3">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_3" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Crea un nuevo issue llamado <code>Tests de integración en GitHub
Actions</code>. Crea la rama <code>integracion-gh-actions</code>.</p>
<div class="highlight"><pre><span></span><code>$ git checkout -b integracion-gh-actions
$ git push -u origin integracion-gh-actions
</code></pre></div>
</li>
<li>
<p>Modifica el fichero del perfil postgres de test tal y como se
   indica anteriormente, para usar variables de configuración que
   puedan ser definidas mediante variables de entorno.</p>
</li>
<li>
<p>Comprueba que siguen funcionando los tests lanzados sobre la base
   de datos usando los valores por defecto de las variables de
   entorno.</p>
<div class="highlight"><pre><span></span><code>// Nos aseguramos de que la base de datos que está en marcha
// es la de test
$ docker container ls
CONTAINER ID   IMAGE         PORTS                    NAMES
411d8f2ea46c   postgres:13   0.0.0.0:5432-&gt;5432/tcp   postgres-test
./mvnw -D spring.profiles.active=postgres test
</code></pre></div>
</li>
<li>
<p>Comprueba que podemos modificar los parámetros definidos en las
   variables de entorno. Por ejemplo, si se cambia el nombre del host
   de la conexión con la base de datos los tests deben de fallar:</p>
<div class="highlight"><pre><span></span><code>$ ./mvnw -D spring.profiles.active=postgres -D POSTGRES_HOST=postgres test
// Aparecerán errores debidos a que no se puede conectar con el
// host postgres:
org.postgresql.util.PSQLException: El intento de conexión falló.
...
Caused by: java.net.UnknownHostException: postgres
</code></pre></div>
</li>
<li>
<p>Crea un commit, súbelo a GitHub y crea el Pull Request</p>
<div class="highlight"><pre><span></span><code>$ git add .
$ git commit -m &quot;Añadidas variables al perfil de test postgres&quot;
$ git push
</code></pre></div>
</li>
<li>
<p>Añade el fichero del flujo de trabajo de la acción de GitHub,
   tal y como se indica anteriormente. Haz un commit, súbelo a GitHub
   y comprueba que los tests pasan correctamente y se lanzan allí
   usando la base de datos postgres.</p>
<p><img src="imagenes/pr-tests-integracion.png" width="600px"/></p>
<p><img src="imagenes/pr-tests-integracion-2.png" width="600px"/></p>
<p><img src="imagenes/pr-tests-integracion-3.png" width="600px"/></p>
<p><img src="imagenes/pr-tests-integracion-4.png" width="750px"/></p>
</li>
<li>
<p>Una vez comprobado que funcionan los tests de integración en
   GitHub, mezclamos el pull request y lo descargamos a
   local. Comprobamos que también se lanzan los tests en el commit de
   merge en GitHub. </p>
</li>
<li>
<p>Con esto ya tenemos completado un sistema de integración continua y
   GitHub se encargará de ejecutar todos los tests en un modo de
   integración, usando la base de datos PostgreSQL.</p>
</li>
</ol>
<h2 id="5-tdd">5. TDD<a class="headerlink" href="#5-tdd" title="Permanent link">&para;</a></h2>
<p>En la segunda parte de la práctica desarrollaremos, usando TDD (<em>Test
Driven Design</em>), una nueva <em>feature</em> de la aplicación: la posibilidad
de definir definir equipos a los que puedan pertenecer los usuarios.</p>
<p>Descomponemos la <em>feature</em> en las siguientes historias de usuario.</p>
<ul>
<li>008 Listado de equipos</li>
<li>009 Gestionar pertenencia al equipo</li>
<li>010 Gestión de equipos (opcional)</li>
</ul>
<p><strong>008 Listado de equipos</strong>: Como usuario podré consultar el listado de
los equipos existentes y los participantes en cada uno de ellos para
poder consultar la estructura de la empresa y los proyectos en marcha
y comprobar si estoy en los equipos correctos.</p>
<p><strong>009 Gestionar pertenencia al equipo</strong>: Como usuario podré crear
nuevos equipos y añadirme y eliminarme de cualquiera de ellos para poder
participar y dejar de participar en ellos.</p>
<p><strong>010 Gestión de equipos (opcional)</strong>: Como administrador podré
cambiar el nombre y eliminar los equipos para adaptarlos a los
proyectos y estructura de la empresa.</p>
<p>Vamos a hacer de forma guiada la primera historia y dejamos las
siguientes para que las hagas por tu cuenta.</p>
<h3 id="008-listado-de-equipos">008 Listado de equipos<a class="headerlink" href="#008-listado-de-equipos" title="Permanent link">&para;</a></h3>
<p>La descripción de la historia de usuario es la siguiente:</p>
<div class="highlight"><pre><span></span><code>Listado de equipos

Como usuario podré consultar el listado de
los equipos existentes y los participantes en cada uno de ellos para
poder consultar la estructura de la empresa y los proyectos en marcha
y comprobar si estoy en los equipos correctos.

Detalles

    * En el menú aparcerá una opción `Equipos` que llevará a un
    listado con los nombres de todos los equipos existentes.
    * El listado de equipos estará ordenado por orden alfabético.
    * Pinchando en el enlace del nombre del equipo nos iremos a una
    página con un listado de todos los usuarios que lo componen.
    * Un usuario podrá pertenecer a más de un equipo.
</code></pre></div>
<p>Vamos a utilizar la técnica de TDD para construir la funcionalidad
<strong>de dentro a fuera</strong> (desde el repository hasta el
controller). Comenzaremos con tests que construyan la capa de modelo
(clases de entidad y repository) y después pasaremos a tests que
construyan la capa de servicio. </p>
<p>Por último, una vez implementados los métodos de servicios necesarios,
deberás implementar (lo haremos sin tests) las vistas y
controllers. Las vistas y controllers los probaremos de forma manual,
sin tests automáticos.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Los controllers no deben implementar ningún código adicional, sólo
llamar al método de servicio necesario. De esta forma nos
aseguramos que todo el código importante para la funcionalidad está
testeado y ha sido creado mediante TDD.</p>
</div>
<p>Probaremos los tests usando la base de datos de memoria y dejaremos
que sea la acción de GitHub la que pruebe los tests con la base de
datos Postgres.</p>
<p>Recuerda que los pasos seguir la técnica de TDD:</p>
<ul>
<li><strong>Test</strong>: Primero debes escribir el test.</li>
<li><strong>Code</strong>: Después debes escribir el código que hace pasar el test (<strong>únicamente el código
necesario, no puedes escribir código de más</strong>)</li>
<li><strong>Refactor</strong>: Y, si es necesario, realizar una refactorización del código (los
  tests deben seguir pasando después de la refactorización).</li>
</ul>
<p>Deberás hacer <strong>un commit por cada fase Test-Code</strong>. Si haces
refactorización deberás hacerlo en otro commit adicional.</p>
<h3 id="pasos-a-seguir_4">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_4" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>Crea la historia de usuario <code>008 Listado de equipos</code> en el tablero Trello.</p>
</li>
<li>
<p>Crea dos <em>issues</em> correspondientes a esta historia:</p>
<ul>
<li>Servicio y modelo listado de equipos.</li>
<li>Vista y controller listado de equipos.</li>
</ul>
</li>
<li>
<p>Crea una rama para desarrollar el primer <em>issue</em> (llámala
  <code>servicio-equipos</code>, por ejemplo) y pásalo en el
  tablero a <code>In progress</code>.</p>
<div class="highlight"><pre><span></span><code>$ git checkout -b servicio-equipos
$ git push -u origin servicio-equipos
</code></pre></div>
</li>
</ul>
<p>Este primer <em>issue</em> lo haremos de forma guiada usando TDD con los
tests que enumeraremos a continuación. El otro <em>issue</em> lo deberás
implementar por ti mismo. </p>
<h4 id="primer-commit-clase-equipo">Primer commit - Clase <code>Equipo</code><a class="headerlink" href="#primer-commit-clase-equipo" title="Permanent link">&para;</a></h4>
<p>El primer test es para crear la entidad <code>Equipo</code>. Por ahora sólo
creamos la clase Java, sin las anotaciones JPA. Un equipo</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoTest.java</code></strong>:
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">madstodolist</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.jdbc.Sql</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.springframework.test.context.jdbc.Sql.ExecutionPhase.AFTER_TEST_METHOD</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span> <span class="o">=</span> <span class="s">&quot;/clean-db.sql&quot;</span><span class="p">,</span> <span class="n">executionPhase</span> <span class="o">=</span> <span class="n">AFTER_TEST_METHOD</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoTest</span> <span class="p">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">crearEquipo</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto P1&quot;</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getNombre</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Proyecto P1&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Escribe el código necesario para que pase el test. <strong>No debes escribir
código de más, sólo el código mínimo para que el test pase</strong>. </p>
<p>Haz un <em>commit</em> que contenga el test y el código y súbelo a la rama
remota. Pon como descripción del commit el mismo título de esta
sección: <em>Primer commit - Clase Equipo</em>.</p>
<div class="highlight"><pre><span></span><code>$ git add .
$ git commit -m &quot;Primer commit - Clase Equipo&quot;
</code></pre></div>
<p>Crea el pull request para comprobar que el test pasa correctamente
cuando se ejecuta sobre la base de datos Postgres. Liga el pull
request con el issue, para que cuando se mezcle el PR se cierre el
issue.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Debes incluir en el commit tanto el código del test como el código
que soluciona el test, de forma que el commit aparezca como
correcto en GitHub.</p>
</div>
<h4 id="segundo-test-anadir-y-buscar-equipo-en-la-base-de-datos">Segundo test - Añadir y buscar equipo en la base de datos<a class="headerlink" href="#segundo-test-anadir-y-buscar-equipo-en-la-base-de-datos" title="Permanent link">&para;</a></h4>
<p>Con el segundo test queremos conseguir que funcione JPA con la entidad
<code>Equipo</code> y que podamos usar una tabla de equipos en la base de datos,
en la que podamos guardar entidades <code>equipo</code>. </p>
<p>Para comprobar que la entidad se ha guardado correctamente,
comprobaremos se ha actualizando su identificador y que podemos
recuperarlo de la base de datos.</p>
<p>Lo hacemos añadiendo el test <code>grabarYBuscarEquipo</code>. Usaremos la
anotación <code>@Transactional</code> siempre que trabajemos con clases
<em>repository</em>. De esa forma nos aseguramos que todo el código del test
se ejecuta en la misma transacción. Cuando escribamos el código del
servicio también habrá que usar esta anotación en cada método, tal y
como se hace en las clases de servicio de <code>Tarea</code> y <code>Usuario</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">grabarYBuscarEquipo</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Un equipo nuevo</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto P1&quot;</span><span class="p">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Salvamos el equipo en la base de datos</span>
        <span class="n">equipoRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">equipo</span><span class="p">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Su identificador se ha actualizado y lo podemos</span>
        <span class="c1">// usar para recuperarlo de la base de datos</span>
        <span class="n">Long</span> <span class="n">equipoId</span> <span class="o">=</span> <span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">();</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipoId</span><span class="p">).</span><span class="na">isNotNull</span><span class="p">();</span>
        <span class="n">Equipo</span> <span class="n">equipoDB</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">equipoId</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipoDB</span><span class="p">).</span><span class="na">isNotNull</span><span class="p">();</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipoDB</span><span class="p">.</span><span class="na">getNombre</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Proyecto P1&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>Actualizamos también el fichero <code>clean-db.sql</code> para que se borre la
tabla <code>equipos</code> al final de cada test.</p>
<p><strong>Fichero <code>src/test/resources/clean-db.sql</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">tareas</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">equipos</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">usuarios</span><span class="p">;</span>
</code></pre></div>
<p>Escribe el código necesario para pase el test y haz un commit con
el nombre del apartado como descripción. Súbelo a GitHub y comprueba
en el pull request que el test pasa correctamente en el entorno de
integración.</p>
<h4 id="tercer-test-definicion-de-igualdad-entre-equipos">Tercer test - Definición de igualdad entre equipos<a class="headerlink" href="#tercer-test-definicion-de-igualdad-entre-equipos" title="Permanent link">&para;</a></h4>
<p>Ahora que hemos introducido el <code>id</code> del equipo escribimos un test
para comprobar que dos equipos son iguales. Debes escribir el código
de los métodos <code>equals</code> y <code>hashCode</code> (necesario este último para que
funcione correctamente la comprobación de igualdades en las
colecciones).</p>
<p>Hacemos los tests para que el <code>equals</code> funcione de la siguiente forma:</p>
<blockquote>
<p>Si alguno de los dos equipos no tiene <code>id</code> (es <code>null</code>), entonces se
deben comparar sus nombres. Ahora bien, si los dos equipos tienen
<code>id</code>, entonces se deben comparar esos <code>id</code>".</p>
</blockquote>
<p>Puedes guiarte por la implementación de <code>equals</code> y <code>hashCode</code> en
<code>Usuario</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarIgualdadEquipos</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Creamos tres equipos sin id, sólo con el nombre</span>
        <span class="n">Equipo</span> <span class="n">equipo1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto P1&quot;</span><span class="p">);</span>
        <span class="n">Equipo</span> <span class="n">equipo2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto P2&quot;</span><span class="p">);</span>
        <span class="n">Equipo</span> <span class="n">equipo3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto P2&quot;</span><span class="p">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Comprobamos igualdad basada en el atributo nombre y que el</span>
        <span class="c1">// hashCode es el mismo para dos equipos con igual nombre</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo1</span><span class="p">).</span><span class="na">isNotEqualTo</span><span class="p">(</span><span class="n">equipo2</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo2</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">equipo3</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo2</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">equipo3</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Añadimos identificadores y comprobamos igualdad por identificadores</span>
        <span class="n">equipo1</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
        <span class="n">equipo2</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
        <span class="n">equipo3</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Comprobamos igualdad basada en el atributo nombre</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo1</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">equipo2</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo2</span><span class="p">).</span><span class="na">isNotEqualTo</span><span class="p">(</span><span class="n">equipo3</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>Escribe el código necesario para que pase el test y haz un commit.</p>
<h4 id="cuarto-test-relacion-muchos-a-muchos-entre-equipos-y-usuarios">Cuarto test - Relación muchos-a-muchos entre equipos y usuarios<a class="headerlink" href="#cuarto-test-relacion-muchos-a-muchos-entre-equipos-y-usuarios" title="Permanent link">&para;</a></h4>
<p>Vamos ahora a diseñar un test que introduzca la relación entre equipos
y usuarios. Debe ser una relación muchos-a-muchos: un equipo contiene
muchos usuarios y un usuario puede pertenecer a 0, 1 o muchos equipos.</p>
<p>En el test hacemos varias cosas: creamos un equipo y un usuario,
añadimos el usuario al equipo y comprobamos que las relaciones se han
actualizado en la base de datos.</p>
<p>De la misma forma que en un test anterior, añadimos la anotación
<code>@Transactional</code> para que todas las llamadas a objetos <em>repository</em> se
hagan en la misma transacción y con la misma conexión a la base de
datos.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UsuarioRepository</span> <span class="n">usuarioRepository</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRelacionBaseDatos</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Un equipo y un usuario en la BD</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto 1&quot;</span><span class="p">);</span>
        <span class="n">equipoRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">equipo</span><span class="p">);</span>

        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
        <span class="n">usuarioRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Añadimos el usuario al equipo</span>

        <span class="n">equipo</span><span class="p">.</span><span class="na">addUsuario</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

        <span class="c1">// THEN</span>
        <span class="c1">// La relación entre usuario y equipo pqueda actualizada en BD</span>

        <span class="n">Equipo</span> <span class="n">equipoBD</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">()).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="n">Usuario</span> <span class="n">usuarioBD</span> <span class="o">=</span> <span class="n">usuarioRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">()).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getUsuarios</span><span class="p">()).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getUsuarios</span><span class="p">()).</span><span class="na">contains</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getEquipos</span><span class="p">()).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getEquipos</span><span class="p">()).</span><span class="na">contains</span><span class="p">(</span><span class="n">equipo</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>Para que este test funcione hay que crear la relación muchos-a-muchos
entre equipos y usuarios.  Es necesario definir la anotación
<code>@ManyToMany</code> para indicar a JPA cómo construir las tablas en la base
de datos. Vamos a crear esta relación como <code>LAZY</code>, porque si fuera
<code>EAGER</code> la recuperación de equipos de la base de datos sería muy
costosa, traería a memoria todos sus usuarios (con sus tareas incluidas).</p>
<p>En <code>Equipo.java</code> definimos la tabla <code>equipo_usuario</code> en la que se va a
guardar la relación, e indicamos el papel de cada una de sus dos
columnas.</p>
<p>También creamos el getter para obtener los usuarios. </p>
<p><strong>Fichero <code>src/main/java/madstodolist/model/Equipo.java</code></strong>:
<div class="highlight"><pre><span></span><code><span class="gi">+    private String nombre;</span>
<span class="gi">+    // Declaramos el tipo de recuperación como LAZY.</span>
<span class="gi">+    // No haría falta porque es el tipo por defecto en una</span>
<span class="gi">+    // relación a muchos.</span>
<span class="gi">+    // Al recuperar un equipo NO SE RECUPERA AUTOMÁTICAMENTE</span>
<span class="gi">+    // la lista de usuarios. Sólo se recupera cuando se accede al</span>
<span class="gi">+    // atributo &#39;usuarios&#39;; entonces se genera una query en la</span>
<span class="gi">+    // BD que devuelve todos los usuarios del equipo y rellena el</span>
<span class="gi">+    // atributo.</span>
<span class="gi">+     </span>
<span class="gi">+    @ManyToMany(fetch = FetchType.LAZY)</span>
<span class="gi">+    @JoinTable(name = &quot;equipo_usuario&quot;,</span>
<span class="gi">+            joinColumns = { @JoinColumn(name = &quot;fk_equipo&quot;) },</span>
<span class="gi">+            inverseJoinColumns = {@JoinColumn(name = &quot;fk_usuario&quot;)})</span>
<span class="gi">+    Set&lt;Usuario&gt; usuarios = new HashSet&lt;&gt;();</span>

...

    public void setId(Long id) {
        this.id = id;
    }

<span class="gi">+    public Set&lt;Usuario&gt; getUsuarios() {</span>
<span class="gi">+        return usuarios;</span>
<span class="gi">+    }</span>
</code></pre></div></p>
<p>En el fichero <code>Usuario.java</code> definimos la parte inversa de la
relación. El <code>mappedBy</code> indica que la especificación de la tabla join
está en el otro lado de la relación. Esta relación la definimos como
<code>EAGER</code> porque el otro lado de la relación es <code>LAZY</code>. Al recuperar un
usuario solo se van a traer a memoria la información de sus equipos.</p>
<p><strong>Fichero <code>src/main/java/madstodolist/model/Usuario.java</code></strong>:
<div class="highlight"><pre><span></span><code>    @OneToMany(mappedBy = &quot;usuario&quot;, fetch = FetchType.EAGER)
    Set&lt;Tarea&gt; tareas = new HashSet&lt;&gt;();

<span class="gi">+    @ManyToMany(mappedBy = &quot;usuarios&quot;)</span>
<span class="gi">+    Set&lt;Equipo&gt; equipos = new HashSet&lt;&gt;();</span>

...

<span class="gi">+    public Set&lt;Equipo&gt; getEquipos() {</span>
<span class="gi">+        return equipos;</span>
<span class="gi">+    }</span>
</code></pre></div></p>
<p>Y por último añadimos en <code>Equipo.java</code> el método que actualiza ambos
lados de la relación. Añade el usuario a la colección de usuarios del
equipo y añade el equipo a la colección de equipos del usuario.</p>
<div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUsuario</span><span class="p">(</span><span class="n">Usuario</span> <span class="n">usuario</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="na">getUsuarios</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>
        <span class="n">usuario</span><span class="p">.</span><span class="na">getEquipos</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>También actualizamos el fichero de limpieza de datos al final de cada
test, para añadir la nueva tabla <code>equipo_usuario</code>.</p>
<p><strong>Fichero <code>src/test/resources/clean-db.sql</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">equipo_usuario</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">tareas</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">equipos</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">usuarios</span><span class="p">;</span>
</code></pre></div>
<p>Comprueba el test, haz un commit en la rama y súbelo a GitHub.</p>
<h4 id="quinto-test-listado-de-equipos">Quinto test - Listado de equipos<a class="headerlink" href="#quinto-test-listado-de-equipos" title="Permanent link">&para;</a></h4>
<p>Vamos ahora a definir un test para obtener una lista de equipos en el
<em>repository</em>. Queremos que el tipo devuelto por el <em>repository</em>
sea <em>List</em>.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Test</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarFindAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Dos equipos en la base de datos</span>
        <span class="n">equipoRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto 2&quot;</span><span class="p">));</span>
        <span class="n">equipoRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span> <span class="n">Equipo</span><span class="p">(</span><span class="s">&quot;Proyecto 3&quot;</span><span class="p">));</span>

        <span class="c1">// WHEN</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>

        <span class="c1">// THEN</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipos</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>La solución consiste en añadir el método <code>findAll</code> en la interfaz
p<code>EquipoRepository</code>, definiendo el tipo devuelto como <em>List</em>. Spring
Boot se encarga de construir automáticamente la implementación de este
método.</p>
<p><strong>Fichero <code>EquipoRepository.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="gi">+ import java.util.List;</span>

public interface EquipoRepository extends CrudRepository&lt;Equipo, Long&gt; {
<span class="gi">+     public List&lt;Equipo&gt; findAll();</span>
}
</code></pre></div>
<h4 id="sexto-test-metodo-de-servicio-para-crear-y-recuperar-equipo">Sexto test - Método de servicio para crear y recuperar equipo<a class="headerlink" href="#sexto-test-metodo-de-servicio-para-crear-y-recuperar-equipo" title="Permanent link">&para;</a></h4>
<p>¡Y por fin llegamos a la capa de servicio!</p>
<p>Creamos el fichero <code>EquipoServiceTest.java</code> con la llamada al método
de servicio para crear un equipo nuevo y a otro método de servicio
para recuperar un equipo por su identificador.</p>
<p>Lo hacemos todo en el método <code>crearRecuperarTest</code>. En el test no hay
que añadir la anotación <code>@Transactional</code> porque queremos probar el uso
de los métodos de servicio en un contexto similar al que usaremos
cuando los llamemos desde el controller. Cuando llamemos desde el
controller a los métodos de servicio no se usará la anotación
<code>@Transactional</code> para evitar en el código del controller se pueda
acceder a los objetos repository y modificar directamente la base de
datos.</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">madstodolist</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">madstodolist.model.Equipo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">madstodolist.service.EquipoService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.jdbc.Sql</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="p">;</span>
<span class="kn">import static</span> <span class="nn">org.springframework.test.context.jdbc.Sql.ExecutionPhase.AFTER_TEST_METHOD</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@Sql</span><span class="p">(</span><span class="n">scripts</span> <span class="o">=</span> <span class="s">&quot;/clean-db.sql&quot;</span><span class="p">,</span> <span class="n">executionPhase</span> <span class="o">=</span> <span class="n">AFTER_TEST_METHOD</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoServiceTest</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">EquipoService</span> <span class="n">equipoService</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">crearRecuperarEquipo</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">crearEquipo</span><span class="p">(</span><span class="s">&quot;Proyecto 1&quot;</span><span class="p">);</span>
        <span class="n">Equipo</span> <span class="n">equipoBd</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">recuperarEquipo</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipoBd</span><span class="p">).</span><span class="na">isNotNull</span><span class="p">();</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipoBd</span><span class="p">.</span><span class="na">getNombre</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Proyecto 1&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Para que funcione correctamente el test tenemos que crear la clase
<code>EquipoService</code> con los métodos <code>crearEquipo</code> y
<code>recuperarEquipo</code>. Completa el código en los lugares indicados.</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nn">madstodolist.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">madstodolist.model.Equipo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">madstodolist.model.EquipoRepository</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EquipoService</span> <span class="p">{</span>
    <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">EquipoService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

    <span class="nd">@Autowired</span>
    <span class="n">EquipoRepository</span> <span class="n">equipoRepository</span><span class="p">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">crearEquipo</span><span class="p">(</span><span class="n">String</span> <span class="n">nombre</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Completar</span>
    <span class="p">}</span>

    <span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Equipo</span> <span class="nf">recuperarEquipo</span><span class="p">(</span><span class="n">Long</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Completar</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Tal y como hemos comentado, la anotación <code>@Transactional</code> se usa en
los métodos de servicio en los que se trabaja con objetos <em>repository</em>
para asegurarnos de que todo el código del método se ejecuta en la
misma transacción y usando la misma conexión a la base de datos.</p>
<p>En aquellos métodos en los que no se modifica la base de datos (sólo
se realiza una consulta) es recomendable utilizar la anotación con el
atributo <code>readOnly = true</code> para hacer más eficiente la conexión con la
base de datos.</p>
<h4 id="septimo-test-metodo-de-servicio-para-el-listado-de-equipos">Séptimo test - Método de servicio para el listado de equipos<a class="headerlink" href="#septimo-test-metodo-de-servicio-para-el-listado-de-equipos" title="Permanent link">&para;</a></h4>
<p>Añadimos el test que obliga a crear el método de servicio que recupera
la lista de equipos existentes, ordenada por orden alfabético del
nombre del equipo:</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listadoEquiposOrdenAlfabetico</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Dos equipos en la base de datos</span>
        <span class="n">equipoService</span><span class="p">.</span><span class="na">crearEquipo</span><span class="p">(</span><span class="s">&quot;Proyecto BBB&quot;</span><span class="p">);</span>
        <span class="n">equipoService</span><span class="p">.</span><span class="na">crearEquipo</span><span class="p">(</span><span class="s">&quot;Proyecto AAA&quot;</span><span class="p">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Recuperamos los equipos</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Equipo</span><span class="o">&gt;</span> <span class="n">equipos</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">findAllOrderedByName</span><span class="p">();</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Los equipos están ordenados por nombre</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipos</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipos</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getNombre</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Proyecto AAA&quot;</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">equipos</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">getNombre</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Proyecto BBB&quot;</span><span class="p">);</span>        
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Escribe en el servicio el código estríctamente necesario para que
pase el test. Haz un commit en la rama y súbelo a GitHub.</p>
<h4 id="octavo-test-comprobacion-de-relacion-lazy-entre-equipo-y-usuarios">Octavo test - Comprobación de relación lazy entre equipo y usuarios<a class="headerlink" href="#octavo-test-comprobacion-de-relacion-lazy-entre-equipo-y-usuarios" title="Permanent link">&para;</a></h4>
<p>Vamos a centrar este test en la forma de traer a memoria los objetos
que participan en la relación <code>USUARIO-EQUIPO</code>. </p>
<p>En JPA hay dos formas de definir una relación a-muchos:</p>
<ul>
<li>
<p><code>EAGER</code>: Si una relación a-muchos es <code>EAGER</code>, cuando la clase
  repository devuelve un objeto (ya sea al recuperarlo
  individualmente, o en una consulta en la que se recupera una
  colección), se obtienen también de la base de datos todos los
  objetos con los que está relacionado. Por ejemplo, en la práctica
  tenemos definida de esta forma la relación entre usuarios y tareas.</p>
</li>
<li>
<p><code>LAZY</code>: Si una relación a-muchos es <code>LAZY</code>, cuando la clase
  repository devuelve un objeto, no recupera de la base de datos los
  objetos relacionados. Sólo lo hace cuando se accede a la colección
  que contiene la relación. Entonces es cuando se realiza la consulta
  a la base de datos y se traen estos objetos a memoria. Si estos
  objetos tienen otras relaciones se traerán a memoria o no
  dependiendo de si son <code>EAGER</code> o <code>LAZY</code>.</p>
</li>
</ul>
<p>Para que funcione la recuperación perezosa debe estar abierta la
  conexión con la base de datos en el momento en que se accede a la
  colección. Para ello es muy importante la etiqueta
  <code>@Transactional</code>. Cuando ponemos esta etiqueta en los métodos de las
  clases de servicio se garantiza que todo el método se realiza en una
  única transacción. Por ello, al finalizar el método se cerrará la
  conexión con la base de datos y el objeto que se devolverá al
  <em>controller</em> <strong>estará desconectado de la base de datos</strong>, por lo que
  la recuperación perezosa no funcionará en el <em>controller</em>.</p>
<p>En el caso de la relación USUARIO-EQUIPO hemos definido el siguiente
diseño:</p>
<ul>
<li>
<p>La relación entre un usuario y sus equipos será <code>EAGER</code>. Cuando
  recuperamos un usuario, recuperaremos también la información de
  todos los equipos en los que participa. Esta parte de la relación
  está pendiente de implementar. Lo haremos más adelante.</p>
</li>
<li>
<p>La relación entre un equipo y sus usuarios es <code>LAZY</code>. Esto es muy
  importante. Si no lo hiciéramos así ¡podríamos fácilmente traernos a
  memoria toda la base de datos!. Un equipo recuperaría todos sus
  usuarios, que también pueden estar en otros equipos, que a su vez
  también se traerían a memoria. </p>
</li>
</ul>
<p>Vamos a comprobar que la relación entre equipos y usuarios es
<code>LAZY</code>. Para ello debemos comprobar que se lanza una excepción cuando
se intenta acceder a la colección de usuarios de un equipo recuperado:</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accesoUsuariosGeneraExcepcion</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Given</span>
        <span class="c1">// Un equipo en la base de datos</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">crearEquipo</span><span class="p">(</span><span class="s">&quot;Proyecto 1&quot;</span><span class="p">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Se recupera el equipo</span>
        <span class="n">Equipo</span> <span class="n">equipoBd</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">recuperarEquipo</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Se produce una excepción al intentar acceder a sus usuarios</span>
        <span class="n">assertThatThrownBy</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">equipoBd</span><span class="p">.</span><span class="na">getUsuarios</span><span class="p">().</span><span class="na">size</span><span class="p">();</span>
        <span class="p">}).</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">LazyInitializationException</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>Comprueba si hay que modificar el código, haz un commit y súbelo a
GitHub.</p>
<h4 id="noveno-test-metodo-de-servicio-para-anadir-un-usuario-a-un-equipo">Noveno test - Método de servicio para añadir un usuario a un equipo<a class="headerlink" href="#noveno-test-metodo-de-servicio-para-anadir-un-usuario-a-un-equipo" title="Permanent link">&para;</a></h4>
<p>Vamos a crear un test que nos obligue a implementar el método de
servicio para añadir un usuario a un equipo. Para comprobar su
funcionamiento deberemos implementar también el método de servicio
para recuperar los usuarios de un equipo.</p>
<p>El test es el siguiente.</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actualizarRecuperarUsuarioEquipo</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Un equipo creado en la base de datos y un usuario registrado</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">crearEquipo</span><span class="p">(</span><span class="s">&quot;Proyecto 1&quot;</span><span class="p">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
        <span class="n">usuario</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">);</span>
        <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="p">.</span><span class="na">registrar</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Añadimos el usuario al equipo y lo recuperamos</span>
        <span class="n">equipoService</span><span class="p">.</span><span class="na">addUsuarioEquipo</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Usuario</span><span class="o">&gt;</span> <span class="n">usuarios</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">usuariosEquipo</span><span class="p">(</span><span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>

        <span class="c1">// THEN</span>
        <span class="c1">// El usuario se ha recuperado correctamente</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">usuarios</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">usuarios</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getEmail</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>Implementa los métodos de servicio necesarios para que el test pase
correctamente. Haz un commit y súbelo a GitHub.</p>
<h4 id="decimo-test-recuperacion-eager-de-equipos">Décimo test - Recuperación <em>eager</em> de equipos<a class="headerlink" href="#decimo-test-recuperacion-eager-de-equipos" title="Permanent link">&para;</a></h4>
<p>Y, por último, hacemos un test para que un usuario recupere de
forma <em>eager</em> sus equipos. Si recuperamos un usuario con cualquier
método de servicio (por ejemplo, <code>usuarioService.findById</code>), el
usuario debe ser devuelto con la colección con sus equipos
actualizada.</p>
<p><strong>Fichero <code>src/test/java/madstodolist/EquipoServiceTest.java</code></strong>:</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">comprobarRelacionUsuarioEquipos</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// GIVEN</span>
        <span class="c1">// Un equipo creado en la base de datos y un usuario registrado</span>
        <span class="n">Equipo</span> <span class="n">equipo</span> <span class="o">=</span> <span class="n">equipoService</span><span class="p">.</span><span class="na">crearEquipo</span><span class="p">(</span><span class="s">&quot;Proyecto 1&quot;</span><span class="p">);</span>
        <span class="n">Usuario</span> <span class="n">usuario</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Usuario</span><span class="p">(</span><span class="s">&quot;user@ua&quot;</span><span class="p">);</span>
        <span class="n">usuario</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;123&quot;</span><span class="p">);</span>
        <span class="n">usuario</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="p">.</span><span class="na">registrar</span><span class="p">(</span><span class="n">usuario</span><span class="p">);</span>

        <span class="c1">// WHEN</span>
        <span class="c1">// Añadimos el usuario al equipo y lo recuperamos</span>
        <span class="n">equipoService</span><span class="p">.</span><span class="na">addUsuarioEquipo</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">equipo</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="n">Usuario</span> <span class="n">usuarioBD</span> <span class="o">=</span> <span class="n">usuarioService</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">usuario</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>

        <span class="c1">// THEN</span>
        <span class="c1">// Se recuperan también los equipos del usuario,</span>
        <span class="c1">// porque la relación entre usuarios y equipos es EAGER</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">usuarioBD</span><span class="p">.</span><span class="na">getEquipos</span><span class="p">()).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>El test fallará, porque debes de cambiar algo en la definición de la
relación entre usuarios y equipos. Modifica el código para que el test
pase, haz un commit y súbelo a GitHub.</p>
<h4 id="cierre-del-issue">Cierre del <em>issue</em><a class="headerlink" href="#cierre-del-issue" title="Permanent link">&para;</a></h4>
<p>Cuando hayas terminado todos los ciclos de TDD anteriores habrás
terminado el <em>issue</em> y testeado e implementado los métodos necesarios
para la clase de servicio que gestiona el listado de equipos y
usuarios de esos equipos.</p>
<ul>
<li>Comprueba que el pull request esté listo para mezclar (GitHub
Actions pasa correctamente todos los tests) y realiza la mezcla para
intégralo en <code>main</code> en GitHub. Comprueba que el issue asociado se
ha cerrado y baja los cambios al repositorio local.</li>
</ul>
<h4 id="vista-y-controller-listado-de-equipos">Vista y controller listado de equipos<a class="headerlink" href="#vista-y-controller-listado-de-equipos" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Abre un nuevo <em>issue</em> para implementar el controller y las vistas
que permitan listar los equipos y consultar sus miembros (por ejemplo,
pulsando en un enlace en el nombre del equipo o con un botón en el listado).</p>
</li>
<li>
<p>Realiza el desarrollo del <em>issue</em> usando varios commits en los que
  añadas las funcionalidades poco a poco. No hace falta que hagas TDD,
  pero añade pruebas para cada método del controller.</p>
</li>
</ul>
<h3 id="resto-de-historias-de-usuario">Resto de historias de usuario<a class="headerlink" href="#resto-de-historias-de-usuario" title="Permanent link">&para;</a></h3>
<p>Debes implementar la historia de usuario de la misma forma que hemos
implementado la anterior.</p>
<ul>
<li><strong>009 Gestionar pertenencia al equipo</strong>: Como usuario podré crear
nuevos equipos y añadirme y eliminarme de cualquiera de ellos para poder
participar y dejar de participar en ellos.</li>
</ul>
<p>Los métodos de servicio para crear equipos o para añadir un usuario a
un equipo ya han sido implementados en la historia anterior, por lo
que puedes usar esta historia para mejorarlos. Por ejemplo, lanzar
excepciones si la cadena del nombre es vacía o si no existe el usuario
o el equipo.</p>
<div class="admonition important">
<p class="admonition-title">Importante detalle de implementación</p>
<p>En una relación muchos-a-muchos como la que
existe entre <code>Usuario</code> y <code>Equipo</code> cuando se añade un usuario a un
equipo hay que actualizar ambos lados de la relación, porque
JPA/Hibernate no lo hace automáticamente. En el código de
la historia anterior al añadir el usuario a la colección de 
usuarios del equipo y también añadíamos el equipo a la colección
de equipos del usuario. Lo mismo habría que hacer cuando se 
elimina un usuario de un equipo.</p>
</div>
<ul>
<li><strong>010 Gestión de equipos (opcional)</strong>: Como administrador puedo
cambiar el nombre y eliminar los equipos para adaptarlos a los
proyectos y estructura de la empresa.</li>
</ul>
<h3 id="pasos-a-seguir_5">Pasos a seguir<a class="headerlink" href="#pasos-a-seguir_5" title="Permanent link">&para;</a></h3>
<ul>
<li>Implementa cada historia de usuario usando el mismo proceso que
  hemos utilizado para la historia 008. Deberás pensar qué servicios
  son necesarios para la historia y cómo implementarlos haciendo TDD.</li>
</ul>
<p>Para cada historia haz dos <em>issues</em>: uno con TDD para implementar la
  capa de servicio y repository y otro sin TDD para la capa de
  controller y vista.</p>
<p>Cuando estés haciendo TDD completa el código para pasar los tests,
  uno a uno, <strong>haciendo un commit después de cada fase test-code</strong> y
  otro commit en la fase <strong>refactor</strong> (en el caso en que tengas que
  hacer refactorización). </p>
<p>Los incrementos de código introducidos por los tests deben ser
  pequeños. Debe haber <strong>entre 15 y 25 líneas de código</strong> añadidas en
  las fases de codificación (sin contar el código de los tests). No
  tomes este número de forma demasiado estricta; si en algún ciclo hay
  que añadir 35 líneas no pasa nada. Tampoco si haces menos
  de 15. Pero estaría mal tener que añadir 70 líneas para resolver un
  test.</p>
<ul>
<li>Cuando termines las historias de usuario (ve moviéndolas también en
  el tablero de Trello) haz el release 1.2.0 con la entrega final de
  la práctica.</li>
</ul>
<h2 id="6-documentacion-entrega-y-evaluacion">6. Documentación, entrega y evaluación<a class="headerlink" href="#6-documentacion-entrega-y-evaluacion" title="Permanent link">&para;</a></h2>
<p>Deberás añadir una página de documentación <code>/doc/practica3.md</code> en la
que, al igual que en la práctica anterior, debes realizar una <strong>breve
documentación técnica</strong> de entre 500 y 800 palabras sobre lo
implementado en las historias de usuario 009 y 010.</p>
<p>En la documentación debes incluir también una <strong>captura de pantalla</strong>
en la que se muestren las tablas de la base de datos de desarrollo
PostgreSQL en la versión final de la aplicación. Puedes mostrar, por
ejempo, una pantalla con el panel <code>Database</code> de <em>IntelliJ</em> o la
herramienta que hayas utilizado.</p>
<p>Por ejemplo, puedes incluir en la documentación lo siguiente. Los
puntos 2 en adelante son sobre las <strong>historias de usuario 009 y 010</strong>.</p>
<ol>
<li>Pantalla de la base de datos PostgreSQL.</li>
<li>Rutas (endpoints) definidas para las acciones y, para cada endpoint o grupo de endpoints,
   explicación sobre:<ol>
<li>Clases y métodos</li>
<li>Plantillas thymeleaf</li>
<li>Tests</li>
</ol>
</li>
<li>Explicación de algunos fragmentos de código fuente que consideres
   interesante en las nuevas funcionalidades implementadas.</li>
</ol>
<p>Intenta que el documento tenga un formato limpio y se pueda leer
fácilmente. Para eso utiliza los bloques de código de Markdown. Puedes
mirar como ejemplo el código Markdown de estas prácticas.</p>
<p>Por ejemplo, el código Markdown de la <a href="https://github.com/domingogallardo/practicas-mads/blob/main/docs/01-intro-spring-boot/intro-spring-boot.md">introducción a Spring
Boot</a>
se puede ver pulsando el botón <code>Raw</code>. Verás el <a href="https://raw.githubusercontent.com/domingogallardo/practicas-mads/main/docs/01-intro-spring-boot/intro-spring-boot.md">texto Markdown</a>.</p>
<ul>
<li>La práctica tiene una duración de 3 semanas y la fecha límite de
  entrega es el martes 8 de noviembre.</li>
<li>La parte obligatoria puntúa sobre 8 y la opcional sobre 2 puntos.</li>
<li>La calificación de la práctica tiene un peso de un 25% en la nota
  final de prácticas. </li>
<li>Para realizar la entrega se debe subir a Moodle un ZIP que contenga
  todo el proyecto, incluyendo el directorio <code>.git</code> que contiene la
  historia Git. Para ello comprime tu directorio local del proyecto
  <strong>después de haber hecho un <code>./mvnw clean</code></strong> para eliminar el
  directorio <code>target</code> que contiene los binarios compilados. Debes
  dejar también en Moodle la URL del repositorio en GitHub.</li>
</ul>
<p>Para la evaluación se tendrá en cuenta:</p>
<ul>
<li>Desarrollo continuo (los <em>commits</em> deben realizarse a lo largo de
  las 3 semanas y no dejar todo para la última semana).</li>
<li>Correcto desarrollo de la metodología.</li>
<li>Diseño e implementación del código y de los tests de las
  características desarrolladas.</li>
<li>Documentación.</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Pie">
      
        <a href="../02-todolist/practica2.html" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Práctica 2
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta"}, "search": "../assets/javascripts/workers/search.d351de03.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.a1609d9a.min.js"></script>
      
    
  </body>
</html>